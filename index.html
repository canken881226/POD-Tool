<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç«¥è£…PODå®Œæ•´SOPç³»ç»Ÿ</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .tab-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .priority-urgent { border-left: 4px solid #ef4444; }
    .priority-high { border-left: 4px solid #f97316; }
    .priority-medium { border-left: 4px solid #3b82f6; }
    .priority-low { border-left: 4px solid #10b981; }
    .element-tag {
      display: inline-block;
      padding: 4px 12px;
      margin: 4px;
      border-radius: 16px;
      font-size: 14px;
      background: #f0f4ff;
      color: #4f46e5;
    }
    .color-swatch {
      display: inline-block;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin: 4px;
      border: 2px solid #e5e7eb;
    }
    .prompt-box {
      background: #1f2937;
      color: #f3f4f6;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .combo-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      transition: all 0.3s;
    }
    .combo-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    .emoji-large {
      font-size: 48px;
      margin: 0 auto;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // ========== æ•°æ®å¸¸é‡ ==========
    const SYSTEM_DATA = {
      "holidays": [
        {"key": "val", "name": "Valentine's Day", "emoji": "ğŸ’", "date": "2026-02-14", "tier": "medium", "devDays": 90, "tags": ["romantic", "sweet", "girls"], "elements": ["heart", "rose", "cupid arrow", "kiss lips", "love letter"], "colors": ["pink", "red", "white", "rose gold"]},
        {"key": "pat", "name": "St. Patrick's Day", "emoji": "ğŸ€", "date": "2026-03-17", "tier": "small", "devDays": 60, "tags": ["lucky", "irish", "green"], "elements": ["shamrock", "rainbow", "pot of gold", "lucky clover", "leprechaun hat"], "colors": ["green", "gold", "white"]},
        {"key": "eas", "name": "Easter", "emoji": "ğŸ°", "date": "2026-04-05", "tier": "large", "devDays": 120, "tags": ["spring", "cute", "girls", "neutral"], "elements": ["easter bunny", "easter egg", "spring chick", "tulip", "butterfly", "carrot"], "colors": ["pastel pink", "pastel blue", "lavender", "mint green", "lemon yellow"]},
        {"key": "mom", "name": "Mother's Day", "emoji": "ğŸ’", "date": "2026-05-10", "tier": "large", "devDays": 120, "tags": ["floral", "sweet", "girls"], "elements": ["wildflower", "butterfly", "mama bear", "heart", "botanical wreath"], "colors": ["blush pink", "sage green", "cream", "dusty rose"]},
        {"key": "dad", "name": "Father's Day", "emoji": "ğŸ‘”", "date": "2026-06-21", "tier": "medium", "devDays": 90, "tags": ["sports", "cool", "boys"], "elements": ["superhero", "fishing", "sports", "tools", "bear dad", "cool dad"], "colors": ["navy", "gray", "forest green", "brown"]},
        {"key": "jul", "name": "4th of July", "emoji": "ğŸ‡ºğŸ‡¸", "date": "2026-07-04", "tier": "medium", "devDays": 90, "tags": ["patriotic", "party", "neutral"], "elements": ["star", "firework", "eagle", "flag", "freedom"], "colors": ["red", "white", "blue", "gold"]},
        {"key": "bts", "name": "Back to School", "emoji": "ğŸ’", "date": "2026-08-20", "tier": "medium", "devDays": 90, "tags": ["academic", "fun", "neutral"], "elements": ["school bus", "pencil", "apple", "rainbow", "books", "backpack"], "colors": ["rainbow", "bright primary", "pastel"]},
        {"key": "hal", "name": "Halloween", "emoji": "ğŸƒ", "date": "2026-10-31", "tier": "large", "devDays": 120, "tags": ["spooky", "fun", "neutral"], "elements": ["pumpkin", "ghost", "witch", "black cat", "spider", "skeleton", "bat", "candy corn"], "colors": ["orange", "black", "purple", "lime green"]},
        {"key": "thx", "name": "Thanksgiving", "emoji": "ğŸ¦ƒ", "date": "2026-11-26", "tier": "medium", "devDays": 90, "tags": ["harvest", "cozy", "neutral"], "elements": ["turkey", "fall leaves", "pumpkin", "harvest", "grateful", "acorn"], "colors": ["rust orange", "warm brown", "gold", "cream", "burgundy"]},
        {"key": "xmas", "name": "Christmas", "emoji": "ğŸ„", "date": "2026-12-25", "tier": "large", "devDays": 120, "tags": ["holiday", "cozy", "neutral"], "elements": ["santa", "snowman", "reindeer", "christmas tree", "snowflake", "elf", "gift", "candy cane"], "colors": ["red", "green", "gold", "white", "silver"]}
      ],
      "seasons": [
        {"key": "spring", "name": "Spring Season", "emoji": "ğŸŒ¸", "months": [3, 4, 5], "devDays": 90, "tags": ["fresh", "floral", "girls"], "elements": ["cherry blossom", "butterfly", "rainbow", "garden", "fresh flower", "bunny"], "colors": ["pastel pink", "mint", "lilac", "sky blue", "butter yellow"]},
        {"key": "summer", "name": "Summer Season", "emoji": "â˜€ï¸", "months": [6, 7, 8], "devDays": 90, "tags": ["beach", "fun", "neutral"], "elements": ["sun", "ice cream", "ocean wave", "watermelon", "tropical flower", "starfish"], "colors": ["turquoise", "coral", "sunshine yellow", "hot pink", "white"]},
        {"key": "fall", "name": "Fall Season", "emoji": "ğŸ‚", "months": [9, 10, 11], "devDays": 90, "tags": ["cozy", "harvest", "neutral"], "elements": ["fall leaves", "mushroom", "acorn", "cozy sweater", "pumpkin latte", "harvest"], "colors": ["rust", "warm orange", "forest green", "cream", "burgundy"]},
        {"key": "winter", "name": "Winter Season", "emoji": "â„ï¸", "months": [12, 1, 2], "devDays": 90, "tags": ["cozy", "snow", "neutral"], "elements": ["snowflake", "pine tree", "hot cocoa", "cozy cabin", "polar bear", "mittens"], "colors": ["icy blue", "cream", "silver", "pine green", "plum"]}
      ],
      "evergreen": [
        {"id": "dinosaur", "name": "æé¾™", "en": "Dinosaur", "emoji": "ğŸ¦•", "weight": 9.2, "tags": ["boys", "cool", "evergreen"], "elements": ["t-rex", "dino skeleton", "baby dinosaur", "roaring dino"], "colors": ["forest green", "burnt orange", "teal", "neon green"], "audience": "boys", "season": "all"},
        {"id": "unicorn", "name": "ç‹¬è§’å…½", "en": "Unicorn", "emoji": "ğŸ¦„", "weight": 9.0, "tags": ["girls", "fantasy", "evergreen"], "elements": ["rainbow horn", "sparkle mane", "magic stars", "pastel cloud"], "colors": ["pastel rainbow", "holographic", "rose gold", "lavender"], "audience": "girls", "season": "all"},
        {"id": "space", "name": "å¤ªç©º", "en": "Space", "emoji": "ğŸš€", "weight": 8.8, "tags": ["boys", "cool", "evergreen"], "elements": ["astronaut", "planet", "rocket", "galaxy star", "alien"], "colors": ["deep navy", "neon purple", "electric blue", "star gold"], "audience": "boys", "season": "all"},
        {"id": "cat", "name": "çŒ«å’ª", "en": "Cat", "emoji": "ğŸ±", "weight": 8.5, "tags": ["girls", "cute", "evergreen"], "elements": ["cute cat face", "cat paw", "sleepy cat", "cat with bow"], "colors": ["gray", "cream", "pink", "black"], "audience": "girls", "season": "all"},
        {"id": "birthday", "name": "ç”Ÿæ—¥", "en": "Birthday", "emoji": "ğŸ‚", "weight": 8.6, "tags": ["neutral", "party", "evergreen"], "elements": ["birthday cake", "confetti", "balloon", "party hat", "candle"], "colors": ["rainbow", "pink gold", "bright primary", "pastel"], "audience": "neutral", "season": "all"}
      ],
      "trends_2025": [
        {"id": "coquette", "name": "Coquette/Ribboncore", "name_cn": "è´è¶ç»“ç”œå¦¹é£", "lifecycle": "short", "verified": "high", "elements": ["bow", "lace edge", "heart", "pearl", "rose"], "colors": ["pink white", "cream pink", "cherry pink", "burgundy accent"], "structure": "small dense scatter, thin line, border lace", "audience": "girls"},
        {"id": "quiet_luxury", "name": "Quiet Luxury Kids", "name_cn": "å„¿ç«¥æç®€é«˜çº§", "lifecycle": "long", "verified": "high", "elements": ["small logo", "thin stripe", "letter", "minimal animal outline"], "colors": ["cream white", "oat", "gray blue", "mocha", "black white"], "structure": "large white space, single element, low saturation", "audience": "neutral"},
        {"id": "cottagecore", "name": "Cottagecore Kids", "name_cn": "ç”°å›­ç«¥è¯", "lifecycle": "long", "verified": "high", "elements": ["small flower", "mushroom", "berry", "basket", "bunny"], "colors": ["cream white", "berry red", "sage green"], "structure": "ditsy floral / pastoral illustration", "audience": "girls"},
        {"id": "ocean_friends", "name": "Ocean Friends", "name_cn": "æµ·æ´‹ä¼™ä¼´", "lifecycle": "long", "verified": "high", "elements": ["whale", "turtle", "fish", "coral"], "colors": ["teal", "cream white", "coral pink"], "structure": "scatter / wave base", "audience": "neutral"},
        {"id": "construction", "name": "Construction Crew", "name_cn": "å·¥ç¨‹è½¦çƒ­æ½®", "lifecycle": "long", "verified": "high", "elements": ["excavator", "bulldozer", "traffic cone", "warning stripe"], "colors": ["yellow black", "gray"], "structure": "vehicle lineup / construction scene", "audience": "boys"}
      ],
      "categories": [
        {"id": "onesie", "name": "è¿ä½“è£¤ Onesie Pajamas", "emoji": "ğŸ‘¶", "bestFor": ["holiday", "seasonal", "cute_animals", "sleep_theme"], "avoid": ["sports", "academic", "edgy"], "structure": ["scattered_repeat", "all_over_print"]},
        {"id": "dress", "name": "è¿è¡£è£™ Girls Dress", "emoji": "ğŸ‘—", "bestFor": ["floral", "princess", "seasonal_spring_summer", "party"], "avoid": ["sports", "construction", "dark_theme"], "structure": ["scattered_floral", "border_hem", "center_graphic"]},
        {"id": "crewneck", "name": "åœ†é¢†å«è¡£ Crewneck", "emoji": "ğŸ‘•", "bestFor": ["academic", "sports", "evergreen", "seasonal_fall_winter"], "avoid": ["too_feminine", "baby_theme"], "structure": ["center_chest", "large_graphic", "varsity_style"]},
        {"id": "hoodie", "name": "è¿å¸½å«è¡£ Hoodie", "emoji": "ğŸ§¥", "bestFor": ["sports", "casual", "evergreen"], "avoid": ["formal"], "structure": ["center_chest", "sleeve_print"]},
        {"id": "leggings", "name": "ç‘œä¼½è£¤ Leggings", "emoji": "ğŸ‘–", "bestFor": ["sports", "casual", "all_over"], "avoid": ["formal"], "structure": ["all_over", "side_stripe"]}
      ],
      "weeklyResearch": {
        "monday": {"task": "è¶‹åŠ¿å¹³å°è°ƒç ”", "sites": ["Pinterest Trends", "WGSN", "TikTok"], "output": "5ä¸ªè¶‹åŠ¿å…³é”®è¯"},
        "tuesday": {"task": "æˆç†Ÿå¸‚åœºè°ƒç ”", "sites": ["Zara Kids", "H&M Kids", "Carter's"], "output": "3ä¸ªå‚è€ƒæ¬¾+ç»“æ„åˆ†æ"},
        "wednesday": {"task": "åå‘éªŒè¯", "sites": ["Etsy", "Amazon"], "output": "é”€é‡æ•°æ®+ç‰¹å¾"},
        "thursday": {"task": "è·¨ç•Œçµæ„Ÿ", "sites": ["Behance", "The Dieline"], "output": "3ä¸ªçµæ„Ÿå‚è€ƒ"},
        "friday": {"task": "æ›´æ–°å…ƒç´ åº“", "sites": ["Pantone", "Coolors"], "output": "æ–°å…ƒç´ 5ä¸ª+é…è‰²2å¥—"}
      }
    };

    // å…ƒç´ åº“
    const ELEMENT_LIBRARY = {
      male: ["dinosaur", "truck", "rocket", "robot", "superhero", "sports ball", "construction", "fire truck", "police car", "astronaut", "pirate ship", "dragon", "shark", "monster", "race car", "skateboard", "bicycle", "airplane", "train", "submarine"],
      female: ["unicorn", "rainbow", "butterfly", "flower", "heart", "star", "cat", "bunny", "princess", "fairy", "mermaid", "ballet", "cupcake", "cherry", "strawberry", "ice cream", "teddy bear", "bow", "pearl", "crown"],
      neutral: ["moon", "sun", "cloud", "tree", "mountain", "ocean wave", "snowflake", "leaf", "fruit", "vegetable", "balloon", "gift", "music note", "book", "pencil", "paintbrush", "camera", "globe"]
    };

    // MJé£æ ¼æ¨¡æ¿
    const MJ_STYLES = [
      "soft watercolor style",
      "flat vector gentle illustration",
      "kawaii cartoon style",
      "hand-drawn sketch style",
      "minimalist line art",
      "retro vintage print",
      "scandinavian folk art",
      "digital painting dreamy",
      "pastel chalk texture",
      "geometric pattern modern"
    ];

    // ========== å·¥å…·å‡½æ•° ==========
    const S = {
      g: (key) => {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch {
          return null;
        }
      },
      s: (key, value) => {
        localStorage.setItem(key, JSON.stringify(value));
      }
    };

    const daysUntil = (dateStr) => {
      const target = new Date(dateStr);
      const today = new Date();
      const diff = target - today;
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    };

    const calculatePriorities = () => {
      const today = new Date();
      const month = today.getMonth() + 1;
      const weekNum = Math.ceil(today.getDate() / 7); // å½“æœˆç¬¬å‡ å‘¨
      const priorities = [];

      // èŠ‚æ—¥ç´§æ€¥åº¦ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
      SYSTEM_DATA.holidays.forEach(h => {
        const days = daysUntil(h.date);
        const deadline = days - h.devDays;
        
        if (deadline <= 0 && days > 0) {
          priorities.push({
            urgency: 10,
            type: 'holiday_urgent',
            theme: h,
            reason: `${h.name}å·²è¿›å…¥å¼€å‘æœŸï¼è·ç¦»èŠ‚æ—¥${days}å¤©`
          });
        } else if (deadline > 0 && deadline <= 21) {
          priorities.push({
            urgency: 8,
            type: 'holiday_soon',
            theme: h,
            reason: `${deadline}å¤©åè¿›å…¥å¼€å‘æœŸ`
          });
        }
      });

      // å­£èŠ‚çª—å£ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰- åªæ˜¾ç¤ºå½“å‰å’Œæœªæ¥å­£èŠ‚
      SYSTEM_DATA.seasons.forEach(s => {
        const nextMonth = month + 1;
        const futureMonth = month + 2;
        
        // å½“å‰æœˆã€ä¸‹ä¸ªæœˆã€ä¸‹ä¸‹ä¸ªæœˆåŒ¹é…çš„å­£èŠ‚
        if (s.months.includes(month) || s.months.includes(nextMonth) || s.months.includes(futureMonth)) {
          // ä½†è·³è¿‡å·²ç»è¿‡å»å¤§åŠçš„å­£èŠ‚ï¼ˆæ¯”å¦‚å½“å‰æ˜¯2æœˆæœ«ï¼Œå°±ä¸æ¨å†¬å­£äº†ï¼‰
          const isEndOfMonth = today.getDate() > 20;
          const isSeasonEnding = isEndOfMonth && s.months[s.months.length - 1] === month;
          
          if (!isSeasonEnding) {
            priorities.push({
              urgency: 7,
              type: 'seasonal',
              theme: s,
              reason: s.months.includes(month) ? `å½“å‰å­£èŠ‚çª—å£æœŸ` : `å³å°†åˆ°æ¥çš„å­£èŠ‚`
            });
          }
        }
      });

      // å¸¸é’ä¸»é¢˜ï¼ˆè½®æ¢æœºåˆ¶ï¼šæ¯å‘¨æ¨è2ä¸ªï¼Œç¡®ä¿å¸¸é’ä¸»é¢˜è¢«å…³æ³¨ï¼‰
      const evergreen = S.g('evergreen') || SYSTEM_DATA.evergreen;
      const evergreenSorted = [...evergreen].sort((a, b) => b.weight - a.weight);
      
      // åŸºäºå‘¨æ•°è½®æ¢ï¼šç¬¬1å‘¨æ¨èå‰2ä¸ªï¼Œç¬¬2å‘¨æ¨èç¬¬3-4ä¸ªï¼Œä»¥æ­¤ç±»æ¨
      const startIdx = ((weekNum - 1) * 2) % evergreenSorted.length;
      const weeklyEvergreen = [
        evergreenSorted[startIdx],
        evergreenSorted[(startIdx + 1) % evergreenSorted.length]
      ];
      
      weeklyEvergreen.forEach((e, idx) => {
        priorities.push({
          urgency: 6.5 - (idx * 0.3), // ç¬¬ä¸€ä¸ª6.5ï¼Œç¬¬äºŒä¸ª6.2
          type: 'evergreen',
          theme: e,
          reason: `æœ¬å‘¨å¸¸é’æ¨è #${idx + 1}ï¼Œæƒé‡${e.weight}`
        });
      });

      return priorities.sort((a, b) => b.urgency - a.urgency);
    };

    const calculateCategoryFit = (theme, category) => {
      let score = 50;
      const tags = theme.tags || [];
      
      if (tags.some(t => category.bestFor.includes(t))) score += 30;
      if (tags.some(t => category.avoid.includes(t))) score -= 40;
      
      return {
        fit: score > 40,
        score,
        level: score > 70 ? 'high' : score > 40 ? 'medium' : 'low',
        structureRecommend: category.structure,
        notes: category.bestFor.join(', ')
      };
    };

    // ========== API Key ç®¡ç† ==========
    const getApiKey = () => localStorage.getItem('pod_api_key') || '';
    const setApiKeyStore = (key) => localStorage.setItem('pod_api_key', key);

    // ========== Claude APIè°ƒç”¨ ==========
    const callClaudeAPI = async (prompt, systemPrompt = "") => {
  // ---- Global throttling & queue to avoid 429 (rate limit: input tokens/min) ----
  window.__claudeQueue = window.__claudeQueue || Promise.resolve();
  window.__claudeUsage = window.__claudeUsage || { windowStart: Date.now(), usedTokens: 0 };

  const EST_TOKENS = (s) => Math.ceil((String(s || "").length) / 4); // rough but good enough
  const normalize = (s) => String(s || "").replace(/\s+/g, " ").trim();

  // Hard caps to avoid sending huge prompts accidentally
  const MAX_INPUT_TOKENS_PER_REQ = 6000;   // keep each request modest
  const MAX_INPUT_TOKENS_PER_MIN = 28000;  // leave margin under 30k

  const trimToTokens = (s, maxTokens) => {
    s = String(s || "");
    if (EST_TOKENS(s) <= maxTokens) return s;
    const maxChars = maxTokens * 4;
    // Keep head+tail so we preserve instructions + critical data
    const head = s.slice(0, Math.floor(maxChars * 0.7));
    const tail = s.slice(-Math.floor(maxChars * 0.3));
    return `${head}\n\n[...å†…å®¹è¿‡é•¿å·²æˆªæ–­ï¼ˆä¸ºé¿å…429ï¼‰ï¼Œä»…ä¿ç•™å‰åå…³é”®ç‰‡æ®µ...]\n\n${tail}`;
  };

  const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

  const doCall = async () => {
    const apiKey = localStorage.getItem("CLAUDE_API_KEY") || "";
    if (!apiKey) throw new Error("æœªé…ç½® CLAUDE_API_KEYï¼ˆè¯·åœ¨è®¾ç½®é‡Œå¡«å†™å¹¶ä¿å­˜ï¼‰");

    // Reduce unnecessary input tokens
    const sys = trimToTokens(normalize(systemPrompt), 1200);
    const user = trimToTokens(normalize(prompt), MAX_INPUT_TOKENS_PER_REQ);

    // Throttle by estimated input tokens/min window
    const now = Date.now();
    const usage = window.__claudeUsage;
    if (now - usage.windowStart >= 60_000) {
      usage.windowStart = now;
      usage.usedTokens = 0;
    }
    const reqTokens = EST_TOKENS(sys) + EST_TOKENS(user) + 50; // overhead margin
    if (usage.usedTokens + reqTokens > MAX_INPUT_TOKENS_PER_MIN) {
      const waitMs = 60_000 - (now - usage.windowStart) + 250;
      await sleep(Math.max(250, waitMs));
      usage.windowStart = Date.now();
      usage.usedTokens = 0;
    }
    usage.usedTokens += reqTokens;

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 80_000);

    try {
      let attempt = 0;
      let backoff = 1200;

      while (true) {
        attempt += 1;
        const resp = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250929",
            max_tokens: 1200,      // keep output small (input is the real limiter, but this helps overall load)
            temperature: 0.2,
            system: sys,
            messages: [{ role: "user", content: user }]
          }),
          signal: controller.signal
        });

        if (resp.ok) {
          const data = await resp.json();
          return data?.content?.[0]?.text ?? "";
        }

        // Handle 429/5xx with retry + backoff
        const isRetryable = resp.status === 429 || resp.status >= 500;
        let errText = "";
        try { errText = await resp.text(); } catch (e) {}

        if (isRetryable && attempt < 6) {
          const retryAfter = Number(resp.headers.get("retry-after") || "0");
          const wait = retryAfter > 0 ? retryAfter * 1000 : backoff;
          await sleep(wait);
          backoff = Math.min(backoff * 1.8, 12_000);
          continue;
        }

        throw new Error(`HTTP ${resp.status}: ${errText || resp.statusText}`);
      }
    } finally {
      clearTimeout(timeout);
    }
  };

  // Serialize calls to avoid bursts
  const task = window.__claudeQueue.then(doCall, doCall);
  // Keep chain alive even if one request fails
  window.__claudeQueue = task.catch(() => {});
  return task;
};;

    // ========== ä¸»åº”ç”¨ç»„ä»¶ ==========
    // ========== API Key è®¾ç½®ç»„ä»¶ ==========
    function ApiKeyBanner() {
      const [key, setKey] = React.useState(getApiKey());
      const [editing, setEditing] = React.useState(!getApiKey());
      const [saved, setSaved] = React.useState(false);

      const save = () => {
        if (!key.trim()) return alert('è¯·è¾“å…¥ API Key');
        setApiKeyStore(key.trim());
        setEditing(false);
        setSaved(true);
        setTimeout(() => setSaved(false), 2000);
      };

      if (!editing && getApiKey()) {
        return (
          <div style={{background:'#1e293b'}} className="text-white px-6 py-2 flex items-center justify-between text-sm">
            <span className="text-gray-400 text-xs">ğŸ”‘ API Key: <span className="text-green-400 font-medium">å·²è®¾ç½® âœ“</span></span>
            <button onClick={() => setEditing(true)} className="text-gray-400 hover:text-white text-xs underline ml-4">ä¿®æ”¹Key</button>
          </div>
        );
      }

      return (
        <div className="bg-yellow-50 border-b-2 border-yellow-400 px-6 py-3 flex items-center gap-3 flex-wrap">
          <span className="text-yellow-800 font-bold text-sm">ğŸ”‘ è¯·è¾“å…¥ Anthropic API Keyï¼š</span>
          <input
            type="password"
            value={key}
            onChange={e => setKey(e.target.value)}
            onKeyDown={e => e.key === 'Enter' && save()}
            placeholder="sk-ant-api03-xxxxxxxx..."
            className="flex-1 min-w-64 px-3 py-2 border-2 border-yellow-300 rounded-lg text-sm focus:outline-none focus:border-yellow-500"
          />
          <button onClick={save}
            className="px-5 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600 transition">
            {saved ? 'âœ“ å·²ä¿å­˜ï¼' : 'ä¿å­˜'}
          </button>
          <a href="https://console.anthropic.com/settings/keys" target="_blank"
            className="text-xs text-yellow-700 hover:text-yellow-900 underline">
            è¿˜æ²¡æœ‰Keyï¼Ÿç‚¹è¿™é‡Œè·å– â†’
          </a>
        </div>
      );
    }

    function App() {
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [priorities, setPriorities] = useState([]);
      const [confirmedTasks, setConfirmedTasks] = useState([]);

      useEffect(() => {
        setPriorities(calculatePriorities());
        setConfirmedTasks(S.g('confirmed_tasks') || []);
        
        // ç›‘å¬hashå˜åŒ–
        const handleHashChange = () => {
          if (window.location.hash === '#research') {
            setCurrentPage('research');
          }
        };
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      return (
        <div className="min-h-screen bg-gray-50">
          {/* API Key è®¾ç½®æ  */}
          <ApiKeyBanner />

          {/* é¡¶éƒ¨å¯¼èˆª */}
          <div className="gradient-bg text-white shadow-lg">
            <div className="container mx-auto px-4 py-6">
              <h1 className="text-3xl font-bold">ğŸ¨ ç«¥è£…PODå¼€å‘ç³»ç»Ÿ</h1>
              <p className="text-sm opacity-90 mt-2">è§„åˆ™é©±åŠ¨ Â· è‡ªåŠ¨åŒ–å†³ç­– Â· å®Œæ•´SOP</p>
            </div>
          </div>

          {/* é¡µé¢å¯¼èˆª */}
          <div className="bg-white shadow">
            <div className="container mx-auto px-4">
              <div className="flex space-x-2 py-4">
                {[
                  { id: 'dashboard', label: 'ğŸ“Š å¼€å‘çœ‹æ¿' },
                  { id: 'research', label: 'ğŸ” å¸‚åœºè°ƒç ”' },
                  { id: 'workflow', label: 'ğŸ¯ ç¡®è®¤å¼€å‘æ–¹å‘' },
                  { id: 'listing', label: 'ğŸ“ Listingç”Ÿæˆ' },
                  { id: 'feedback', label: 'ğŸ“ˆ é”€å”®åé¦ˆ' }
                ].map(page => (
                  <button
                    key={page.id}
                    onClick={() => setCurrentPage(page.id)}
                    className={`px-6 py-3 rounded-lg font-medium transition-all ${
                      currentPage === page.id ? 'tab-active' : 'bg-gray-100 hover:bg-gray-200'
                    }`}
                  >
                    {page.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* é¡µé¢å†…å®¹ */}
          <div className="container mx-auto px-4 py-8">
            {currentPage === 'dashboard' && <DashboardPage priorities={priorities} confirmedTasks={confirmedTasks} />}
            {currentPage === 'research' && <ResearchWizardPage onComplete={() => setCurrentPage('dashboard')} />}
            {currentPage === 'workflow' && <WorkflowPage priorities={priorities} onTaskConfirmed={(task) => {
              const newTasks = [...confirmedTasks, task];
              setConfirmedTasks(newTasks);
              S.s('confirmed_tasks', newTasks);
              
              // æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼šæœ¬å‘¨ä¸»é¢˜+1
              const today = new Date();
              const year = today.getFullYear();
              const d = new Date(today);
              d.setHours(0, 0, 0, 0);
              d.setDate(d.getDate() + 4 - (d.getDay() || 7));
              const yearStart = new Date(d.getFullYear(), 0, 1);
              const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
              const weekKey = `${year}-W${String(week).padStart(2, '0')}`;
              
              const allStats = S.g('dev_statistics') || {};
              const weekStats = allStats[weekKey] || { themes: 0, designs: 0, listings: 0 };
              weekStats.themes += 1;
              allStats[weekKey] = weekStats;
              S.s('dev_statistics', allStats);
            }} />}
            {currentPage === 'listing' && <ListingPage />}
            {currentPage === 'feedback' && <FeedbackPage />}
          </div>
        </div>
      );
    }

    // ========== Page 1: å¼€å‘çœ‹æ¿ ==========
    function DashboardPage({ priorities, confirmedTasks }) {
      const [tasks, setTasks] = useState([]);
      const [stats, setStats] = useState({ week: {}, month: {}, total: {} });
      const [researchData, setResearchData] = useState(null);
      const [weekDates, setWeekDates] = useState([]);

      // è·å–å½“å‰å‘¨å·ï¼ˆISOæ ‡å‡†ï¼šå‘¨ä¸€ä¸ºä¸€å‘¨å¼€å§‹ï¼‰
      const getWeekNumber = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      };

      const getWeekKey = (date) => {
        const year = date.getFullYear();
        const week = getWeekNumber(date);
        return `${year}-W${String(week).padStart(2, '0')}`;
      };

      const getMonthKey = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        return `${year}-M${String(month).padStart(2, '0')}`;
      };

      // è·å–æœ¬å‘¨ä¸€åˆ°å‘¨äº”çš„æ—¥æœŸ
      const getThisWeekDates = () => {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        
        const dates = [];
        for (let i = 0; i < 5; i++) {
          const date = new Date(monday);
          date.setDate(monday.getDate() + i);
          dates.push(date);
        }
        return dates;
      };

      // è‡ªåŠ¨æ¸…ç†ä¸Šå‘¨å·²å®Œæˆä»»åŠ¡ï¼ˆå‘¨ä¸€è‡ªåŠ¨æ‰§è¡Œï¼‰
      const autoCleanOldTasks = () => {
        const today = new Date();
        const isMonday = today.getDay() === 1;
        const lastCleanDate = S.g('last_clean_date');
        const todayStr = today.toDateString();
        
        if (isMonday && lastCleanDate !== todayStr) {
          const allTasks = S.g('confirmed_tasks') || [];
          const activeTasks = allTasks.filter(t => !t.done); // åªä¿ç•™æœªå®Œæˆçš„
          S.s('confirmed_tasks', activeTasks);
          S.s('last_clean_date', todayStr);
          setTasks(activeTasks);
        }
      };

      useEffect(() => {
        setWeekDates(getThisWeekDates());
        autoCleanOldTasks();
        
        const allTasks = S.g('confirmed_tasks') || [];
        setTasks(allTasks);
        setResearchData(S.g('latest_research_summary'));
        
        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const allStats = S.g('dev_statistics') || {};
        const today = new Date();
        const weekKey = getWeekKey(today);
        const monthKey = getMonthKey(today);

        const weekStats = allStats[weekKey] || { themes: 0, designs: 0, listings: 0 };
        const monthStats = Object.keys(allStats)
          .filter(k => k.startsWith(monthKey.slice(0, 7))) // 2026-M
          .reduce((acc, k) => ({
            themes: acc.themes + (allStats[k].themes || 0),
            designs: acc.designs + (allStats[k].designs || 0),
            listings: acc.listings + (allStats[k].listings || 0)
          }), { themes: 0, designs: 0, listings: 0 });
        
        const totalStats = Object.values(allStats).reduce((acc, s) => ({
          themes: acc.themes + (s.themes || 0),
          designs: acc.designs + (s.designs || 0),
          listings: acc.listings + (s.listings || 0)
        }), { themes: 0, designs: 0, listings: 0 });

        setStats({ week: weekStats, month: monthStats, total: totalStats });
      }, [confirmedTasks]);

      const toggleTaskDone = (idx) => {
        const newTasks = [...tasks];
        newTasks[idx].done = !newTasks[idx].done;
        setTasks(newTasks);
        S.s('confirmed_tasks', newTasks);
      };

      return (
        <div className="space-y-6">
          {/* ç»Ÿè®¡æ•°æ®å¡ç‰‡ */}
          <div className="card bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200">
            <h2 className="text-xl font-bold mb-4">ğŸ“Š å¼€å‘ç»Ÿè®¡æ•°æ®</h2>
            <div className="grid grid-cols-3 gap-4">
              <div className="bg-white rounded-xl p-4 text-center">
                <div className="text-sm text-gray-500 mb-2">æœ¬å‘¨</div>
                <div className="space-y-1">
                  <div className="text-2xl font-bold text-purple-600">{stats.week.themes || 0}</div>
                  <div className="text-xs text-gray-500">ä¸»é¢˜</div>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-3 text-xs">
                  <div><span className="text-blue-600 font-bold">{stats.week.designs || 0}</span> å›¾æ¡ˆ</div>
                  <div><span className="text-green-600 font-bold">{stats.week.listings || 0}</span> Listing</div>
                </div>
              </div>
              <div className="bg-white rounded-xl p-4 text-center">
                <div className="text-sm text-gray-500 mb-2">æœ¬æœˆ</div>
                <div className="space-y-1">
                  <div className="text-2xl font-bold text-blue-600">{stats.month.themes || 0}</div>
                  <div className="text-xs text-gray-500">ä¸»é¢˜</div>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-3 text-xs">
                  <div><span className="text-blue-600 font-bold">{stats.month.designs || 0}</span> å›¾æ¡ˆ</div>
                  <div><span className="text-green-600 font-bold">{stats.month.listings || 0}</span> Listing</div>
                </div>
              </div>
              <div className="bg-white rounded-xl p-4 text-center">
                <div className="text-sm text-gray-500 mb-2">ç´¯è®¡æ€»æ•°</div>
                <div className="space-y-1">
                  <div className="text-2xl font-bold text-green-600">{stats.total.themes || 0}</div>
                  <div className="text-xs text-gray-500">ä¸»é¢˜</div>
                </div>
                <div className="grid grid-cols-2 gap-2 mt-3 text-xs">
                  <div><span className="text-blue-600 font-bold">{stats.total.designs || 0}</span> å›¾æ¡ˆ</div>
                  <div><span className="text-green-600 font-bold">{stats.total.listings || 0}</span> Listing</div>
                </div>
              </div>
            </div>
          </div>

          {/* å·²ç¡®è®¤å¼€å‘ä»»åŠ¡ */}
          <div className="card border-2 border-purple-300">
            {tasks.length === 0 ? (
              <div>
                <h2 className="text-2xl font-bold mb-4">ğŸ“‹ å·²ç¡®è®¤å¼€å‘ä»»åŠ¡</h2>
                <div className="text-center py-12 bg-gray-50 rounded-xl">
                  <p className="text-lg text-gray-400">æš‚æ— å·²ç¡®è®¤ä»»åŠ¡</p>
                  <p className="text-sm text-gray-400 mt-2">å‰å¾€ã€Œç¡®è®¤å¼€å‘æ–¹å‘ã€é¡µé¢åˆ›å»ºä»»åŠ¡</p>
                  <button
                    onClick={() => window.location.hash = '#workflow'}
                    className="mt-4 btn-primary"
                  >
                    å‰å¾€ç¡®è®¤å¼€å‘æ–¹å‘ â†’
                  </button>
                </div>
              </div>
            ) : (
              <div>
                {/* ä»»åŠ¡æ ‡é¢˜å¸¦æ—¥æœŸèŒƒå›´ */}
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-2xl font-bold">ğŸ“‹ å·²ç¡®è®¤å¼€å‘ä»»åŠ¡</h2>
                  <div className="text-sm text-gray-600">
                    {(() => {
                      const dates = weekDates;
                      if (dates.length === 0) return '';
                      const start = dates[0];
                      const end = dates[dates.length - 1];
                      return `${start.getFullYear()}å¹´${String(start.getMonth() + 1).padStart(2, '0')}æœˆ${String(start.getDate()).padStart(2, '0')}æ—¥ - ${end.getFullYear()}å¹´${String(end.getMonth() + 1).padStart(2, '0')}æœˆ${String(end.getDate()).padStart(2, '0')}æ—¥ å¼€å‘ä»»åŠ¡`;
                    })()}
                  </div>
                </div>
                
                <div className="space-y-3">
                  {tasks.map((task, idx) => (
                    <div key={idx} className={`border-2 rounded-xl p-4 transition ${task.done ? 'bg-gray-50 border-gray-200 opacity-60' : 'bg-purple-50 border-purple-200'}`}>
                      <div className="flex items-start gap-4">
                        {/* æ‰“é’©æ¡† */}
                        <button
                          onClick={() => toggleTaskDone(idx)}
                          className={`flex-shrink-0 w-6 h-6 rounded border-2 flex items-center justify-center transition ${
                            task.done ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300 hover:border-purple-500'
                          }`}
                        >
                          {task.done && <span className="text-white text-sm">âœ“</span>}
                        </button>
                        
                        {/* ä»»åŠ¡å†…å®¹ */}
                        <div className="flex-1">
                          <h3 className={`text-lg font-semibold ${task.done ? 'line-through text-gray-400' : 'text-purple-700'}`}>
                            {task.theme?.emoji} {task.theme?.name || task.theme?.en}
                          </h3>
                          <div className="mt-2 space-y-1 text-sm text-gray-600">
                            <div><strong>å“ç±»ï¼š</strong>{task.categories?.map(c => c.name).join(', ')}</div>
                            <div><strong>ç»„åˆï¼š</strong>{task.combos?.length || 0}ä¸ªå…ƒç´ åŒ…</div>
                            <div><strong>MJå’’è¯­ï¼š</strong>å·²ç”Ÿæˆ {task.totalPrompts || 0} æ¡</div>
                          </div>
                        </div>
                        
                        {/* åˆ›å»ºæ—¶é—´ */}
                        <div className="text-sm text-gray-400">
                          {new Date(task.createdAt).toLocaleDateString()}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* å¼€å§‹æ–°è°ƒç ”æŒ‰é’® */}
          <div className="card bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold mb-2">ğŸ” å¸‚åœºè°ƒç ”</h2>
                <p className="text-gray-600">å¼€å§‹æ–°ä¸€è½®è°ƒç ”ï¼Œå‘ç°å¸‚åœºè¶‹åŠ¿å’Œå¼€å‘æœºä¼š</p>
              </div>
              <button
                onClick={() => window.location.hash = '#research'}
                className="btn-primary text-lg px-8 py-4"
              >
                ğŸš€ å¼€å§‹æ–°ä¸€è½®è°ƒç ”
              </button>
            </div>
          </div>

          {/* èŠ‚æ—¥ä¸»é¢˜å±•å¼€åˆ—è¡¨ */}
          {priorities.filter(p => p.type.includes('holiday')).length > 0 && (
            <div className="card border-2 border-red-200">
              <h2 className="text-xl font-bold mb-4 text-red-700">ğŸ”¥ èŠ‚æ—¥ä¸»é¢˜ï¼ˆç´§æ€¥æé†’ï¼‰</h2>
              <div className="space-y-3">
                {priorities.filter(p => p.type.includes('holiday')).map((p, idx) => (
                  <div key={idx} className="bg-red-50 rounded-lg p-4 border-l-4 border-red-500">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-3xl">{p.theme.emoji}</span>
                        <div>
                          <h3 className="font-bold text-lg">{p.theme.name}</h3>
                          <p className="text-sm text-gray-600">{p.reason}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-red-600">{p.urgency.toFixed(1)}</div>
                        <div className="text-xs text-gray-500">ç´§æ€¥åº¦</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* å­£èŠ‚ä¸»é¢˜å±•å¼€åˆ—è¡¨ */}
          {priorities.filter(p => p.type === 'seasonal').length > 0 && (
            <div className="card border-2 border-orange-200">
              <h2 className="text-xl font-bold mb-4 text-orange-700">ğŸŒ¸ å­£èŠ‚ä¸»é¢˜ï¼ˆå½“å‰çª—å£ï¼‰</h2>
              <div className="space-y-3">
                {priorities.filter(p => p.type === 'seasonal').map((p, idx) => (
                  <div key={idx} className="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <span className="text-3xl">{p.theme.emoji}</span>
                        <div>
                          <h3 className="font-bold text-lg">{p.theme.name}</h3>
                          <p className="text-sm text-gray-600">{p.reason}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-2xl font-bold text-orange-600">{p.urgency.toFixed(1)}</div>
                        <div className="text-xs text-gray-500">ç´§æ€¥åº¦</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* å¸¸å¹´å¯å–ä¸»é¢˜ï¼ˆåŸºç¡€è½®æ¢ + å¸‚åœºæ¨èï¼‰*/}
          <div className="card border-2 border-green-200">
            <h2 className="text-xl font-bold mb-4 text-green-700">ğŸ¦• å¸¸å¹´å¯å–ä¸»é¢˜æ¨è</h2>
            
            {/* åŸºç¡€è½®æ¢ */}
            <div className="mb-6">
              <h3 className="font-semibold mb-3 text-sm text-gray-700">ğŸ’¡ åŸºç¡€è½®æ¢æ¨èï¼ˆæœ¬å‘¨ï¼‰</h3>
              <div className="grid md:grid-cols-2 gap-3">
                {priorities.filter(p => p.type === 'evergreen').map((p, idx) => (
                  <div key={idx} className="bg-green-50 rounded-lg p-4">
                    <div className="flex items-center gap-3">
                      <span className="text-2xl">{p.theme.emoji}</span>
                      <div className="flex-1">
                        <h4 className="font-bold">{p.theme.name || p.theme.en}</h4>
                        <p className="text-xs text-gray-600">æƒé‡ {p.theme.weight} | {p.theme.audience}</p>
                      </div>
                      <div className="text-sm font-bold text-green-600">{p.urgency.toFixed(1)}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* å¸‚åœºè°ƒç ”æ¨è */}
            {researchData?.aiAnalysis && (
              <div>
                <h3 className="font-semibold mb-3 text-sm text-gray-700">ğŸ“Š å¸‚åœºçƒ­åº¦æ¨èï¼ˆåŸºäºæœ€æ–°è°ƒç ”ï¼‰</h3>
                <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                  <p className="text-xs text-gray-600 mb-3">
                    <strong>è°ƒç ”æ—¶é—´ï¼š</strong>{new Date(researchData.timestamp).toLocaleString()}
                  </p>
                  {(() => {
                    const trends = researchData.stepResults?.[1]?.trends || [];
                    const colors = researchData.stepResults?.[2]?.commonColors || [];
                    const evergreen = SYSTEM_DATA.evergreen;
                    
                    // åŒ¹é…é€»è¾‘
                    const matches = [];
                    trends.forEach(t => {
                      const keyword = t.keyword.toLowerCase();
                      evergreen.forEach(e => {
                        const tags = (e.tags || []).join(' ').toLowerCase();
                        const name = (e.name + e.en).toLowerCase();
                        if (tags.includes(keyword) || name.includes(keyword)) {
                          matches.push({ theme: e, reason: `è¶‹åŠ¿"${t.keyword}"åŒ¹é…`, score: t.hotLevel === 'é«˜' ? 3 : 2 });
                        }
                      });
                    });
                    
                    // å»é‡
                    const uniqueMatches = matches.reduce((acc, m) => {
                      if (!acc.find(a => a.theme.id === m.theme.id)) acc.push(m);
                      return acc;
                    }, []).slice(0, 2);

                    return uniqueMatches.length > 0 ? (
                      <div className="space-y-2">
                        {uniqueMatches.map((m, idx) => (
                          <div key={idx} className="bg-white rounded-lg p-3">
                            <div className="flex items-center gap-2">
                              <span className="text-xl">{m.theme.emoji}</span>
                              <div className="flex-1">
                                <h4 className="font-bold text-sm">{m.theme.name || m.theme.en}</h4>
                                <p className="text-xs text-gray-600">{m.reason}</p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-sm text-gray-500">æš‚æ— åŒ¹é…çš„å¸¸å¹´ä¸»é¢˜ï¼Œå»ºè®®å¼€å‘åŸºç¡€è½®æ¢æ¨è</p>
                    );
                  })()}
                </div>
              </div>
            )}

            {!researchData?.aiAnalysis && (
              <div className="bg-gray-50 rounded-xl p-4 text-center">
                <p className="text-sm text-gray-500">æš‚æ— å¸‚åœºè°ƒç ”æ•°æ®</p>
                <button
                  onClick={() => window.location.hash = '#research'}
                  className="mt-3 px-6 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition"
                >
                  å‰å¾€å¸‚åœºè°ƒç ” â†’
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }


    // ========== 7æ­¥å…¨è‡ªåŠ¨è°ƒç ”æ¨¡å— ==========

    // 3æ­¥æ ¸å¿ƒè°ƒç ”é…ç½®ï¼ˆç²¾ç®€ç‰ˆï¼Œé™ä½æˆæœ¬ï¼‰
    const RESEARCH_STEPS = [
      {
        id: 1, emoji: 'ğŸ”¥', title: 'è¶‹åŠ¿éªŒè¯ & 2026é…è‰²',
        desc: 'æŠ“å–Google Trends + Pinterest + TikTokå®æ—¶çƒ­åº¦ + Pantone/Coolors 2026é…è‰²è¶‹åŠ¿',
        sources: ['Google Trends', 'Pinterest', 'TikTok Creative Center', 'Pantone 2026', 'Coolors'],
        searchQueries: [
          'kids fashion trend 2025 2026',
          'pinterest toddler outfit popular',
          'tiktok kids fashion trending hashtags',
          'pantone 2026 color kids',
          'coolors trending palette 2026 kids'
        ]
      },
      {
        id: 2, emoji: 'ğŸ’°', title: 'é”€é‡éªŒè¯',
        desc: 'æŠ“å–Etsy Best Seller + Amazon BSRï¼ŒéªŒè¯çœŸå®å¸‚åœºéœ€æ±‚å’Œå…±æ€§å…ƒç´ ',
        sources: ['Etsy Best Seller', 'Amazon BSR Kids'],
        searchQueries: [
          'etsy kids onesie bestseller 2025',
          'amazon kids clothing top rated trending'
        ]
      },
      {
        id: 3, emoji: 'ğŸ¨', title: 'è·¨ç•Œçµæ„Ÿå‚è€ƒ',
        desc: 'ä»å„¿ç«¥æ–‡å…·/é£Ÿå“åŒ…è£…/ç»˜æœ¬æ’ç”»/å©´å„¿ç”¨å“/é¤å…·5ä¸ªå“ç±»å‘ç°å·®å¼‚åŒ–è§†è§‰æ‰‹æ³•',
        sources: ['å„¿ç«¥æ–‡å…·', 'é£Ÿå“åŒ…è£…', 'ç»˜æœ¬æ’ç”»', 'å©´å„¿ç”¨å“', 'å„¿ç«¥é¤å…·'],
        searchQueries: []
      }
    ];

    // è°ƒç”¨Claude API with web_search
    const callClaudeWithSearch = async (systemPrompt, userPrompt) => {
      const apiKey = getApiKey();
      if (!apiKey) throw new Error('è¯·å…ˆè®¾ç½® API Key');

      const runTurn = async (msgs) => {
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": apiKey,
            "anthropic-version": "2023-06-01",
            "anthropic-dangerous-direct-browser-access": "true"
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-5-20250929",
            max_tokens: 4000,
            system: systemPrompt,
            tools: [{ type: "web_search_20250305", name: "web_search" }],
            messages: msgs
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          console.error(`HTTP ${response.status}:`, errText);
          throw new Error(`HTTP ${response.status}: ${errText}`);
        }

        const data = await response.json();
        if (data.error) {
          console.error("APIé”™è¯¯:", JSON.stringify(data.error));
          throw new Error(data.error.message || JSON.stringify(data.error));
        }
        return data;
      };

      const messages = [{ role: "user", content: userPrompt }];
      let data = await runTurn(messages);
      let allText = [];

      // å¾ªç¯å¤„ç†tool_useï¼ˆweb_searchéœ€è¦å®¢æˆ·ç«¯ä¼ å›tool_resultï¼‰
      for (let round = 0; round < 8; round++) {
        // æ”¶é›†text
        for (const b of (data.content || [])) {
          if (b.type === "text" && b.text) allText.push(b.text);
        }

        // å¦‚æœæ²¡æœ‰tool_useæˆ–å·²ç»“æŸåˆ™é€€å‡º
        const toolUses = (data.content || []).filter(b => b.type === "tool_use");
        if (!toolUses.length || data.stop_reason === "end_turn") break;

        // æ„é€ tool_resultå›ä¼ ï¼ˆweb_searchç»“æœç”±APIæœåŠ¡å™¨å¡«å……ï¼Œå®¢æˆ·ç«¯ä¼ ç©ºç¡®è®¤å³å¯ï¼‰
        messages.push(
          { role: "assistant", content: data.content },
          { role: "user", content: toolUses.map(tu => ({
              type: "tool_result",
              tool_use_id: tu.id,
              content: tu.type === "tool_use" && tu.name === "web_search"
                ? [{ type: "text", text: "Please continue with your analysis." }]
                : "ok"
            }))
          }
        );

        data = await runTurn(messages);
      }

      // æœ€åä¸€è½®ä¹Ÿæ”¶é›†
      for (const b of (data.content || [])) {
        if (b.type === "text" && b.text) allText.push(b.text);
      }

      const result = allText.join("\n").trim();
      if (!result) throw new Error("è¿”å›å†…å®¹ä¸ºç©ºï¼Œè¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®");
      return result;
    };

    // æ¯æ­¥çš„åˆ†æPrompt
    const STEP_PROMPTS = {
      1: {
        system: "ä½ æ˜¯ç«¥è£…PODè¶‹åŠ¿å’Œé…è‰²åˆ†æå¸ˆã€‚è¯·è”ç½‘æœç´¢Google Trendsã€Pinterestã€TikTokçš„å®æ—¶çƒ­åº¦æ•°æ®ï¼Œä»¥åŠPantone/Coolorsçš„2026é…è‰²è¶‹åŠ¿ã€‚",
        user: (date) => `ä»Šå¤©æ˜¯${date}ã€‚è¯·æœç´¢ä»¥ä¸‹å†…å®¹ï¼š
1. Google Trendsï¼škids fashion trend 2025 2026
2. Pinterestï¼štoddler outfit popular trending
3. TikTokï¼škids fashion trending hashtags 2025
4. Pantone 2026 color kids fashionï¼ˆ2026å¹´åº¦è‰²å’Œå­£èŠ‚è‰²é¢„æµ‹ï¼‰
5. Coolors trending palette 2026 kids pastel

è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "trends": [
    {"keyword": "è‹±æ–‡å…³é”®è¯", "source": "Google/Pinterest/TikTok", "hotLevel": "é«˜/ä¸­/ä½", "lifecycle": "çŸ­æœŸ/é•¿æœŸ", "reason": "ä¸ºä»€ä¹ˆçƒ­"}
  ],
  "colors2026": {
    "pantone": "Pantone 2026å¹´åº¦è‰²ï¼ˆå¦‚å·²å…¬å¸ƒï¼‰æˆ–é¢„æµ‹æ–¹å‘",
    "palettes": [
      {"name": "é…è‰²æ–¹æ¡ˆå", "colors": ["color1 è‹±æ–‡", "color2", "color3"], "hex": ["#hex1", "#hex2", "#hex3"], "season": "Spring/Summer/Fall/Winter/All", "ageGroup": "Newborn/Toddler/Kids/All"}
    ]
  },
  "summary": "æ ¸å¿ƒå‘ç°2-3å¥ï¼ˆåŒ…å«è¶‹åŠ¿å’Œé…è‰²ï¼‰"
}`
      },
      2: {
        system: "ä½ æ˜¯ç”µå•†é”€é‡åˆ†æå¸ˆã€‚è¯·è”ç½‘æŠ“å–Etsyå’ŒAmazonçš„çœŸå®é”€é‡æ•°æ®ã€‚",
        user: (date) => `ä»Šå¤©æ˜¯${date}ã€‚è¯·æœç´¢ Etsy kids onesie bestseller å’Œ Amazon kids clothing top rated trendingï¼Œåˆ†æé«˜é”€é‡äº§å“çš„å…±æ€§ã€‚

è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "topProducts": [
    {"title": "äº§å“æ ‡é¢˜", "platform": "Etsy/Amazon", "elements": ["å…ƒç´ "], "colors": ["é¢œè‰²"]}
  ],
  "commonElements": ["Top10å…±æ€§å…ƒç´ 1", "å…ƒç´ 2", "å…ƒç´ 3"],
  "commonColors": ["Top10å…±æ€§é…è‰²1", "é…è‰²2"],
  "priceRange": "ä¸»æµä»·æ ¼å¸¦",
  "summary": "æ ¸å¿ƒå‘ç°2-3å¥"
}`
      },
      3: {
        system: "ä½ æ˜¯è·¨ç•Œè®¾è®¡çµæ„Ÿåˆ†æå¸ˆã€‚",
        user: (date) => `æ¨è5ä¸ªè·¨ç•Œå“ç±»çš„è§†è§‰æ‰‹æ³•å¯ç”¨äºç«¥è£…PODï¼šæ–‡å…·ã€é£Ÿå“åŒ…è£…ã€ç»˜æœ¬ã€å©´å„¿ç”¨å“ã€é¤å…·ã€‚

è¾“å‡ºJSONæ ¼å¼ï¼š
{
  "top3": ["æ–¹å‘1", "æ–¹å‘2", "æ–¹å‘3"],
  "summary": "æ ¸å¿ƒå‘ç°2å¥"
}`
      }
    };

    function ResearchWizardPage({ onComplete }) {
      const [status, setStatus] = useState('idle'); // idle | running | done
      const [stepResults, setStepResults] = useState({});
      const [stepStatus, setStepStatus] = useState({}); // pending|running|done|error
      const [aiSummary, setAiSummary] = useState('');
      const [summaryLoading, setSummaryLoading] = useState(false);

      useEffect(() => {
        const saved = S.g('latest_research_summary');
        if (saved?.stepResults) {
          setStepResults(saved.stepResults);
          setStepStatus(saved.stepStatus || {});
          setAiSummary(saved.aiAnalysis || '');
          setStatus('done');
        }
      }, []);

      const parseStepResult = (raw) => {
        try {
          const cleaned = raw.replace(/```json|```/g, '').trim();
          const start = cleaned.indexOf('{');
          const end = cleaned.lastIndexOf('}');
          if (start !== -1 && end !== -1) {
            return JSON.parse(cleaned.slice(start, end + 1));
          }
        } catch (e) {}
        return { raw, summary: raw.slice(0, 200) };
      };

      const runSingleStep = async (stepId) => {
        const step = RESEARCH_STEPS.find(s => s.id === stepId);
        if (!step) return;

        const newStatuses = { ...stepStatus, [stepId]: 'running' };
        setStepStatus(newStatuses);

        const today = new Date().toLocaleDateString('zh-CN');
        try {
          const prompt = STEP_PROMPTS[stepId];
          const useWebSearch = [1, 2].includes(stepId);
          const raw = useWebSearch 
            ? await callClaudeWithSearch(prompt.system, prompt.user(today))
            : await callClaudeAPI(prompt.user(today), prompt.system);
          const parsed = parseStepResult(raw);
          
          const newResults = { ...stepResults, [stepId]: parsed };
          const finalStatuses = { ...newStatuses, [stepId]: 'done' };
          
          setStepResults(newResults);
          setStepStatus(finalStatuses);
          
          // ç«‹å³ä¿å­˜åˆ°localStorageï¼ˆæŒä¹…åŒ–ï¼‰
          S.s('latest_research_summary', {
            timestamp: new Date().toISOString(),
            stepResults: newResults,
            stepStatus: finalStatuses,
            aiAnalysis: aiSummary || ''
          });
        } catch (e) {
          console.error(`æ­¥éª¤${stepId}å¤±è´¥:`, e);
          const errorResult = { error: `å¤±è´¥ï¼š${e.message || 'æœªçŸ¥é”™è¯¯'}`, summary: 'æœ¬æ­¥éª¤æ— æ³•è·å–æ•°æ®' };
          const newResults = { ...stepResults, [stepId]: errorResult };
          const finalStatuses = { ...newStatuses, [stepId]: 'error' };
          
          setStepResults(newResults);
          setStepStatus(finalStatuses);
          
          // ä¿å­˜å¤±è´¥çŠ¶æ€ä¹Ÿè¦æŒä¹…åŒ–
          S.s('latest_research_summary', {
            timestamp: new Date().toISOString(),
            stepResults: newResults,
            stepStatus: finalStatuses,
            aiAnalysis: aiSummary || ''
          });
        }
      };

      const runAllSteps = async () => {
        setStatus('running');
        setStepResults({});
        setStepStatus({});
        setAiSummary('');
        const today = new Date().toLocaleDateString('zh-CN');
        const allResults = {};
        const allStatuses = {};

        for (const step of RESEARCH_STEPS) {
          allStatuses[step.id] = 'running';
          setStepStatus({ ...allStatuses });

          try {
            const prompt = STEP_PROMPTS[step.id];
            // æ­¥éª¤1ã€2ç”¨web_searchï¼ˆå®æ—¶æ•°æ®ï¼‰ï¼Œæ­¥éª¤3ç”¨ClaudeçŸ¥è¯†åº“ï¼ˆè·¨ç•Œçµæ„Ÿï¼‰
            const useWebSearch = [1, 2].includes(step.id);
            const raw = useWebSearch 
              ? await callClaudeWithSearch(prompt.system, prompt.user(today))
              : await callClaudeAPI(prompt.user(today), prompt.system);
            const parsed = parseStepResult(raw);
            allResults[step.id] = parsed;
            allStatuses[step.id] = 'done';
          } catch (e) {
            console.error(`æ­¥éª¤${step.id}å¤±è´¥:`, e);
            allResults[step.id] = { error: `æŠ“å–å¤±è´¥ï¼š${e.message || 'æœªçŸ¥é”™è¯¯'}`, summary: 'æœ¬æ­¥éª¤æš‚æ—¶æ— æ³•è·å–æ•°æ®' };
            allStatuses[step.id] = 'error';
          }

          setStepResults({ ...allResults });
          setStepStatus({ ...allStatuses });
          
          // æ¯æ­¥å®Œæˆåç«‹å³ä¿å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
          S.s('latest_research_summary', {
            timestamp: new Date().toISOString(),
            stepResults: { ...allResults },
            stepStatus: { ...allStatuses },
            aiAnalysis: ''
          });

          // æ¯æ­¥ä¹‹é—´å»¶è¿Ÿ15ç§’ï¼Œç¡®ä¿ä¸è¶…è¿‡Tier 1çš„30k tokens/miné™åˆ¶
          if (step.id < RESEARCH_STEPS.length) {
            await new Promise(resolve => setTimeout(resolve, 15000));
          }
        }

        // ç”ŸæˆAIæ±‡æ€»
        setSummaryLoading(true);
        const summaryPrompt = `åŸºäº3æ­¥ç«¥è£…PODè°ƒç ”ï¼Œç”Ÿæˆå¼€å‘å»ºè®®ï¼š
æ­¥éª¤1ï¼š${allResults[1]?.summary || 'æ— '}
æ­¥éª¤2ï¼š${allResults[2]?.summary || 'æ— '}
æ­¥éª¤3ï¼š${allResults[3]?.summary || 'æ— '}
è¾“å‡ºï¼šæ€»è§ˆã€Top3è¶‹åŠ¿ã€2026é…è‰²ã€å®‰å…¨åº•ç›˜ã€å¼€å‘å»ºè®®ã€é£é™©`;

        try {
          const summary = await callClaudeAPI(summaryPrompt, "ä½ æ˜¯ç«¥è£…PODç­–ç•¥å¸ˆ");
          setAiSummary(summary);
          const saveData = {
            timestamp: new Date().toISOString(),
            stepResults: allResults,
            stepStatus: allStatuses,
            aiAnalysis: summary
          };
          S.s('latest_research_summary', saveData);
          S.s('ai_development_recommendation', summary);
        } catch (e) {
          setAiSummary('æ±‡æ€»ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        }

        setSummaryLoading(false);
        setStatus('done');
      };

      const resetResearch = () => {
        setStatus('idle');
        setStepResults({});
        setStepStatus({});
        setAiSummary('');
        S.s('latest_research_summary', null);
      };

      // æ¸²æŸ“æ¯æ­¥ç»“æœ
      const renderStepResult = (step) => {
        const st = stepStatus[step.id];
        const result = stepResults[step.id];

        return (
          <div key={step.id} className={`rounded-2xl border-2 transition-all overflow-hidden ${
            st === 'done' ? 'border-green-400' :
            st === 'running' ? 'border-purple-400 shadow-lg' :
            st === 'error' ? 'border-red-300' :
            'border-gray-200 opacity-40'
          }`}>
            {/* æ­¥éª¤å¤´éƒ¨ */}
            <div className={`flex items-center justify-between px-6 py-4 ${
              st === 'done' ? 'bg-green-50' :
              st === 'running' ? 'bg-purple-50' :
              st === 'error' ? 'bg-red-50' :
              'bg-gray-50'
            }`}>
              <div className="flex items-center space-x-3 flex-1">
                <div className={`w-9 h-9 rounded-full flex items-center justify-center font-bold ${
                  st === 'done' ? 'bg-green-500 text-white' :
                  st === 'running' ? 'bg-purple-500 text-white' :
                  st === 'error' ? 'bg-red-400 text-white' :
                  'bg-gray-200 text-gray-500'
                }`}>
                  {st === 'done' ? 'âœ“' : st === 'running' ? 'âŸ³' : st === 'error' ? '!' : step.id}
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-2">
                    <span className="text-lg">{step.emoji}</span>
                    <span className="font-bold">{step.title}</span>
                    {st === 'running' && <span className="text-xs text-purple-600 animate-pulse font-medium">æ­£åœ¨æŠ“å–...</span>}
                    {st === 'done' && <span className="text-xs text-green-600 font-medium">âœ… å®Œæˆ</span>}
                    {st === 'error' && <span className="text-xs text-red-500 font-medium">âš ï¸ æŠ“å–å¤±è´¥</span>}
                  </div>
                  <div className="text-xs text-gray-500 mt-0.5">{step.desc}</div>
                </div>
              </div>
              
              {/* ç‹¬ç«‹æ‰§è¡Œ/é‡è¯•æŒ‰é’® */}
              <div className="flex items-center gap-3">
                {/* æ•°æ®æ¥æºæ ‡ç­¾ */}
                <div className="flex flex-wrap gap-1 justify-end max-w-xs">
                  {step.sources.slice(0, 3).map((s, i) => (
                    <span key={i} className="px-2 py-0.5 bg-white border border-gray-200 rounded-full text-xs text-gray-500">{s}</span>
                  ))}
                  {step.sources.length > 3 && <span className="px-2 py-0.5 bg-white border border-gray-200 rounded-full text-xs text-gray-400">+{step.sources.length - 3}</span>}
                </div>
                
                {/* æ‰§è¡ŒæŒ‰é’® */}
                {status !== 'running' && st !== 'running' && (
                  <button
                    onClick={() => runSingleStep(step.id)}
                    className={`px-4 py-2 rounded-lg text-xs font-medium transition whitespace-nowrap ${
                      st === 'error' ? 'bg-red-500 hover:bg-red-600 text-white' :
                      st === 'done' ? 'bg-gray-200 hover:bg-gray-300 text-gray-700' :
                      'bg-purple-500 hover:bg-purple-600 text-white'
                    }`}
                  >
                    {st === 'error' ? 'ğŸ”„ é‡è¯•' : st === 'done' ? 'ğŸ”„ é‡æ–°æ‰§è¡Œ' : 'â–¶ï¸ å•ç‹¬æ‰§è¡Œ'}
                  </button>
                )}
                {st === 'running' && (
                  <div className="px-4 py-2 bg-purple-100 rounded-lg text-xs text-purple-600 font-medium">
                    âŸ³ æ‰§è¡Œä¸­...
                  </div>
                )}
              </div>
            </div>

            {/* æ­¥éª¤ç»“æœå†…å®¹ */}
            {result && (
              <div className="px-6 py-5 bg-white">
                {result.error ? (
                  <div className="text-red-500 text-sm">{result.error}</div>
                ) : (
                  <StepResultDisplay stepId={step.id} result={result} />
                )}
              </div>
            )}

            {/* è¿è¡Œä¸­åŠ¨ç”» */}
            {st === 'running' && !result && (
              <div className="px-6 py-8 bg-white text-center">
                <div className="loading-spinner mx-auto"></div>
                <p className="text-sm text-gray-500 mt-3">æ­£åœ¨è”ç½‘æŠ“å– {step.sources.join(' / ')} çš„å®æ—¶æ•°æ®...</p>
                <p className="text-xs text-gray-400 mt-2">æ¯æ­¥å®Œæˆåç­‰å¾…15ç§’å†æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œç¡®ä¿ä¸è¶…è¿‡Tier 1è´¦æˆ·é™åˆ¶ï¼ˆ30k tokens/minï¼‰</p>
              </div>
            )}

            {/* å¤±è´¥æ—¶æ˜¾ç¤ºå…·ä½“é”™è¯¯ */}
            {st === 'error' && result?.error && (
              <div className="px-6 py-4 bg-red-50 border-t border-red-200">
                <p className="text-sm text-red-600 font-medium">âŒ {result.error}</p>
                <p className="text-xs text-gray-400 mt-1">è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°(F12 â†’ Console)æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</p>
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="space-y-5">
          {/* é¡¶éƒ¨æ§åˆ¶åŒº */}
          <div className="card bg-gradient-to-r from-purple-600 to-pink-500 text-white">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold mb-1">ğŸ” å¸‚åœºè°ƒç ”ä¸­å¿ƒï¼ˆ3æ­¥æ ¸å¿ƒç‰ˆï¼‰</h2>
                <p className="opacity-90 text-sm">è¶‹åŠ¿&é…è‰² Â· é”€é‡éªŒè¯ Â· è·¨ç•Œçµæ„Ÿ Â· æˆæœ¬ä¼˜åŒ–</p>
                <div className="flex flex-wrap gap-2 mt-3">
                  {['ğŸ”¥ Google+Pinterest+TikTok+2026é…è‰²', 'ğŸ’° Etsy+Amazoné”€é‡', 'ğŸ¨ è·¨ç•Œ5å“ç±»'].map((s, i) => (
                    <span key={i} className="px-2 py-0.5 bg-white/20 rounded-full text-xs">{s}</span>
                  ))}
                </div>
                <p className="text-xs opacity-70 mt-2">é¢„ä¼°æˆæœ¬ï¼š$1.50/æ¬¡ | è€—æ—¶ï¼šçº¦45ç§’</p>
              </div>
              <div className="flex flex-col gap-3">
                {status === 'idle' && (
                  <button onClick={runAllSteps}
                    className="bg-white text-purple-600 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-50 transition shadow-lg">
                    ğŸš€ å¼€å§‹è°ƒç ”
                  </button>
                )}
                {status === 'running' && (
                  <div className="text-center">
                    <div className="text-3xl font-bold">
                      {Object.values(stepStatus).filter(s => s === 'done').length}
                      <span className="text-lg opacity-70">/7</span>
                    </div>
                    <div className="text-sm opacity-80">æ­¥éª¤å®Œæˆ</div>
                  </div>
                )}
                {status === 'done' && (
                  <button onClick={resetResearch}
                    className="bg-white/20 text-white px-6 py-3 rounded-xl font-medium hover:bg-white/30 transition">
                    ğŸ”„ é‡æ–°è°ƒç ”
                  </button>
                )}
              </div>
            </div>
            {/* æ•´ä½“è¿›åº¦æ¡ */}
            {status !== 'idle' && (
              <div className="mt-4 flex gap-1.5">
                {RESEARCH_STEPS.map(s => (
                  <div key={s.id} className={`flex-1 h-2 rounded-full transition-all duration-500 ${
                    stepStatus[s.id] === 'done' ? 'bg-white' :
                    stepStatus[s.id] === 'running' ? 'bg-white/60 animate-pulse' :
                    stepStatus[s.id] === 'error' ? 'bg-red-300' :
                    'bg-white/20'
                  }`} />
                ))}
              </div>
            )}
          </div>

          {/* ä½¿ç”¨è¯´æ˜ï¼ˆç²¾ç®€ç‰ˆï¼Œidleæ—¶æ˜¾ç¤ºï¼‰ */}
          {status === 'idle' && (
            <div className="card bg-blue-50 border-l-4 border-blue-400">
              <p className="text-sm text-blue-800 font-medium">ğŸ’¡ ä½¿ç”¨è¯´æ˜</p>
              <ul className="text-xs text-blue-700 mt-2 space-y-1">
                <li>â€¢ <strong>å…¨è‡ªåŠ¨æ‰§è¡Œ</strong>ï¼šç‚¹å³ä¸Šè§’ã€Œå¼€å§‹è°ƒç ”ã€ï¼Œ3æ­¥è‡ªåŠ¨æ‰§è¡Œï¼ˆ~60ç§’ï¼Œ$1.50ï¼‰</li>
                <li>â€¢ <strong>å•æ­¥æ‰§è¡Œ</strong>ï¼šç‚¹ä¸‹æ–¹æ­¥éª¤å¡ç‰‡å³ä¸Šè§’çš„ã€Œâ–¶ï¸ å•ç‹¬æ‰§è¡Œã€æŒ‰é’®ï¼ˆ$0.20-0.80ï¼‰</li>
                <li>â€¢ <strong>å¤±è´¥é‡è¯•</strong>ï¼šå¤±è´¥æ­¥éª¤ä¼šæ˜¾ç¤ºçº¢è‰²ã€ŒğŸ”„ é‡è¯•ã€æŒ‰é’®</li>
                <li>â€¢ <strong>æ•°æ®æŒä¹…åŒ–</strong>ï¼šç»“æœè‡ªåŠ¨ä¿å­˜ï¼Œåˆ‡æ¢çª—å£ä¸ä¸¢å¤±</li>
              </ul>
            </div>
          )}

          {/* 3ä¸ªæ­¥éª¤å¡ç‰‡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ */}
          <div className="space-y-3">
            {RESEARCH_STEPS.map(step => renderStepResult(step))}
          </div>

          {/* AIæ±‡æ€»åˆ†æï¼ˆå§‹ç»ˆæ˜¾ç¤ºæ¡†æ¶ï¼‰ */}
          <div className="card border-2 border-purple-300">
            <h2 className="text-xl font-bold mb-4 flex items-center justify-between">
              <span>ğŸ’¡ AIå¼€å‘è¶‹åŠ¿åˆ†ææŠ¥å‘Š</span>
              {aiSummary && !summaryLoading && (
                <button 
                  onClick={async () => {
                    setSummaryLoading(true);
                    try {
                      const summaryPrompt = `åŸºäº3æ­¥ç«¥è£…PODè°ƒç ”ï¼Œç”Ÿæˆå¼€å‘å»ºè®®ï¼š
æ­¥éª¤1ï¼š${stepResults[1]?.summary || 'æ— '}
æ­¥éª¤2ï¼š${stepResults[2]?.summary || 'æ— '}
æ­¥éª¤3ï¼š${stepResults[3]?.summary || 'æ— '}
è¾“å‡ºï¼šæ€»è§ˆã€Top3è¶‹åŠ¿ã€2026é…è‰²ã€å®‰å…¨åº•ç›˜ã€å¼€å‘å»ºè®®ã€é£é™©`;
                      const summary = await callClaudeAPI(summaryPrompt, "ä½ æ˜¯ç«¥è£…PODç­–ç•¥å¸ˆ");
                      setAiSummary(summary);
                      const saved = S.g('latest_research_summary') || {};
                      S.s('latest_research_summary', { ...saved, aiAnalysis: summary });
                    } catch (e) {
                      alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
                    } finally {
                      setSummaryLoading(false);
                    }
                  }}
                  className="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-xs font-medium transition"
                >
                  ğŸ”„ é‡æ–°ç”Ÿæˆ
                </button>
              )}
            </h2>
            {summaryLoading ? (
              <div className="text-center py-8">
                <div className="loading-spinner mx-auto"></div>
                <p className="text-sm text-gray-500 mt-3">AIæ­£åœ¨ç»¼åˆ3æ­¥æ•°æ®...</p>
              </div>
            ) : aiSummary ? (
              <div className="bg-gray-50 rounded-xl p-6">
                <div className="whitespace-pre-wrap text-sm leading-relaxed">{aiSummary}</div>
                <div className="mt-4 flex gap-3">
                  <button
                    onClick={() => {
                      const blob = new Blob([aiSummary], { type: 'text/plain;charset=utf-8' });
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = `PODè°ƒç ”æŠ¥å‘Š_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.txt`;
                      a.click();
                      URL.revokeObjectURL(url);
                    }}
                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <span>ğŸ“¥ ä¸‹è½½æŠ¥å‘Š(.txt)</span>
                  </button>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(aiSummary);
                      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    }}
                    className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <span>ğŸ“‹ å¤åˆ¶å†…å®¹</span>
                  </button>
                </div>
              </div>
            ) : (
              <div className="bg-gray-50 rounded-xl p-6 text-center">
                <p className="text-gray-400 text-sm">
                  {Object.keys(stepResults).length > 0 
                    ? 'è°ƒç ”æ•°æ®å·²å‡†å¤‡å¥½ï¼Œç‚¹å‡»ä¸‹æ–¹ã€Œç”ŸæˆAIæ±‡æ€»ã€æŒ‰é’®' 
                    : 'æ‰§è¡Œè°ƒç ”æ­¥éª¤åï¼ŒAIä¼šè‡ªåŠ¨ç”Ÿæˆå¼€å‘å»ºè®®'}
                </p>
                {Object.keys(stepResults).length > 0 && (
                  <button 
                    onClick={async () => {
                      setSummaryLoading(true);
                      try {
                        const summaryPrompt = `åŸºäº3æ­¥ç«¥è£…PODè°ƒç ”ï¼Œç”Ÿæˆå¼€å‘å»ºè®®ï¼š
æ­¥éª¤1ï¼š${stepResults[1]?.summary || 'æ— '}
æ­¥éª¤2ï¼š${stepResults[2]?.summary || 'æ— '}
æ­¥éª¤3ï¼š${stepResults[3]?.summary || 'æ— '}
è¾“å‡ºï¼šæ€»è§ˆã€Top3è¶‹åŠ¿ã€2026é…è‰²ã€å®‰å…¨åº•ç›˜ã€å¼€å‘å»ºè®®ã€é£é™©`;
                        const summary = await callClaudeAPI(summaryPrompt, "ä½ æ˜¯ç«¥è£…PODç­–ç•¥å¸ˆ");
                        setAiSummary(summary);
                        const saved = S.g('latest_research_summary') || {};
                        S.s('latest_research_summary', { ...saved, aiAnalysis: summary });
                      } catch (e) {
                        alert('ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
                      } finally {
                        setSummaryLoading(false);
                      }
                    }}
                    className="mt-4 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-medium transition"
                  >
                    ğŸ¤– ç”ŸæˆAIæ±‡æ€»
                  </button>
                )}
              </div>
            )}
          </div>

          {/* å®Œæˆæç¤º */}
          {status === 'done' && aiSummary && (
            <div className="card flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300">
              <div>
                <h3 className="font-bold text-green-800">âœ… è°ƒç ”å®Œæˆï¼ç»“æœå·²è‡ªåŠ¨ä¿å­˜</h3>
                <p className="text-sm text-gray-600 mt-1">
                  è°ƒç ”æ—¶é—´ï¼š{S.g('latest_research_summary')?.timestamp ? new Date(S.g('latest_research_summary').timestamp).toLocaleString() : ''}
                </p>
              </div>
              <button onClick={onComplete} className="btn-primary px-8 py-3">
                è¿”å›å¼€å‘çœ‹æ¿ â†’
              </button>
            </div>
          )}
        </div>
      );
    }

    // æ¯æ­¥ç»“æœçš„å¯è§†åŒ–å±•ç¤ºç»„ä»¶
    function StepResultDisplay({ stepId, result }) {
      if (!result) return null;

      // æ­¥éª¤1ï¼šè¶‹åŠ¿å…³é”®è¯
      if (stepId === 1 && result.trends) return (
        <div className="space-y-3">
          <div className="grid gap-2">
            {result.trends.map((t, i) => (
              <div key={i} className="flex items-center justify-between bg-purple-50 rounded-lg px-4 py-2">
                <div className="flex items-center gap-3">
                  <span className="font-bold text-purple-700">{t.keyword}</span>
                  <span className="text-xs text-gray-500">æ¥æºï¼š{t.source}</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${t.hotLevel === 'é«˜' ? 'bg-red-100 text-red-600' : t.hotLevel === 'ä¸­' ? 'bg-yellow-100 text-yellow-600' : 'bg-gray-100 text-gray-500'}`}>{t.hotLevel}çƒ­åº¦</span>
                  <span className="px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs">{t.lifecycle}</span>
                </div>
              </div>
            ))}
          </div>
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤2ï¼šå›¾æ¡ˆè®¾è®¡è¶‹åŠ¿
      if (stepId === 2 && result.topPatternStyles) return (
        <div className="space-y-3">
          <div>
            <div className="text-xs font-semibold text-gray-500 mb-2">ğŸ”¥ æœ€çƒ­è®¾è®¡é£æ ¼</div>
            <div className="flex flex-wrap gap-2">
              {result.topPatternStyles.map((s, i) => (
                <span key={i} className="px-3 py-1.5 bg-pink-100 text-pink-700 rounded-full text-sm font-medium">{s}</span>
              ))}
            </div>
          </div>
          {result.designTrends && (
            <div className="grid md:grid-cols-2 gap-2">
              {result.designTrends.slice(0, 4).map((t, i) => (
                <div key={i} className="bg-gray-50 rounded-lg p-3">
                  <div className="font-medium text-sm text-gray-700">{t.style}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    å…ƒç´ ï¼š{t.elements?.join(', ')} | é…è‰²ï¼š{t.colors?.join(', ')}
                  </div>
                  <div className="text-xs text-purple-600 mt-1">{t.platform}</div>
                </div>
              ))}
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤3ï¼šRedditçœŸå®éœ€æ±‚
      if (stepId === 3) return (
        <div className="space-y-3">
          {result.lovedElements && (
            <div className="grid md:grid-cols-2 gap-3">
              <div className="bg-green-50 rounded-lg p-3">
                <div className="text-xs font-bold text-green-700 mb-2">â¤ï¸ å¦ˆå¦ˆå–œæ¬¢</div>
                <div className="flex flex-wrap gap-1">{result.lovedElements.map((e,i) => <span key={i} className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">{e}</span>)}</div>
              </div>
              <div className="bg-red-50 rounded-lg p-3">
                <div className="text-xs font-bold text-red-700 mb-2">ğŸš« å¦ˆå¦ˆåæ„Ÿ</div>
                <div className="flex flex-wrap gap-1">{result.avoidElements?.map((e,i) => <span key={i} className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">{e}</span>)}</div>
              </div>
            </div>
          )}
          {result.realNeeds && (
            <div className="space-y-2">
              {result.realNeeds.slice(0, 3).map((n, i) => (
                <div key={i} className="bg-yellow-50 border-l-4 border-yellow-300 rounded-r-lg px-4 py-2">
                  <div className="text-xs font-bold text-yellow-700">{n.topic}</div>
                  <div className="text-xs text-gray-600 mt-1 italic">"{n.quote}"</div>
                  <div className="text-xs text-blue-600 mt-1">ğŸ’¡ {n.insight}</div>
                </div>
              ))}
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤4ï¼šæˆç†Ÿå“ç‰Œ
      if (stepId === 4 && result.marketBaseline) return (
        <div className="space-y-3">
          <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
            {[
              { label: 'å›¾æ¡ˆå¯†åº¦', value: result.marketBaseline.density },
              { label: 'æ’ç‰ˆç»“æ„', value: result.marketBaseline.structure },
              { label: 'é…è‰²å€¾å‘', value: result.marketBaseline.colorTone },
              { label: 'ä»·æ ¼å¸¦', value: result.marketBaseline.priceRange },
              { label: 'å®‰å…¨å…ƒç´ ', value: result.marketBaseline.coreElements?.join(', ') }
            ].map((item, i) => (
              <div key={i} className="bg-blue-50 rounded-lg p-3 text-center">
                <div className="text-xs text-gray-500">{item.label}</div>
                <div className="font-semibold text-sm text-blue-700 mt-1">{item.value || '-'}</div>
              </div>
            ))}
          </div>
          {result.references && (
            <div className="grid md:grid-cols-3 gap-2">
              {result.references.slice(0, 3).map((r, i) => (
                <div key={i} className="bg-gray-50 rounded-lg p-3">
                  <div className="text-xs font-bold text-purple-600">{r.brand}</div>
                  <div className="text-xs text-gray-700 mt-1">{r.productName}</div>
                  <div className="text-xs text-gray-500 mt-1">å…ƒç´ ï¼š{r.elements?.join(', ')}</div>
                  <div className="text-xs text-green-600 mt-1">{r.priceUSD}</div>
                </div>
              ))}
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤5ï¼šé”€é‡éªŒè¯
      if (stepId === 5) return (
        <div className="space-y-3">
          <div className="grid md:grid-cols-3 gap-3">
            <div className="bg-green-50 rounded-lg p-3">
              <div className="text-xs font-bold text-green-700 mb-2">ğŸ† å…±æ€§å…ƒç´ </div>
              <div className="flex flex-wrap gap-1">{result.commonElements?.map((e,i) => <span key={i} className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">{e}</span>)}</div>
            </div>
            <div className="bg-blue-50 rounded-lg p-3">
              <div className="text-xs font-bold text-blue-700 mb-2">ğŸ¨ å…±æ€§é…è‰²</div>
              <div className="flex flex-wrap gap-1">{result.commonColors?.map((c,i) => <span key={i} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{c}</span>)}</div>
            </div>
            <div className="bg-purple-50 rounded-lg p-3">
              <div className="text-xs font-bold text-purple-700 mb-2">ğŸ“Š å¸‚åœºæ•°æ®</div>
              <div className="text-xs text-gray-600">ä»·æ ¼å¸¦ï¼š{result.priceRange}</div>
              <div className="text-xs text-gray-600 mt-1">å¸‚åœºå®¹é‡ï¼š{result.marketSize}</div>
            </div>
          </div>
          {result.topProducts && (
            <div className="space-y-2">
              {result.topProducts.slice(0, 3).map((p, i) => (
                <div key={i} className="flex items-center justify-between bg-gray-50 rounded-lg px-4 py-2">
                  <div className="flex-1">
                    <span className="text-xs font-medium text-purple-600">{p.platform}</span>
                    <span className="text-xs text-gray-700 ml-2">{p.title}</span>
                  </div>
                  <div className="flex items-center gap-2 ml-3">
                    <span className="text-xs text-green-600 font-medium">{p.salesEstimate}</span>
                    <span className="text-xs text-yellow-600">â­{p.rating}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤6ï¼šè·¨ç•Œçµæ„Ÿ
      if (stepId === 6) return (
        <div className="space-y-3">
          {result.top3 && (
            <div className="bg-pink-50 rounded-xl p-4">
              <div className="text-xs font-bold text-pink-700 mb-2">â­ æœ€æœ‰ä»·å€¼çš„3ä¸ªæ–¹å‘</div>
              <div className="space-y-1">
                {result.top3.map((t, i) => <div key={i} className="text-sm text-gray-700">â€¢ {t}</div>)}
              </div>
            </div>
          )}
          {result.inspirations && (
            <div className="grid md:grid-cols-2 gap-2">
              {result.inspirations.slice(0, 6).map((ins, i) => (
                <div key={i} className={`bg-gray-50 rounded-lg p-3 border-l-4 ${ins.mjFeasible ? 'border-green-400' : 'border-gray-300'}`}>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-xs font-bold text-gray-700">{ins.category}</span>
                    {ins.mjFeasible && <span className="text-xs text-green-600">âœ… MJå¯ç”¨</span>}
                  </div>
                  <div className="text-xs text-blue-600">{ins.visualStyle}</div>
                  <div className="text-xs text-gray-500 mt-1">â†’ {ins.applyToKids}</div>
                  <div className="text-xs text-purple-500 mt-1">é€‚åˆï¼š{ins.ageGroup}</div>
                </div>
              ))}
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // æ­¥éª¤7ï¼šé…è‰²å…ƒç´ 
      if (stepId === 7) return (
        <div className="space-y-3">
          {result.newPalettes && (
            <div>
              <div className="text-xs font-bold text-gray-600 mb-2">ğŸ¨ æ–°é…è‰²æ–¹æ¡ˆ</div>
              <div className="grid md:grid-cols-2 gap-3">
                {result.newPalettes.map((p, i) => (
                  <div key={i} className="bg-gray-50 rounded-xl p-3">
                    <div className="font-medium text-sm mb-2">{p.name}</div>
                    <div className="flex gap-2 mb-2">
                      {p.colors.map((c, j) => (
                        <div key={j} className="flex items-center gap-1">
                          <div className="w-6 h-6 rounded-full border border-gray-200" style={{ background: c }}></div>
                          <span className="text-xs text-gray-500">{c}</span>
                        </div>
                      ))}
                    </div>
                    <div className="text-xs text-purple-600">{p.suitableTheme} Â· {p.ageGroup}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          {result.newElements && (
            <div>
              <div className="text-xs font-bold text-gray-600 mb-2">âœ¨ æ–°å¢å…ƒç´ </div>
              <div className="flex flex-wrap gap-2">
                {result.newElements.map((el, i) => (
                  <div key={i} className={`px-3 py-1.5 rounded-full text-xs font-medium ${
                    el.type === 'å¸¸è§„å…ƒç´ ' ? 'bg-blue-100 text-blue-700' :
                    el.type === 'æµè¡Œå…ƒç´ ' ? 'bg-purple-100 text-purple-700' :
                    'bg-gray-100 text-gray-600'
                  }`}>
                    {el.element} <span className="opacity-60">Â· {el.type} Â· {el.ageGroup}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
          {result.summary && <p className="text-sm text-gray-600 bg-gray-50 rounded-lg px-4 py-2">ğŸ“Œ {result.summary}</p>}
        </div>
      );

      // é€šç”¨å›é€€å±•ç¤º
      return (
        <div className="bg-gray-50 rounded-lg p-4 text-sm text-gray-600 whitespace-pre-wrap">
          {result.summary || JSON.stringify(result, null, 2).slice(0, 500)}
        </div>
      );
    }


    // ========== Page 2: ç¡®è®¤å¼€å‘æ–¹å‘ ==========
    function WorkflowPage({ priorities, onTaskConfirmed }) {
      const [currentTab, setCurrentTab] = useState(0);
      const [workflowData, setWorkflowData] = useState(() => {
        // åˆå§‹åŒ–æ—¶ä»localStorageåŠ è½½
        const saved = S.g('workflow_data_temp');
        return saved || {
          ageGroup: '',
          gender: 'unisex',
          scenes: [],
          buyerPerspective: '',
          selectedTheme: null,
          selectedCategories: [],
          marketBaseline: '',
          elementCombos: [],
          mjPrompts: {}
        };
      });

      // è‡ªåŠ¨è¯»å–æœ€æ–°è°ƒç ”ç»“æœ
      const researchSummary = S.g('latest_research_summary');

      const tabs = [
        'ğŸ‘¶ äººç¾¤&åœºæ™¯',
        'ğŸ¨ é€‰æ‹©ä¸»é¢˜',
        'ğŸ“¦ é€‰æ‹©å“ç±»',
        'ğŸ” å¸‚åœºéªŒè¯',
        'ğŸ¯ AIå…ƒç´ åŒ…',
        'âœ¨ MJå’’è¯­',
        'âœ… ç¡®è®¤ä»»åŠ¡'
      ];

      const updateData = (key, value) => {
        setWorkflowData(prev => {
          const newData = { ...prev, [key]: value };
          // æ¯æ¬¡æ›´æ–°éƒ½ä¿å­˜åˆ°localStorage
          S.s('workflow_data_temp', newData);
          return newData;
        });
      };

      // æ¸…é™¤ä¸´æ—¶æ•°æ®æŒ‰é’®
      const clearTempData = () => {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ä¸´æ—¶æ•°æ®å—ï¼Ÿè¿™å°†é‡ç½®æ•´ä¸ªæµç¨‹ã€‚')) {
          localStorage.removeItem('workflow_data_temp');
          setWorkflowData({
            ageGroup: '',
            gender: 'unisex',
            scenes: [],
            buyerPerspective: '',
            selectedTheme: null,
            selectedCategories: [],
            marketBaseline: '',
            elementCombos: [],
            mjPrompts: {}
          });
          setCurrentTab(0);
        }
      };

      return (
        <div className="space-y-6">
          {/* æ•°æ®æŒä¹…åŒ–æç¤º */}
          {S.g('workflow_data_temp') && (
            <div className="card bg-blue-50 border-2 border-blue-200">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">ğŸ’¾</span>
                  <div>
                    <h3 className="font-semibold text-blue-800">æ•°æ®å·²è‡ªåŠ¨ä¿å­˜</h3>
                    <p className="text-sm text-gray-600 mt-1">
                      åˆ‡æ¢Tabæˆ–åˆ·æ–°é¡µé¢åï¼Œæ‚¨çš„è®¾ç½®ä¼šä¿ç•™
                    </p>
                  </div>
                </div>
                <button
                  onClick={clearTempData}
                  className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm"
                >
                  ğŸ—‘ï¸ æ¸…é™¤æ•°æ®é‡æ–°å¼€å§‹
                </button>
              </div>
            </div>
          )}

          {/* è°ƒç ”ç»“æœæç¤º */}
          {researchSummary && (
            <div className="card bg-green-50 border-2 border-green-200">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="font-semibold text-green-800">âœ… å·²åŠ è½½æœ€æ–°è°ƒç ”æ•°æ®</h3>
                  <p className="text-sm text-gray-600 mt-1">
                    è°ƒç ”æ—¶é—´ï¼š{new Date(researchSummary.timestamp).toLocaleString()}
                  </p>
                </div>
                <button
                  onClick={() => window.location.hash = '#research'}
                  className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                >
                  æŸ¥çœ‹è°ƒç ”è¯¦æƒ…
                </button>
              </div>
            </div>
          )}

          {!researchSummary && (
            <div className="card bg-yellow-50 border-2 border-yellow-300">
              <div className="text-center py-8">
                <p className="text-lg font-semibold text-yellow-800 mb-3">
                  âš ï¸ å°šæœªå®Œæˆå¸‚åœºè°ƒç ”
                </p>
                <p className="text-gray-600 mb-4">
                  å»ºè®®å…ˆå®Œæˆå¸‚åœºè°ƒç ”ï¼Œè·å¾—AIå¼€å‘å»ºè®®åå†ç¡®è®¤å¼€å‘æ–¹å‘
                </p>
                <button
                  onClick={() => window.location.hash = '#research'}
                  className="btn-primary"
                >
                  ğŸ” å¼€å§‹å¸‚åœºè°ƒç ”
                </button>
              </div>
            </div>
          )}

          {/* Tabå¯¼èˆª */}
          <div className="card">
            <div className="flex flex-wrap gap-2">
              {tabs.map((tab, idx) => (
                <button
                  key={idx}
                  onClick={() => setCurrentTab(idx)}
                  className={`px-4 py-2 rounded-lg font-medium transition-all ${
                    currentTab === idx ? 'tab-active' : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {tab}
                </button>
              ))}
            </div>
          </div>

          {/* Tabå†…å®¹ */}
          <div className="card">
            {currentTab === 0 && <Tab1AudienceScene data={workflowData} updateData={updateData} onNext={() => setCurrentTab(1)} />}
            {currentTab === 1 && <Tab2SelectTheme priorities={priorities} data={workflowData} updateData={updateData} onNext={() => setCurrentTab(2)} />}
            {currentTab === 2 && <Tab3SelectCategory data={workflowData} updateData={updateData} onNext={() => setCurrentTab(3)} />}
            {currentTab === 3 && <Tab4MarketValidation data={workflowData} researchData={researchSummary} updateData={updateData} onNext={() => setCurrentTab(4)} />}
            {currentTab === 4 && <Tab5AIElementCombo data={workflowData} researchData={researchSummary} updateData={updateData} onNext={() => setCurrentTab(5)} />}
            {currentTab === 5 && <Tab6MJPrompts data={workflowData} updateData={updateData} onNext={() => setCurrentTab(6)} />}
            {currentTab === 6 && <Tab7ConfirmTask data={workflowData} onConfirm={onTaskConfirmed} />}
          </div>
        </div>
      );
    }

    // Tab 1: äººç¾¤&åœºæ™¯
    function Tab1AudienceScene({ data, updateData, onNext }) {
      const [ageGroup, setAgeGroup] = useState(data.ageGroup || '');
      const [gender, setGender] = useState(data.gender || 'unisex');
      const [scenes, setScenes] = useState(data.scenes || []);
      const [perspective, setPerspective] = useState(data.buyerPerspective || '');

      const handleNext = () => {
        if (!ageGroup || scenes.length === 0 || !perspective) {
          alert('è¯·å®Œæˆæ‰€æœ‰é€‰æ‹©');
          return;
        }
        updateData('ageGroup', ageGroup);
        updateData('gender', gender);
        updateData('scenes', scenes);
        updateData('buyerPerspective', perspective);
        onNext();
      };

      const toggleScene = (scene) => {
        setScenes(prev => 
          prev.includes(scene) ? prev.filter(s => s !== scene) : [...prev, scene]
        );
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">ğŸ‘¶ Step 0 - ç¡®å®šäººç¾¤&åœºæ™¯</h2>

          <div>
            <h3 className="font-semibold mb-3">å¹´é¾„æ®µï¼ˆå•é€‰ï¼‰</h3>
            <div className="grid grid-cols-2 gap-3">
              {[
                { value: 'newborn', label: 'ğŸ‘¶ Newborn (0-2å²)' },
                { value: 'toddler', label: 'ğŸ§’ Toddler (2-5å²)' },
                { value: 'littleKid', label: 'ğŸ‘¦ğŸ‘§ Little Kid (6-10å²)' },
                { value: 'bigKid', label: 'ğŸ§‘ Big Kid (11-14å²)' }
              ].map(option => (
                <label key={option.value} className="flex items-center space-x-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                  <input
                    type="radio"
                    name="ageGroup"
                    value={option.value}
                    checked={ageGroup === option.value}
                    onChange={(e) => setAgeGroup(e.target.value)}
                    className="w-5 h-5"
                  />
                  <span className="font-medium">{option.label}</span>
                </label>
              ))}
            </div>
          </div>

          <div>
            <h3 className="font-semibold mb-3">æ€§åˆ«å€¾å‘ï¼ˆå•é€‰ï¼‰</h3>
            <div className="grid grid-cols-3 gap-3">
              {[
                { value: 'unisex', label: 'ğŸ’› ç”·å¥³é€šç”¨' },
                { value: 'boy', label: 'ğŸ’™ ç”·ç«¥ä¸ºä¸»' },
                { value: 'girl', label: 'ğŸ’— å¥³ç«¥ä¸ºä¸»' }
              ].map(option => (
                <label key={option.value} className="flex items-center justify-center space-x-2 p-3 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                  <input
                    type="radio"
                    name="gender"
                    value={option.value}
                    checked={gender === option.value}
                    onChange={(e) => setGender(e.target.value)}
                    className="w-5 h-5"
                  />
                  <span className="font-medium text-sm">{option.label}</span>
                </label>
              ))}
            </div>
          </div>

          <div>
            <h3 className="font-semibold mb-3">ä½¿ç”¨åœºæ™¯ï¼ˆå¯å¤šé€‰ï¼‰</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {['æ—¥å¸¸ç©¿', 'å¹¼å„¿å›­', 'ç”Ÿæ—¥ä¸»é¢˜', 'èŠ‚æ—¥', 'ç¡è¡£', 'å¤–å‡º', 'æ‹ç…§', 'è¿åŠ¨'].map(scene => (
                <label key={scene} className="flex items-center space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input
                    type="checkbox"
                    checked={scenes.includes(scene)}
                    onChange={() => toggleScene(scene)}
                    className="w-5 h-5"
                  />
                  <span>{scene}</span>
                </label>
              ))}
            </div>
          </div>

          <div>
            <h3 className="font-semibold mb-3">è´­ä¹°è€…è§†è§’ï¼ˆå•é€‰ï¼‰</h3>
            <div className="space-y-2">
              {[
                { value: 'mom', label: 'å¦ˆå¦ˆå®¡ç¾ä¼˜å…ˆï¼ˆæŸ”å’Œã€å®‰å…¨ã€è€çœ‹ï¼‰' },
                { value: 'kid', label: 'å°å­©å®¡ç¾ä¼˜å…ˆï¼ˆé²œè‰³ã€æœ‰è¶£ã€é…·ï¼‰' }
              ].map(option => (
                <label key={option.value} className="flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                  <input
                    type="radio"
                    name="perspective"
                    value={option.value}
                    checked={perspective === option.value}
                    onChange={(e) => setPerspective(e.target.value)}
                    className="w-5 h-5"
                  />
                  <span>{option.label}</span>
                </label>
              ))}
            </div>
          </div>

          <div className="bg-blue-50 p-4 rounded-lg">
            <h4 className="font-semibold mb-2">ğŸ“š å‚è€ƒç½‘ç«™</h4>
            <div className="flex flex-wrap gap-3">
              <a href="https://www.carters.com" target="_blank" className="text-blue-600 hover:underline">ğŸ”— Carter's</a>
              <a href="https://www.target.com/c/kids-clothing" target="_blank" className="text-blue-600 hover:underline">ğŸ”— Target Kids</a>
              <a href="https://www.zara.com/kids" target="_blank" className="text-blue-600 hover:underline">ğŸ”— Zara Kids</a>
            </div>
          </div>

          <button onClick={handleNext} className="btn-primary w-full">
            ç¡®è®¤å¹¶ç»§ç»­ â†’
          </button>
        </div>
      );
    }

    // Tab 2: é€‰æ‹©ä¸»é¢˜
    function Tab2SelectTheme({ priorities, data, updateData, onNext }) {
      const [selected, setSelected] = useState(data.selectedTheme);

      const handleSelect = (theme) => {
        setSelected(theme);
        updateData('selectedTheme', theme);
        setTimeout(onNext, 300);
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">ğŸ¨ Step 1 - é€‰æ‹©ä¸»é¢˜</h2>
          <p className="text-gray-600">ç³»ç»Ÿæ ¹æ®æ—¶é—´è‡ªåŠ¨è®¡ç®—ä¼˜å…ˆçº§ï¼Œå»ºè®®ä»ç´§æ€¥åº¦é«˜çš„å¼€å§‹</p>

          <div className="space-y-4">
            {priorities.map((p, idx) => (
              <div
                key={idx}
                onClick={() => handleSelect(p.theme)}
                className={`p-6 rounded-lg border-2 cursor-pointer transition-all hover:shadow-lg ${
                  selected === p.theme ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'
                } ${
                  p.urgency >= 9 ? 'bg-red-50' :
                  p.urgency >= 7 ? 'bg-orange-50' :
                  p.urgency >= 5 ? 'bg-blue-50' : 'bg-white'
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <div className="text-5xl">{p.theme.emoji}</div>
                    <div>
                      <h3 className="text-xl font-bold">{p.theme.name || p.theme.en}</h3>
                      <p className="text-sm text-gray-600 mt-1">{p.reason}</p>
                      <div className="mt-3 flex flex-wrap gap-2">
                        {p.theme.elements && p.theme.elements.slice(0, 6).map((el, i) => (
                          <span key={i} className="element-tag text-xs">{el}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className={`text-3xl font-bold ${
                      p.urgency >= 9 ? 'text-red-600' :
                      p.urgency >= 7 ? 'text-orange-600' :
                      p.urgency >= 5 ? 'text-blue-600' : 'text-green-600'
                    }`}>
                      {p.urgency.toFixed(1)}
                    </div>
                    <div className="text-xs text-gray-500">ç´§æ€¥åº¦</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Tab 3: é€‰æ‹©å“ç±»
    function Tab3SelectCategory({ data, updateData, onNext }) {
      const [selected, setSelected] = useState(data.selectedCategories || []);
      const theme = data.selectedTheme;

      const toggleCategory = (category) => {
        setSelected(prev => {
          const exists = prev.find(c => c.id === category.id);
          if (exists) {
            return prev.filter(c => c.id !== category.id);
          } else {
            return [...prev, category];
          }
        });
      };

      const handleNext = () => {
        if (selected.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªå“ç±»');
          return;
        }
        updateData('selectedCategories', selected);
        onNext();
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">ğŸ“¦ Step 0å»¶ä¼¸ - é€‰æ‹©å“ç±»</h2>
          <p className="text-gray-600">ç³»ç»Ÿè‡ªåŠ¨æ ‡æ³¨æ¯ä¸ªå“ç±»ä¸ä¸»é¢˜çš„é€‚é…åº¦</p>

          <div className="space-y-4">
            {SYSTEM_DATA.categories.map(category => {
              const fit = theme ? calculateCategoryFit(theme, category) : { level: 'medium', score: 50 };
              const isSelected = selected.find(c => c.id === category.id);

              return (
                <div
                  key={category.id}
                  onClick={() => toggleCategory(category)}
                  className={`p-5 rounded-lg border-2 cursor-pointer transition-all ${
                    isSelected ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex items-start space-x-4">
                      <input
                        type="checkbox"
                        checked={!!isSelected}
                        onChange={() => {}}
                        className="w-6 h-6 mt-1"
                      />
                      <div className="flex-1">
                        <div className="flex items-center space-x-2">
                          <span className="text-2xl">{category.emoji}</span>
                          <h3 className="text-lg font-semibold">{category.name}</h3>
                        </div>
                        <div className="mt-2 space-y-1 text-sm">
                          <div>
                            <span className="font-medium">é€‚é…åº¦ï¼š</span>
                            <span className={`ml-2 ${
                              fit.level === 'high' ? 'text-green-600' :
                              fit.level === 'medium' ? 'text-yellow-600' : 'text-red-600'
                            }`}>
                              {fit.level === 'high' ? 'âœ… é«˜' : fit.level === 'medium' ? 'âš ï¸ ä¸­' : 'âŒ ä½'}
                              ï¼ˆ{fit.score}åˆ†ï¼‰
                            </span>
                          </div>
                          <div>
                            <span className="font-medium">ç»“æ„å»ºè®®ï¼š</span>
                            <span className="ml-2 text-gray-600">{fit.structureRecommend?.join(' / ')}</span>
                          </div>
                          <div>
                            <span className="font-medium">é€‚åˆä¸»é¢˜ï¼š</span>
                            <span className="ml-2 text-gray-600">{fit.notes}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <button onClick={handleNext} className="btn-primary w-full">
            ç¡®è®¤å“ç±»å¹¶ç»§ç»­ â†’
          </button>
        </div>
      );
    }

    // Tab 4: å¸‚åœºéªŒè¯
    function Tab4MarketValidation({ data, researchData, updateData, onNext }) {
      const [baseline, setBaseline] = useState(data.marketBaseline || '');
      const [loading, setLoading] = useState(false);

      // ä»æ–°çš„3æ­¥è°ƒç ”æ•°æ®è¯»å–
      const trendData = researchData?.stepResults?.[1] || {}; // è¶‹åŠ¿&é…è‰²
      const salesData = researchData?.stepResults?.[2] || {};  // é”€é‡éªŒè¯
      const crossData = researchData?.stepResults?.[3] || {};  // è·¨ç•Œçµæ„Ÿ

      const analyzeMarket = async () => {
        setLoading(true);
        const prompt = `åŸºäºä»¥ä¸‹3æ­¥è°ƒç ”æ•°æ®ï¼Œæå–ç«¥è£…PODå¸‚åœºåŸºå‡†ï¼š

ã€è¶‹åŠ¿éªŒè¯ & 2026é…è‰²ã€‘
è¶‹åŠ¿å…³é”®è¯ï¼š${(trendData.trends || []).map(t => `${t.keyword}ï¼ˆ${t.hotLevel || 'ä¸­'}çƒ­åº¦ï¼‰`).join('ï¼Œ')}
2026é…è‰²è¶‹åŠ¿ï¼š${trendData.colors2026?.pantone || 'æ— '}

ã€é”€é‡éªŒè¯ã€‘
å…±æ€§å…ƒç´ ï¼š${(salesData.commonElements || []).join('ï¼Œ')}
å…±æ€§é…è‰²ï¼š${(salesData.commonColors || []).join('ï¼Œ')}

ã€è·¨ç•Œçµæ„Ÿã€‘
Top3æ–¹å‘ï¼š${(crossData.top3 || []).join('ï¼Œ')}

è¯·è¾“å‡ºå¸‚åœºåŸºå‡†ï¼š
å›¾æ¡ˆå¯†åº¦ï¼š[high/medium/low + ç•™ç™½ä¼°ç®—]
æ’ç‰ˆç»“æ„ï¼š[scattered/stripe/center/scene]
é…è‰²å€¾å‘ï¼š[pastel/bright/neutral/dark]
å®‰å…¨å…ƒç´ ï¼š[å¸‚åœºå·²éªŒè¯çš„å…ƒç´ ï¼Œè‹±æ–‡]
å®‰å…¨åº•ç›˜ï¼š[ä¸€å¥è¯æ€»ç»“]`;

        const result = await callClaudeAPI(prompt, "ä½ æ˜¯ç«¥è£…PODå¸‚åœºåˆ†æä¸“å®¶ï¼Œæ“…é•¿æç‚¼å¸‚åœºåŸºå‡†è§„å¾‹ã€‚");
        setLoading(false);
        if (result) { setBaseline(result); updateData('marketBaseline', result); }
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">ğŸ” å¸‚åœºåŸºå‡†éªŒè¯</h2>
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
            <p className="font-semibold">âš ï¸ æ ¸å¿ƒåŸåˆ™ï¼šçˆ†æ¬¾ = 70%ç†Ÿæ‚‰æ„Ÿ + 30%æ–°é²œæ„Ÿ</p>
            <p className="text-sm mt-1">å…ˆç¡®è®¤å¸‚åœºå®‰å…¨åº•ç›˜ï¼Œå†å†³å®š30%çš„æ–°é²œå‡çº§æ–¹å‘</p>
          </div>

          {/* æ˜¾ç¤ºè°ƒç ”æ•°æ®æ¥æºï¼ˆæ–°3æ­¥ç»“æ„ï¼‰*/}
          {(trendData.trends || salesData.commonElements || crossData.top3) ? (
            <div className="grid md:grid-cols-3 gap-4">
              {trendData.trends && (
                <div className="bg-purple-50 rounded-xl p-4">
                  <h4 className="font-semibold text-purple-700 mb-2">ğŸ”¥ è¶‹åŠ¿éªŒè¯</h4>
                  <div className="text-sm space-y-1">
                    <div><span className="text-gray-500">å…³é”®è¯ï¼š</span>{(trendData.trends || []).slice(0, 3).map(t => t.keyword).join(', ')}</div>
                    {trendData.colors2026 && <div><span className="text-gray-500">2026é…è‰²ï¼š</span>{trendData.colors2026.pantone || 'æ— '}</div>}
                  </div>
                </div>
              )}
              {salesData.commonElements && (
                <div className="bg-green-50 rounded-xl p-4">
                  <h4 className="font-semibold text-green-700 mb-2">ğŸ’° é”€é‡éªŒè¯</h4>
                  <div className="text-sm space-y-1">
                    <div><span className="text-gray-500">å…±æ€§å…ƒç´ ï¼š</span>{(salesData.commonElements || []).join(', ')}</div>
                    <div><span className="text-gray-500">å…±æ€§é…è‰²ï¼š</span>{(salesData.commonColors || []).join(', ')}</div>
                  </div>
                </div>
              )}
              {crossData.top3 && (
                <div className="bg-blue-50 rounded-xl p-4">
                  <h4 className="font-semibold text-blue-700 mb-2">ğŸ¨ è·¨ç•Œçµæ„Ÿ</h4>
                  <div className="text-sm space-y-1">
                    <div><span className="text-gray-500">Top3ï¼š</span>{(crossData.top3 || []).join(', ')}</div>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="bg-yellow-50 border border-yellow-300 rounded-xl p-4 text-sm text-yellow-700">
              âš ï¸ æœªæ£€æµ‹åˆ°è°ƒç ”æ•°æ®ï¼Œå»ºè®®å…ˆå®Œæˆå¸‚åœºè°ƒç ”å†ç»§ç»­
            </div>
          )}

          <button onClick={analyzeMarket} disabled={loading} className="btn-primary w-full">
            {loading ? 'ğŸ”„ AIæç‚¼ä¸­...' : 'ğŸ¤– AIç»¼åˆæç‚¼å¸‚åœºåŸºå‡†'}
          </button>
          {loading && <div className="loading-spinner mx-auto"></div>}

          {baseline && (
            <div className="bg-white border-2 border-purple-200 rounded-xl p-6">
              <h3 className="font-bold text-lg mb-3">ğŸ“Š å¸‚åœºåŸºå‡†ï¼ˆå·²ç¡®è®¤ï¼‰</h3>
              <div className="whitespace-pre-wrap text-sm">{baseline}</div>
            </div>
          )}

          <button onClick={onNext} disabled={!baseline}
            className="btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed">
            {baseline ? 'ç¡®è®¤åŸºå‡†ï¼Œè¿›å…¥å…ƒç´ åŒ…ç”Ÿæˆ â†’' : 'è¯·å…ˆæç‚¼å¸‚åœºåŸºå‡†'}
          </button>
        </div>
      );
    }

    // Tab 5: AIå…ƒç´ åŒ…ç”Ÿæˆ
    function Tab5AIElementCombo({ data, researchData, updateData, onNext }) {
      const [combos, setCombos] = useState(data.elementCombos || []);
      const [loading, setLoading] = useState(false);
      const [selected, setSelected] = useState([]);

      const generateCombos = async () => {
        setLoading(true);

        const trendData = researchData?.stepResults?.[1] || {};
        const patternData = researchData?.stepResults?.[2] || {};
        const salesData = researchData?.stepResults?.[5] || {};
        const colorData = researchData?.stepResults?.[7] || {};

        const trendKeywords = (trendData.trends || []).map(t => t.keyword).join(', ') || 'æ— ';
        const patternStyles = (patternData.topPatternStyles || []).join(', ') || 'æ— ';
        const salesElements = (salesData.commonElements || []).join(', ') || 'æ— ';
        const newElements = (colorData.newElements || []).map(e => e.element).join(', ') || 'æ— ';

        const prompt = `ä½ æ˜¯ç«¥è£…PODçˆ†æ¬¾è®¾è®¡ä¸“å®¶ã€‚

å·²ç¡®å®šä¿¡æ¯ï¼š
- å¹´é¾„æ®µï¼š${data.ageGroup}
- åœºæ™¯ï¼š${data.scenes?.join(', ')}
- ä¸»é¢˜ï¼š${data.selectedTheme?.name || data.selectedTheme?.en}
- å¸‚åœºåŸºå‡†ï¼š${data.marketBaseline}

ã€å®æ—¶è°ƒç ”ç»“æœã€‘
- è¶‹åŠ¿å…³é”®è¯ï¼ˆæ­¥éª¤1ï¼‰ï¼š${trendKeywords}
- çƒ­é—¨å›¾æ¡ˆé£æ ¼ï¼ˆæ­¥éª¤2ï¼‰ï¼š${patternStyles}
- é”€é‡éªŒè¯å…ƒç´ ï¼ˆæ­¥éª¤5ï¼‰ï¼š${salesElements}
- æ–°å…ƒç´ åº“ï¼ˆæ­¥éª¤7ï¼‰ï¼š${newElements}

ä¸»é¢˜å…ƒç´ åº“ï¼š
${data.selectedTheme?.elements?.join(', ')}

è¶‹åŠ¿å…ƒç´ åº“ï¼š
${SYSTEM_DATA.trends_2025.map(t => t.elements.join(', ')).join(' | ')}

ç”Ÿæˆ3-5ä¸ªå…ƒç´ åŒ…ï¼Œä¸¥æ ¼éµå®ˆè§„åˆ™ï¼š

ã€å…ƒç´ é…æ¯”ã€‘
- å¸¸è§„å…ƒç´ 40%ï¼ˆ2-3ä¸ªï¼Œé•¿æœŸç¨³å®šå–ï¼‰
- æµè¡Œå…ƒç´ 30%ï¼ˆ1-2ä¸ªï¼Œ2025è¶‹åŠ¿ï¼‰
- è¿æ¥å…ƒç´ 30%ï¼ˆ1ä¸ªï¼Œsparkle/dots/starsç­‰ï¼‰

ã€é…è‰²è§„åˆ™ã€‘
- 5-6è‰²ï¼šä¸»è‰²2 + è¾…è‰²2-3 + ç‚¹ç¼€1
- ä½é¥±å’Œä¼˜å…ˆã€æ€»è‰²æ•°â‰¤6

ã€ç»“æ„è§„åˆ™ã€‘
- æ•£ç‚¹é‡å¤/æ¡çº¹å åŠ /ä¸­å¿ƒå¤§å›¾/åœºæ™¯æ’ç”»ï¼ˆé€‰ä¸€ä¸ªï¼‰
- å¯†åº¦æ§åˆ¶ï¼šç•™ç™½æ¯”ä¾‹ã€å…ƒç´ é—´è·

ã€å¹´é¾„æ®µé€‚é…ã€‘
- Newbornï¼šå¤§å›¾+ä½å¯†åº¦+3è‰²
- Toddlerï¼šæ ‡å‡†å¯†åº¦+æ•…äº‹æ„Ÿ
- Little Kidï¼šå°å›¾+å­¦é™¢é£

ã€å·¥è‰ºæ£€æŸ¥ã€‘
- é¢œè‰²æ•°â‰¤6
- çº¿æ¡ä¸è¿‡ç»†

ã€åˆè§„æ£€æŸ¥ã€‘
- æ— IPä¾µæƒ
- æ— æ•æ„Ÿå†…å®¹

è¾“å‡ºJSONæ ¼å¼ï¼š
[{
  "coreName": "Easter Cottagecore Bunny",
  "coreNameCN": "å¤æ´»èŠ‚ç”°å›­å°å…”",
  "coreElements": ["bunny", "easter egg"],
  "trendElements": ["cottagecore mushroom", "wildflower"],
  "connectElements": ["small sparkle"],
  "structure": "scattered repeat",
  "structureDensity": "medium",
  "whitespace": "30%",
  "layering": "å¤§å…”+ä¸­è›‹+å°è˜‘è‡+é—ªå…‰",
  "colors": ["cream pink", "mint green", "lavender", "butter yellow", "white"],
  "colorSystem": {
    "primary": ["cream pink", "mint green"],
    "secondary": ["lavender", "butter yellow"],
    "accent": ["white"]
  },
  "ageAdaptations": {
    "newborn": "å¤§å›¾+ä½å¯†åº¦+ä»…3è‰²ï¼ˆcream pink+mint+whiteï¼‰",
    "toddler": "æ ‡å‡†å¯†åº¦+æ•…äº‹æ„Ÿï¼ˆå…”å­æ’é˜Ÿæ‰¾å½©è›‹ï¼‰",
    "littleKid": "å°å›¾+å­¦é™¢é£ï¼ˆåŠ å­—æ¯E, 1st Easterï¼‰"
  },
  "productionCheck": {
    "colorCount": 5,
    "feasible": true,
    "notes": "å¯é‡äº§"
  },
  "complianceCheck": {
    "safe": true,
    "notes": "æ— IPé£é™©"
  },
  "marketFit": {
    "familiar": "70%",
    "fresh": "30%",
    "reason": "Bunny+Eggæ˜¯å®‰å…¨å…ƒç´ ï¼ˆ70%ï¼‰ï¼ŒCottagecoreæä¾›æ–°é²œæ„Ÿï¼ˆ30%ï¼‰"
  }
}]

åªè¾“å‡ºJSONï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚`;

        const result = await callClaudeAPI(prompt, "ä½ æ˜¯ç«¥è£…PODè®¾è®¡ä¸“å®¶ï¼Œè¾“å‡ºä¸¥æ ¼çš„JSONæ ¼å¼ã€‚");
        
        setLoading(false);
        if (result) {
          try {
            const cleaned = result.replace(/```json|```/g, '').trim();
            const parsed = JSON.parse(cleaned);
            setCombos(parsed);
            updateData('elementCombos', parsed);
          } catch (e) {
            alert('AIè¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•');
          }
        }
      };

      const toggleSelect = (combo) => {
        setSelected(prev => {
          const exists = prev.find(c => c.coreName === combo.coreName);
          return exists ? prev.filter(c => c.coreName !== combo.coreName) : [...prev, combo];
        });
      };

      const handleNext = () => {
        if (selected.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©1ä¸ªå…ƒç´ åŒ…');
          return;
        }
        updateData('elementCombos', selected);
        onNext();
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">ğŸ¯ Step 3-8 - AIæ¨èå…ƒç´ åŒ…</h2>

          <button onClick={generateCombos} disabled={loading} className="btn-primary w-full">
            {loading ? 'ğŸ”„ AIç”Ÿæˆä¸­...' : 'ğŸ¤– AIç”Ÿæˆå…ƒç´ åŒ…æ¨è'}
          </button>

          {loading && <div className="loading-spinner"></div>}

          {combos.length > 0 && (
            <div className="space-y-4">
              {combos.map((combo, idx) => (
                <div
                  key={idx}
                  className={`combo-card ${selected.find(c => c.coreName === combo.coreName) ? 'selected' : ''}`}
                >
                  <div className="flex items-start space-x-4">
                    <input
                      type="checkbox"
                      checked={!!selected.find(c => c.coreName === combo.coreName)}
                      onChange={() => toggleSelect(combo)}
                      className="w-6 h-6 mt-2"
                    />
                    <div className="flex-1">
                      <h3 className="text-xl font-bold text-purple-700">{combo.coreName}</h3>
                      <p className="text-gray-600 mb-4">{combo.coreNameCN}</p>

                      <div className="grid md:grid-cols-2 gap-4">
                        <div>
                          <h4 className="font-semibold text-blue-600 mb-2">ğŸ”µ å¸¸è§„å…ƒç´ ï¼ˆ40%ï¼‰</h4>
                          <div className="flex flex-wrap gap-2">
                            {combo.coreElements?.map((el, i) => (
                              <span key={i} className="element-tag bg-blue-50 text-blue-600">{el}</span>
                            ))}
                          </div>
                        </div>

                        <div>
                          <h4 className="font-semibold text-purple-600 mb-2">ğŸŸ£ æµè¡Œå…ƒç´ ï¼ˆ30%ï¼‰</h4>
                          <div className="flex flex-wrap gap-2">
                            {combo.trendElements?.map((el, i) => (
                              <span key={i} className="element-tag bg-purple-50 text-purple-600">{el}</span>
                            ))}
                          </div>
                        </div>

                        <div>
                          <h4 className="font-semibold text-gray-600 mb-2">âšª è¿æ¥å…ƒç´ ï¼ˆ30%ï¼‰</h4>
                          <div className="flex flex-wrap gap-2">
                            {combo.connectElements?.map((el, i) => (
                              <span key={i} className="element-tag bg-gray-50 text-gray-600">{el}</span>
                            ))}
                          </div>
                        </div>

                        <div>
                          <h4 className="font-semibold mb-2">ğŸ“ ç»“æ„</h4>
                          <div className="text-sm space-y-1">
                            <div>ç±»å‹ï¼š{combo.structure}</div>
                            <div>å¯†åº¦ï¼š{combo.structureDensity} | ç•™ç™½ï¼š{combo.whitespace}</div>
                            <div>å±‚çº§ï¼š{combo.layering}</div>
                          </div>
                        </div>
                      </div>

                      <div className="mt-4">
                        <h4 className="font-semibold mb-2">ğŸ¨ é…è‰²ï¼ˆ{combo.colors?.length}è‰²ï¼‰</h4>
                        <div className="flex flex-wrap gap-2">
                          {combo.colors?.map((color, i) => (
                            <div key={i} className="flex items-center space-x-2">
                              <div className="color-swatch" style={{ background: color }}></div>
                              <span className="text-sm">{color}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="mt-4 bg-gray-50 p-4 rounded-lg">
                        <h4 className="font-semibold mb-2">ğŸ‘¶ğŸ‘§ğŸ‘¦ å¹´é¾„æ®µé€‚é…</h4>
                        <div className="space-y-2 text-sm">
                          <div>â€¢ Newborn: {combo.ageAdaptations?.newborn}</div>
                          <div>â€¢ Toddler: {combo.ageAdaptations?.toddler}</div>
                          <div>â€¢ Little Kid: {combo.ageAdaptations?.littleKid}</div>
                        </div>
                      </div>

                      <div className="mt-4 grid md:grid-cols-2 gap-4">
                        <div className={`p-3 rounded-lg ${combo.productionCheck?.feasible ? 'bg-green-50' : 'bg-red-50'}`}>
                          <h4 className="font-semibold mb-1">
                            ğŸ­ å·¥è‰ºæ£€æŸ¥ï¼š{combo.productionCheck?.feasible ? 'âœ… é€šè¿‡' : 'âŒ é£é™©'}
                          </h4>
                          <p className="text-sm">é¢œè‰²æ•°ï¼š{combo.productionCheck?.colorCount}è‰²</p>
                          <p className="text-sm">{combo.productionCheck?.notes}</p>
                        </div>

                        <div className={`p-3 rounded-lg ${combo.complianceCheck?.safe ? 'bg-green-50' : 'bg-red-50'}`}>
                          <h4 className="font-semibold mb-1">
                            ğŸ”’ åˆè§„æ£€æŸ¥ï¼š{combo.complianceCheck?.safe ? 'âœ… å®‰å…¨' : 'âš ï¸ é£é™©'}
                          </h4>
                          <p className="text-sm">{combo.complianceCheck?.notes}</p>
                        </div>
                      </div>

                      <div className="mt-4 bg-purple-50 p-4 rounded-lg">
                        <h4 className="font-semibold mb-2">ğŸ“Š å¸‚åœºåŒ¹é…åº¦</h4>
                        <div className="text-sm space-y-1">
                          <div>ç†Ÿæ‚‰æ„Ÿï¼š{combo.marketFit?.familiar} | æ–°é²œæ„Ÿï¼š{combo.marketFit?.fresh}</div>
                          <div className="mt-2">
                            <strong>ğŸ’¡ ä¸ºä»€ä¹ˆèƒ½å–ï¼š</strong>
                            <p className="mt-1">{combo.marketFit?.reason}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {selected.length > 0 && (
            <button onClick={handleNext} className="btn-primary w-full">
              å·²é€‰æ‹© {selected.length} ä¸ªå…ƒç´ åŒ…ï¼Œç”ŸæˆMJå’’è¯­ â†’
            </button>
          )}
        </div>
      );
    }

    // Tab 6: MJå’’è¯­ç”Ÿæˆ
    function Tab6MJPrompts({ data, updateData, onNext }) {
      const [prompts, setPrompts] = useState(data.mjPrompts || {});
      const [loading, setLoading] = useState(false);
      const combos = data.elementCombos || [];

      const generatePrompts = async () => {
        setLoading(true);
        const allPrompts = {};
        const selectedAge = data.ageGroup;

        for (const combo of combos) {
          const prompts = {};
          
          // å‡†å¤‡å…ƒç´ æ± 
          const coreElements = combo.coreElements || [];
          const trendElements = combo.trendElements || [];
          const connectElements = combo.connectElements || [];
          const allElements = [...coreElements, ...trendElements, ...connectElements];
          const colors = (combo.colors || []).slice(0, 3);

          // æ€§åˆ«ä¿®é¥°è¯
          const genderMods = {
            boy: ['boy adventure', 'cool boys', 'action theme'],
            girl: ['girl cute', 'sweet girls', 'pretty theme'],
            unisex: ['gender neutral', 'universal', 'kids friendly']
          };
          const genderModList = genderMods[data.gender] || genderMods.unisex;

          // å¹´é¾„æ®µé…ç½®
          const ageConfigs = {
            newborn: { 
              seamlessCount: 2, // æ— ç¼å›¾å…ƒç´ æ•°
              singleCount: 3,   // éæ— ç¼å›¾å…ƒç´ æ•°
              mod: 'extra large, whitespace 40%',
              stylize: 180 
            },
            toddler: { 
              seamlessCount: 3,
              singleCount: 4,
              mod: 'storytelling, playful',
              stylize: 200 
            },
            littleKid: { 
              seamlessCount: 3,
              singleCount: 5,
              mod: 'detailed, school style',
              stylize: 220 
            },
            bigKid: { 
              seamlessCount: 3,
              singleCount: 4,
              mod: 'trendy, teenager',
              stylize: 250 
            }
          };

          const config = ageConfigs[selectedAge];
          if (!config) continue;

          const ageTag = selectedAge === 'newborn' ? 'NEWBORN' :
                        selectedAge === 'toddler' ? 'TODDLER' :
                        selectedAge === 'littleKid' ? 'LITTLE KID (6-10y)' : 'BIG KID (11-14y)';

          const agePrompts = [];
          
          // æ— ç¼å›¾ 5æ¡ - æ¯æ¡å…ƒç´ ä¸åŒ
          for (let i = 0; i < 5; i++) {
            const style = MJ_STYLES[i];
            const genderMod = genderModList[i % genderModList.length];
            
            // éšæœºé€‰æ‹©å…ƒç´ ï¼ˆç¡®ä¿è‡³å°‘1ä¸ªæ ¸å¿ƒå…ƒç´ ï¼‰
            const selectedElements = [];
            if (coreElements.length > 0) {
              selectedElements.push(coreElements[i % coreElements.length]);
            }
            // å¡«å……å‰©ä½™å…ƒç´ 
            const remainingSlots = config.seamlessCount - selectedElements.length;
            for (let j = 0; j < remainingSlots && j < allElements.length; j++) {
              const idx = (i * 3 + j) % allElements.length;
              if (!selectedElements.includes(allElements[idx])) {
                selectedElements.push(allElements[idx]);
              }
            }
            
            // é¢œè‰²ä¹Ÿè½®æ¢
            const colorSet = colors.length > 0 ? 
              [colors[i % colors.length], colors[(i + 1) % colors.length], colors[(i + 2) % colors.length]].join(' ') :
              'pastel colors';

            agePrompts.push(
              `/imagine prompt: ${selectedElements.join(', ')}, FOR ${ageTag}, ${config.mod}, ${genderMod}, ${colorSet}, seamless repeat pattern, ${style}, --tile --no watermark text --ar 1:1 --v 6 --stylize ${config.stylize}`
            );
          }

          // éæ— ç¼å›¾ 5æ¡ - æ¯æ¡å…ƒç´ ä¸åŒ
          for (let i = 5; i < 10; i++) {
            const style = MJ_STYLES[i];
            const genderMod = genderModList[i % genderModList.length];
            
            // é€‰æ‹©æ›´å¤šå…ƒç´ ç”¨äºéæ— ç¼å›¾
            const selectedElements = [];
            const numToSelect = Math.min(config.singleCount, allElements.length);
            for (let j = 0; j < numToSelect; j++) {
              const idx = (i * 2 + j) % allElements.length;
              if (!selectedElements.includes(allElements[idx])) {
                selectedElements.push(allElements[idx]);
              }
            }
            
            const colorSet = colors.length > 0 ? 
              [colors[i % colors.length], colors[(i + 1) % colors.length], colors[(i + 2) % colors.length]].join(' ') :
              'pastel colors';

            agePrompts.push(
              `/imagine prompt: ${selectedElements.join(', ')}, FOR ${ageTag}, ${config.mod}, ${genderMod}, ${colorSet}, central design, ${style}, --no watermark text pattern --ar 1:1 --v 6 --stylize ${config.stylize}`
            );
          }

          prompts[selectedAge] = agePrompts;
          allPrompts[combo.coreName] = prompts;
        }

        setPrompts(allPrompts);
        updateData('mjPrompts', allPrompts);
        setLoading(false);
      };

      const copyPrompts = (text) => {
        navigator.clipboard.writeText(text);
        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      };

      const handleNext = () => {
        if (Object.keys(prompts).length === 0) {
          alert('è¯·å…ˆç”ŸæˆMJå’’è¯­');
          return;
        }
        onNext();
      };

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">âœ¨ Step 5 - ç”ŸæˆMJå’’è¯­</h2>
          <p className="text-gray-600">
            ä¸º<strong className="text-purple-600">{data.ageGroup === 'newborn' ? 'ğŸ‘¶ Newborn' : data.ageGroup === 'toddler' ? 'ğŸ§’ Toddler' : data.ageGroup === 'littleKid' ? 'ğŸ‘¦ğŸ‘§ Little Kid' : 'ğŸ§‘ Big Kid'}</strong>
            å¹´é¾„æ®µç”Ÿæˆ10æ¡å’’è¯­ï¼ˆæ— ç¼å›¾5æ¡ + éæ— ç¼å›¾5æ¡ï¼‰
          </p>

          <div className="flex gap-3">
            <button onClick={generatePrompts} disabled={loading} className="btn-primary flex-1">
              {loading ? 'ğŸ”„ ç”Ÿæˆä¸­...' : 'ğŸ¨ ç”ŸæˆMJå’’è¯­ï¼ˆ10æ¡/ç»„åˆï¼‰'}
            </button>
            {Object.keys(prompts).length > 0 && (
              <button 
                onClick={() => { setPrompts({}); setTimeout(generatePrompts, 100); }} 
                disabled={loading}
                className="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition"
              >
                ğŸ”„ å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
              </button>
            )}
          </div>

          {loading && <div className="loading-spinner"></div>}

          {Object.keys(prompts).length > 0 && (
            <div className="space-y-6">
              {Object.entries(prompts).map(([comboName, agePromptsObj]) => {
                const selectedAgePrompts = agePromptsObj[data.ageGroup] || [];
                return (
                  <div key={comboName} className="border-2 border-purple-200 rounded-lg p-6">
                    <h3 className="text-xl font-bold mb-4 text-purple-700">{comboName}</h3>
                    
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="font-semibold text-lg">
                        {data.ageGroup === 'newborn' && 'ğŸ‘¶ Newbornç‰ˆ'}
                        {data.ageGroup === 'toddler' && 'ğŸ§’ Toddlerç‰ˆ'}
                        {data.ageGroup === 'littleKid' && 'ğŸ‘¦ğŸ‘§ Little Kidç‰ˆ'}
                        {data.ageGroup === 'bigKid' && 'ğŸ§‘ Big Kidç‰ˆ'}
                        ï¼ˆ10æ¡ï¼‰
                      </h4>
                      <button
                        onClick={() => copyPrompts(selectedAgePrompts.join('\n\n'))}
                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm"
                      >
                        ğŸ“‹ å¤åˆ¶å…¨éƒ¨10æ¡
                      </button>
                    </div>
                    
                    <div className="bg-gray-50 p-3 rounded-lg text-xs text-gray-600 mb-3">
                      <strong>æ€§åˆ«å€¾å‘ï¼š</strong>
                      {data.gender === 'boy' ? 'ğŸ’™ ç”·ç«¥ä¸ºä¸»' : data.gender === 'girl' ? 'ğŸ’— å¥³ç«¥ä¸ºä¸»' : 'ğŸ’› ç”·å¥³é€šç”¨'}<br/>
                      <span className="text-purple-600 font-medium">å‰5æ¡ï¼šğŸ”² æ— ç¼å›¾ï¼ˆ--tileï¼‰| å5æ¡ï¼šğŸ–¼ï¸ éæ— ç¼å›¾ï¼ˆcenteredï¼‰</span>
                    </div>
                    
                    <div className="space-y-3">
                      {selectedAgePrompts.map((prompt, idx) => (
                        <div key={idx} className="bg-gray-900 text-gray-100 p-3 rounded-lg relative group">
                          <div className="flex items-center justify-between mb-1">
                            <div className="text-xs text-gray-400">
                              #{idx + 1} {idx < 5 ? 'ğŸ”² æ— ç¼å›¾' : 'ğŸ–¼ï¸ éæ— ç¼å›¾'}
                            </div>
                          </div>
                          <div className="text-sm font-mono leading-relaxed">{prompt}</div>
                          <button
                            onClick={() => copyPrompts(prompt)}
                            className="absolute top-2 right-2 px-3 py-1 bg-gray-700 text-white rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                          >
                            å¤åˆ¶
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {Object.keys(prompts).length > 0 && (
            <button onClick={handleNext} className="btn-primary w-full">
              ç¡®è®¤ä»»åŠ¡ï¼ŒåŒæ­¥åˆ°çœ‹æ¿ â†’
            </button>
          )}
        </div>
      );
    }

    // Tab 7: ç¡®è®¤ä»»åŠ¡
    function Tab7ConfirmTask({ data, onConfirm }) {
      const handleConfirm = () => {
        // ä¿®å¤ï¼šæ­£ç¡®ç»Ÿè®¡å’’è¯­æ•°é‡ï¼ˆæŒ‰å®é™…å¹´é¾„æ®µï¼‰
        const totalPrompts = Object.values(data.mjPrompts || {}).reduce((sum, comboPrompts) => {
          // comboPromptsæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œkeyæ˜¯å¹´é¾„æ®µåç§°
          const allAgePrompts = Object.values(comboPrompts).flat();
          return sum + allAgePrompts.length;
        }, 0);

        const task = {
          theme: data.selectedTheme,
          ageGroup: data.ageGroup,
          gender: data.gender,
          categories: data.selectedCategories,
          combos: data.elementCombos,
          mjPrompts: data.mjPrompts,
          totalPrompts,
          createdAt: new Date().toISOString(),
          status: 'pending'
        };

        onConfirm(task);
        alert('ä»»åŠ¡å·²ç¡®è®¤å¹¶åŒæ­¥åˆ°çœ‹æ¿ï¼');
      };

      // ä¿®å¤ï¼šæ­£ç¡®æ˜¾ç¤ºå’’è¯­æ•°é‡
      const totalPrompts = Object.values(data.mjPrompts || {}).reduce((sum, comboPrompts) => {
        const allAgePrompts = Object.values(comboPrompts).flat();
        return sum + allAgePrompts.length;
      }, 0);

      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">âœ… Step 7 - ç¡®è®¤ä»»åŠ¡</h2>

          <div className="card bg-gradient-to-r from-purple-50 to-pink-50">
            <h3 className="text-xl font-semibold mb-4">ğŸ“‹ ä»»åŠ¡æ‘˜è¦</h3>
            
            <div className="space-y-4">
              <div className="bg-white rounded-lg p-4">
                <h4 className="font-semibold mb-2">ğŸ‘¥ äººç¾¤å®šä½</h4>
                <div className="text-sm space-y-1">
                  <div><strong>å¹´é¾„æ®µï¼š</strong>
                    {data.ageGroup === 'newborn' && 'ğŸ‘¶ Newborn (0-2å²)'}
                    {data.ageGroup === 'toddler' && 'ğŸ§’ Toddler (2-5å²)'}
                    {data.ageGroup === 'littleKid' && 'ğŸ‘¦ğŸ‘§ Little Kid (6-10å²)'}
                    {data.ageGroup === 'bigKid' && 'ğŸ§‘ Big Kid (11-14å²)'}
                  </div>
                  <div><strong>æ€§åˆ«å€¾å‘ï¼š</strong>
                    {data.gender === 'boy' && 'ğŸ’™ ç”·ç«¥ä¸ºä¸»'}
                    {data.gender === 'girl' && 'ğŸ’— å¥³ç«¥ä¸ºä¸»'}
                    {data.gender === 'unisex' && 'ğŸ’› ç”·å¥³é€šç”¨'}
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg p-4">
                <h4 className="font-semibold mb-2">ğŸ¨ ä¸»é¢˜</h4>
                <div className="flex items-center space-x-3">
                  <span className="text-3xl">{data.selectedTheme?.emoji}</span>
                  <span className="text-lg">{data.selectedTheme?.name || data.selectedTheme?.en}</span>
                </div>
              </div>

              <div className="bg-white rounded-lg p-4">
                <h4 className="font-semibold mb-2">ğŸ“¦ å“ç±»ï¼ˆ{data.selectedCategories?.length || 0}ä¸ªï¼‰</h4>
                <div className="flex flex-wrap gap-2">
                  {data.selectedCategories?.map((cat, idx) => (
                    <span key={idx} className="element-tag">
                      {cat.emoji} {cat.name}
                    </span>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-lg p-4">
                <h4 className="font-semibold mb-2">ğŸ¯ å…ƒç´ åŒ…ï¼ˆ{data.elementCombos?.length || 0}ä¸ªï¼‰</h4>
                <div className="space-y-2">
                  {data.elementCombos?.map((combo, idx) => (
                    <div key={idx} className="border-l-4 border-purple-400 pl-3">
                      <div className="font-medium">{combo.coreName}</div>
                      <div className="text-sm text-gray-600">
                        å¸¸è§„: {combo.coreElements?.join(', ')} | 
                        æµè¡Œ: {combo.trendElements?.join(', ')} | 
                        è¿æ¥: {combo.connectElements?.join(', ')}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-lg p-4">
                <h4 className="font-semibold mb-2">âœ¨ MJå’’è¯­</h4>
                <div className="text-sm">
                  å·²ç”Ÿæˆ <strong className="text-purple-600 text-xl">{totalPrompts}</strong> æ¡å’’è¯­
                  <div className="text-xs text-gray-500 mt-1">
                    ({data.elementCombos?.length || 0}ä¸ªå…ƒç´ åŒ… Ã— 10æ¡/åŒ…)
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button onClick={handleConfirm} className="btn-primary w-full text-lg py-4">
            âœ… ç¡®è®¤ä»»åŠ¡ï¼ŒåŒæ­¥åˆ°çœ‹æ¿
          </button>

          <div className="bg-blue-50 p-4 rounded-lg text-sm">
            <p><strong>ä¸‹ä¸€æ­¥ï¼š</strong></p>
            <ol className="list-decimal list-inside space-y-1 mt-2">
              <li>å¤åˆ¶MJå’’è¯­åˆ°Midjourneyç”Ÿæˆå›¾æ¡ˆ</li>
              <li>ä¸‹è½½å–œæ¬¢çš„å›¾æ¡ˆ</li>
              <li>å‰å¾€ã€ŒListingç”Ÿæˆã€é¡µé¢ä¸Šä¼ å›¾æ¡ˆ</li>
              <li>AIç”ŸæˆListingæ–‡æ¡ˆ</li>
              <li>ä¸Šæ¶é”€å”®</li>
            </ol>
          </div>
        </div>
      );
    }

    // ========== Page 3: Listingç”Ÿæˆ ==========
    // ========== Listingç”Ÿæˆå™¨ï¼šå…³é”®è¯æ•°æ®åº“ ==========
    const LISTING_KEYWORD_DB = {
      "P23å„¿ç«¥è¿ä½“è£¤ (Onesie Pajamas)": {
        enName: "Onesie Pajamas",
        layer1: ["kids onesie pajamas","onesie pajamas for kids","kids fleece pajamas","kids zip up pajamas","kids footie pajamas","kids one piece pajamas","kids comfy pjs","onesies kids pajamas","onesie pjs for kids","kids pajama onesie","kids fuzzy pajamas"],
        layer2: ["boys onesie pajamas","girls onesie pajamas","galaxy onesie kids","space pajamas boys","halloween pjs kids","boys fleece onesie pajamas","big kid onesie pajamas","toddler onesie pajamas","footie pajamas","hooded onesie","warm pajamas","machine washable","comfortable pjs","boys animal onesie","astronaut pajamas kids","fleece onesie boys"],
        layer3: ["onesie pajamas boys","jumpsuit pajamas","one piece fuzzy pjs","pjs onesie for kids","boys novelty pajamas","pajama onesie for boys","boys jumpsuit pajamas","one piece pajamas"]
      },
      "F93å«è£¤ (Sweatpants)": {
        enName: "Sweatpants",
        layer1: ["kids sweatpants","boys sweatpants","girls sweatpants","kids jogger pants","boys joggers","kids joggers","boys athletic pants","jogger pants boys","kids jogger sweatpants"],
        layer2: ["tie dye pants kids","boys tie dye joggers","colorful sweatpants","cotton joggers","boys joggers size 10-12","neon pants boys","kids tie dye pants","boys colorful sweatpants","fire pants kids","cool sweatpants kids","polyester sweatpants kids","cotton sweatpants kids"],
        layer3: ["youth jogger pants","athletic sweatpants boys","youth sweatpants","joggers for kids","casual joggers boys","sports jogger pants kids","kids fashion sweatpants","sweatpants for kids","active joggers kids"]
      },
      "BZ23è¿è¡£è£™ (Girls Dress)": {
        enName: "Girls Dress",
        layer1: ["girls dress","girls cotton dress","girls summer dress","girls casual dress","girls everyday dress","kids dress","girls short sleeve dress"],
        layer2: ["girls dress for summer","girls flowy dress","girls dress for birthday party","girls breathable dress","girls dress for school","girls dress for playtime","girls easy care dress","girls stretchy dress","girls lightweight dress","girls machine washable dress","girls cotton jersey dress","girls soft fabric dress","girls dress for vacation"],
        layer3: ["little girls dress","big girls dress","girls party dress","girls daily wear dress","girls cute dress","girls twirl dress","girls graphic dress","girls printed dress"]
      },
      "YFA-CZB79-ç‘œä¼½è£¤ (Yoga Pants)": {
        enName: "Yoga Pants",
        layer1: ["girls harem pants","harem pants for girls","girls yoga pants","girls wide leg yoga pants","girl baggy yoga pants","dance pants girls","girls baggy pants","balloon pants girls","harem kid pants","girls harem dance pants"],
        layer2: ["harem pants toddler","kids harem pants","little girls harem pants","kids yoga pants","harem pants for toddlers","girls loose harem pants","kids dance yoga pants","teen girls yoga pants","kids soft yoga pants","kids loose yoga pants","palazzo pants for girls","harem pant kids"],
        layer3: ["yoga pants for girls","yoga pants kids","girls harem patch pants","girls yoga dance pants","little girl harem pants","harem pants costume","kids modal harem pants","traditional harem pants girls","girls casual harem pants","baby girl harem pants"]
      },
      "FZ27é•¿æ¬¾å„¿ç«¥å¸¦å¸½å£è¢‹å«è¡£ (Hoodie)": {
        enName: "Hoodie",
        layer1: ["kids hoodie","girls hoodie","boys hoodie","kids hooded sweatshirt","children hoodie","kids pullover hoodie","youth hoodie"],
        layer2: ["girls oversized hoodie","long hoodie kids","kids hoodie with pocket","girls cozy hoodie","kids graphic hoodie","printed hoodie kids","kids fleece hoodie","soft hoodie for kids","girls cute hoodie","kids fall hoodie","kids winter hoodie"],
        layer3: ["kids novelty hoodie","kids sweatshirt hoodie","youth hooded sweatshirt","children hooded top","kids hooded top","girls hooded sweatshirt","boys graphic hoodie"]
      },
      "CZH14å¥³ç«¥è¿åŠ¨æœæ‹‰é“¾å¥—è£… (Tracksuit)": {
        enName: "Girls Tracksuit",
        layer1: ["girls tracksuit","girls zip up set","girls athletic set","girls sports set","girls jogger set","girls sweatsuit","kids tracksuit"],
        layer2: ["girls matching set","girls zip jacket set","girls active set","girls casual set","girls warm up suit","girls 2 piece set","girls athletic outfit","girls sporty set","girls zip hoodie set"],
        layer3: ["girls jogging suit","girls sport outfit","girls matching outfit","girls athletic wear","kids sweat suit","girls activewear set","girls zip set"]
      },
      "FZ25å¥³ç«¥å®½æ¾å¼€å‰åœ†é¢†é•¿è¢–å«è¡£ (Oversized Sweatshirt)": {
        enName: "Oversized Sweatshirt",
        layer1: ["girls sweatshirt","girls oversized sweatshirt","girls crewneck sweatshirt","kids sweatshirt","girls long sleeve top","girls pullover sweatshirt"],
        layer2: ["girls graphic sweatshirt","girls cute sweatshirt","girls cozy sweatshirt","girls soft sweatshirt","girls printed sweatshirt","girls loose sweatshirt","girls casual sweatshirt","girls fall sweatshirt","girls slouchy sweatshirt"],
        layer3: ["girls crew neck sweatshirt","kids graphic top","youth sweatshirt girls","girls fleece top","girls relaxed fit sweatshirt","girls novelty sweatshirt","kids long sleeve sweatshirt"]
      },
      "CZH15å¥³ç«¥é•¿è¢–è¿åŠ¨ç½‘çƒè£™ (Tennis Dress)": {
        enName: "Girls Tennis Dress",
        layer1: ["girls tennis dress","girls athletic dress","girls sports dress","girls active dress","girls skort dress","girls long sleeve dress"],
        layer2: ["girls tennis outfit","girls sport skirt dress","girls athletic skirt","girls active skirt","girls performance dress","girls sporty dress","girls workout dress","girls tennis skirt","girls athletic wear dress"],
        layer3: ["girls sports skirt","girls athletic skirt dress","kids tennis outfit","girls activewear dress","girls sport dress","girls training dress","kids sport skirt"]
      },
      "CZH8å„¿ç«¥å¹³è‚©å¼€è¡«å«è¡£ (Cardigan)": {
        enName: "Kids Cardigan",
        layer1: ["girls cardigan","kids cardigan","girls open front cardigan","kids zip up cardigan","girls knit cardigan","girls sweater cardigan"],
        layer2: ["girls cute cardigan","girls casual cardigan","girls cozy cardigan","girls printed cardigan","girls lightweight cardigan","girls fall cardigan","girls layering cardigan","girls soft cardigan"],
        layer3: ["kids open cardigan","girls zip cardigan","girls button cardigan","youth cardigan","kids knit top","girls sweater","girls school cardigan","girls long sleeve cardigan"]
      },
      "FZ34å„¿ç«¥æ£’çƒæœ (Baseball Jacket)": {
        enName: "Kids Baseball Jacket",
        layer1: ["kids baseball jacket","boys baseball jacket","girls baseball jacket","kids letterman jacket","kids bomber jacket","youth baseball jacket"],
        layer2: ["kids varsity jacket","kids colorblock jacket","kids retro jacket","boys cool jacket","kids graphic jacket","kids fall jacket","kids casual jacket","boys letterman jacket","kids two tone jacket"],
        layer3: ["kids sports jacket","youth varsity jacket","kids team jacket","boys retro jacket","kids athletic jacket","kids fashion jacket","kids outerwear"]
      },
      "FZ42å„¿ç«¥å«è¡£ä¿æš–å¥—å¤´è¡« (Pullover)": {
        enName: "Kids Pullover",
        layer1: ["kids pullover","boys pullover sweatshirt","girls pullover","kids crewneck pullover","kids fleece pullover","youth pullover sweatshirt"],
        layer2: ["kids warm pullover","kids graphic pullover","kids cozy pullover","kids printed pullover","kids soft pullover","kids winter pullover","kids casual pullover","kids everyday pullover","kids cute pullover"],
        layer3: ["kids sweatshirt pullover","youth pullover","kids top sweatshirt","boys crewneck","girls crewneck","kids fleece top","kids novelty pullover","kids school sweatshirt"]
      },
      "CZH11å¥³ç«¥ä¼‘é—²æ‹‰é“¾å¤–å¥— (Zip Jacket)": {
        enName: "Girls Zip Jacket",
        layer1: ["girls zip up jacket","girls zip jacket","girls lightweight jacket","girls casual jacket","girls hoodie jacket","girls windbreaker"],
        layer2: ["girls cute jacket","girls everyday jacket","girls fall jacket","girls spring jacket","girls colorful jacket","girls graphic jacket","girls active jacket","girls zip up hoodie","girls zip front jacket","girls cozy jacket"],
        layer3: ["girls zip coat","girls outer layer","girls zip top","girls casual coat","girls light jacket","girls zip sweatshirt","kids zip jacket","girls fashion jacket"]
      },
      "ET5804012 å„¿ç«¥å«è¡£å¥—è£… (Hoodie Set)": {
        enName: "Kids Hoodie Set",
        layer1: ["kids hoodie set","boys hoodie set","girls hoodie set","kids sweatsuit set","kids matching hoodie set","kids 2 piece hoodie set"],
        layer2: ["kids matching sweatsuit","kids cozy set","kids casual set","kids printed hoodie set","kids graphic set","kids fall set","kids winter set","kids warm set","boys matching set","girls matching sweatsuit"],
        layer3: ["kids sport set","youth hoodie set","kids sweat set","kids lounge set","kids comfy set","kids track set","kids pullover set","kids outfit set"]
      },
      "FZ5 åŠ ç»’æ¬¾å„¿ç«¥å¼€è¡«å«è¡£ (Fleece Cardigan)": {
        enName: "Kids Fleece Cardigan",
        layer1: ["kids fleece cardigan","girls fleece cardigan","boys fleece cardigan","kids fleece zip up","kids warm cardigan","kids sherpa cardigan"],
        layer2: ["kids plush cardigan","kids soft fleece jacket","girls cozy cardigan","kids fuzzy cardigan","kids fluffy cardigan","kids warm zip up","kids fall fleece","kids winter cardigan","kids thermal cardigan"],
        layer3: ["kids fleece zip","kids plush jacket","kids fuzzy jacket","kids warm sweater","kids sherpa jacket","kids soft jacket","kids cozy zip up","kids lined cardigan"]
      },
      "å„¿ç«¥å«è¡£+æ¨ªå¹… (Hoodie Banner)": {
        enName: "Hoodie with Banner",
        layer1: ["kids hoodie","kids birthday hoodie","personalized kids hoodie","kids custom hoodie","kids party hoodie"],
        layer2: ["kids birthday outfit","kids celebration hoodie","kids party set","kids birthday banner set","kids gift hoodie","kids photo prop","kids special occasion hoodie"],
        layer3: ["kids novelty hoodie","kids personalized gift","kids birthday gift","kids celebration outfit","kids party outfit","kids holiday hoodie","kids keepsake hoodie"]
      }
    };

    // ========== Listingç”Ÿæˆå™¨ï¼šAI APIè°ƒç”¨ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰==========
    const callClaudeVisionAPI = async (prompt, systemPrompt, imageBase64, mimeType) => {
      const apiKey = getApiKey();
      if (!apiKey) throw new Error('è¯·å…ˆè®¾ç½® API Key');
      const content = [];
      if (imageBase64) {
        content.push({ type: "image", source: { type: "base64", media_type: mimeType, data: imageBase64 } });
      }
      content.push({ type: "text", text: prompt });
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey,
          "anthropic-version": "2023-06-01",
          "anthropic-dangerous-direct-browser-access": "true"
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-5-20250929",
          max_tokens: 4000,
          system: systemPrompt,
          messages: [{ role: "user", content }]
        })
      });
      const data = await response.json();
      if (data.error) throw new Error(data.error.message);
      return data.content.map(item => item.type === "text" ? item.text : "").join("\n");
    };

    // ========== Listingç”Ÿæˆå™¨ï¼šSearch Termså¤„ç† ==========
    const buildSearchTerms = (layer1, layer2, layer3) => {
      const seen = new Set();
      const words = [];
      const addWords = (phrases) => {
        phrases.forEach(phrase => {
          phrase.toLowerCase().split(/\s+/).forEach(w => {
            const clean = w.replace(/[^a-z0-9]/g, '');
            if (clean && !seen.has(clean)) {
              seen.add(clean);
              words.push(clean);
            }
          });
        });
      };
      addWords(layer1);
      addWords(layer2);
      addWords(layer3);
      let result = '';
      for (const w of words) {
        const candidate = result ? result + ' ' + w : w;
        if (candidate.length > 220) break; // é¢„ç•™30å­—ç¬¦ç»™AIè¿½åŠ å›¾æ¡ˆè¯
        result = candidate;
      }
      return result;
    };

    // ========== Listingç”Ÿæˆå™¨ï¼šä¸»ç»„ä»¶ ==========
    function ListingPage() {
      const [uploadedImages, setUploadedImages] = useState([]); // [{name, url, base64, mime}]
      const [selectedCategory, setSelectedCategory] = useState('');
      const [ageGroup, setAgeGroup] = useState('Toddler (2-5Y)');
      const [gender, setGender] = useState('Unisex');
      const [material, setMaterial] = useState('100% Cotton');
      const [generatedListings, setGeneratedListings] = useState([]);
      const [loading, setLoading] = useState(false);
      const [loadingIdx, setLoadingIdx] = useState(-1);
      const [error, setError] = useState('');
      const [aplusUrl, setAplusUrl] = useState(null);
      const [aplusLoading, setAplusLoading] = useState(false);
      const [coverUrl, setCoverUrl] = useState(null);
      const [coverLoading, setCoverLoading] = useState(false);
      const [aplusCfg, setAplusCfg] = useState({
        style:    'warm',       // warm | clean | dark | playful
        layout:   'auto',       // auto | grid2 | grid3 | grid4 | hero | banner
        textSlot: 'bullet1',    // bullet1 | bullet2 | title | custom
        customText: '',
        accentColor: '#D4724A',
        showBrand: true,
        brandText: 'Premium Quality Kids Clothing  âœ¦  Soft & Comfortable  âœ¦  Machine Washable',
        imgRatio:  0.64,        // image area height ratio in card
        radius:    16,          // card corner radius
        shadow:    true,
      });
      const [videoUrl, setVideoUrl] = useState(null);
      const [videoLoading, setVideoLoading] = useState(false);
      const [videoCfg, setVideoCfg] = useState({
        transition: 'fade',    // fade | slide | zoom | ken
        duration:   4,         // seconds per slide
        textAnim:   'typewriter', // typewriter | fadeup | none
        style:      'warm',    // warm | clean | dark | playful
        accentColor:'#D4724A',
        showTitle:  true,
        showBullet: true,
        showBrand:  true,
        brandText:  'Premium Kids Clothing',
        fps:        25,
      });

      const CATEGORIES = Object.keys(LISTING_KEYWORD_DB);
      const AGE_GROUPS = ['Newborn (0-2Y)', 'Toddler (2-5Y)', 'Little Kid (6-10Y)', 'Big Kid (11-14Y)'];
      const GENDERS = ['Boys', 'Girls', 'Unisex'];
      const MATERIALS = ['100% Cotton', 'Cotton Blend', 'Polyester', 'Organic Cotton', 'Fleece'];

      const handleImagesUpload = (e) => {
        const files = Array.from(e.target.files);
        const readers = files.map(file => new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const dataUrl = ev.target.result;
            const base64 = dataUrl.split(',')[1];
            const mime = file.type || 'image/jpeg';
            resolve({ name: file.name, url: dataUrl, base64, mime });
          };
          reader.readAsDataURL(file);
        }));
        Promise.all(readers).then(imgs => {
          setUploadedImages(prev => [...prev, ...imgs]);
          // Update stats: add pattern count
          try {
            const stats = S.g('weeklyStats') || {};
            stats.patterns = (stats.patterns || 0) + imgs.length;
            S.s('weeklyStats', stats);
          } catch(e) {}
        });
        e.target.value = '';
      };

      const removeImage = (idx) => {
        setUploadedImages(prev => prev.filter((_, i) => i !== idx));
        setGeneratedListings(prev => prev.filter((_, i) => i !== idx));
      };

      const generateOneListing = async (img, catKey, idx) => {
        const kw = LISTING_KEYWORD_DB[catKey];
        const l1 = kw.layer1.slice(0, 8).join(', ');
        const l2 = kw.layer2.slice(0, 10).join(', ');
        const l3 = kw.layer3.slice(0, 8).join(', ');
        const searchTermsBase = buildSearchTerms(kw.layer1, kw.layer2, kw.layer3);

        const systemPrompt = `You are an expert Amazon Listing copywriter for children's clothing. You write high-converting, SEO-optimized listings following strict templates. Always output valid JSON only, no markdown, no extra text.`;

        const prompt = `Analyze this children's clothing product image and generate an Amazon listing.

PRODUCT INFO:
- Category: ${catKey} (English: ${kw.enName})
- Age Group: ${ageGroup}
- Gender: ${gender}
- Material: ${material}

KEYWORD LAYERS (use these):
Layer 1 - MUST appear in Title & Bullets: ${l1}
Layer 2 - Use in Bullets & Description: ${l2}
Layer 3 - Only for Search Terms: ${l3}

STRICT TEMPLATE RULES:

TITLE (max 150 chars):
[Core Layer1 keyword] [spec] â€“ Designed for [main use case], [core benefit], [extra advantage]
Example: Kids Onesie Pajamas Fleece â€“ Designed for Cozy Sleep & Winter Play, Keeps Warm All Night, Zip-Up Easy Wear ${ageGroup}

BULLET POINTS (exactly 5, structure: Emoji + Scenario/Condition + Problem â†’ Solution + Result):
Each bullet 50-100 chars. Use Layer1 & Layer2 keywords naturally.
1. Material/comfort with relevant emoji
2. Design feature matching what you see in the image
3. Use scenario with relevant emoji
4. Care/durability with ğŸ§º
5. Size/fit with ğŸ“

DESCRIPTION (HTML, exactly 3 paragraphs):
<p><b>Who It's For:</b> [product] designed for [target audience] who need [solution]. Perfect for [use case].</p>
<br>
<p><b>How to Use:</b> Commonly used during [real scenarios]. Kids love wearing it when [activities]. Parents appreciate [practical benefits].</p>
<br>
<p><b>Why Choose This:</b> Compared to basic [category], this features [key differences]. Made from [material] that [advantages].</p>

SEARCH TERMS RULES (CRITICAL - strictly enforce):
- Words separated by SINGLE SPACE only â€” NO commas, no comma+space.
- You may insert 2-3 image-specific single words (pattern/color theme) right after the first 3 base words.
- HARD LIMIT: The final searchTerms string MUST be 250 characters or fewer. Count characters before outputting.
- If adding extra words would exceed 250 chars, do NOT add them. Trim from the end.
- Single words only â€” no multi-word phrases.
Pre-built base (space-separated, already ordered by priority):
${searchTermsBase}

OUTPUT FORMAT (JSON only, no markdown):
{
  "title": "...",
  "bullets": ["bullet1", "bullet2", "bullet3", "bullet4", "bullet5"],
  "description": "<p><b>Who It's For:</b>...</p><br><p><b>How to Use:</b>...</p><br><p><b>Why Choose This:</b>...</p>",
  "searchTerms": "...",
  "detectedPattern": "brief description of the graphic/pattern you see in the image"
}`;

        const result = await callClaudeVisionAPI(prompt, systemPrompt, img.base64, img.mime);
        const cleaned = result.replace(/```json|```/g, '').trim();
        const parsed = JSON.parse(cleaned);

        // â”€â”€ å¼ºåˆ¶æˆªæ–­ searchTerms åˆ° 250 å­—ç¬¦ï¼ˆæŒ‰è¯è¾¹ç•Œæˆªæ–­ï¼Œç©ºæ ¼åˆ†éš”ï¼‰â”€â”€
        if (parsed.searchTerms && parsed.searchTerms.length > 250) {
          const words = parsed.searchTerms.split(/[\s,]+/).map(w => w.trim()).filter(Boolean);
          let st = '';
          for (const w of words) {
            const candidate = st ? st + ' ' + w : w;
            if (candidate.length > 250) break;
            st = candidate;
          }
          parsed.searchTerms = st;
        } else if (parsed.searchTerms) {
          // ç»Ÿä¸€æ ¼å¼ï¼šå°†ä»»ä½•é€—å·åˆ†éš”è½¬ä¸ºç©ºæ ¼åˆ†éš”
          parsed.searchTerms = parsed.searchTerms.split(/[\s,]+/).map(w => w.trim()).filter(Boolean).join(' ').slice(0, 250);
        }

        return { ...parsed, imageName: img.name, imageUrl: img.url };
      };

      // â”€â”€ A+å›¾ç‰‡ç”Ÿæˆï¼ˆCanvasï¼Œ970Ã—600ï¼Œæš–è‰²è°ƒç”Ÿæ´»åœºæ™¯ï¼‰â”€â”€
      const generateAplus = async () => {
        const validListings = generatedListings.filter(l => !l.error && l.imageUrl);
        if (!validListings.length) return;
        setAplusLoading(true);
        setAplusUrl(null);

        const W = 970, H = 600;
        const canvas = document.createElement('canvas');
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        const cfg = aplusCfg;
        const count = Math.min(validListings.length, 4);

        // â”€â”€ THEME â”€â”€
        const THEMES = {
          warm:    { bg0:'#FDF6EE', bg1:'#F5E6D0', accent: cfg.accentColor, cardBg:'#FFFFFF', subCardBg:'#FFF9F4', textDark:'#2D1A0A', textMid:'#7A4A28', textLight:'#B8896A', divider:'rgba(200,140,80,0.18)', barStart: cfg.accentColor, barEnd:'#A0522D' },
          clean:   { bg0:'#F4F7FF', bg1:'#E8EFFF', accent: cfg.accentColor, cardBg:'#FFFFFF', subCardBg:'#F7F9FF', textDark:'#0F2359', textMid:'#3B5BDB', textLight:'#7B93CC', divider:'rgba(100,140,255,0.15)', barStart: cfg.accentColor, barEnd:'#2244BB' },
          dark:    { bg0:'#101828', bg1:'#1C2E4A', accent: cfg.accentColor, cardBg:'#1A2740', subCardBg:'#162035', textDark:'#E8F0FF', textMid:'#90B4D8', textLight:'#557799', divider:'rgba(80,130,200,0.2)',  barStart: cfg.accentColor, barEnd:'#0A1628' },
          playful: { bg0:'#FFF0F8', bg1:'#F0ECFF', accent: cfg.accentColor, cardBg:'#FFFFFF', subCardBg:'#FFF5FC', textDark:'#3A1050', textMid:'#8B3AB0', textLight:'#C07FD8', divider:'rgba(180,100,220,0.15)', barStart: cfg.accentColor, barEnd:'#8B00AA' },
        };
        const T = THEMES[cfg.style] || THEMES.warm;

        // â”€â”€ BACKGROUND â”€â”€
        const bgG = ctx.createLinearGradient(0, 0, W, H);
        bgG.addColorStop(0, T.bg0); bgG.addColorStop(1, T.bg1);
        ctx.fillStyle = bgG; ctx.fillRect(0, 0, W, H);

        // â”€â”€ HELPERS â”€â”€
        const BAR_H  = cfg.showBrand ? 44 : 0;
        const PAD    = 14;
        const USABLE_H = H - BAR_H - PAD * 2;
        const TOP    = PAD;

        const loadImg = src => new Promise(res => {
          const i = new Image(); i.crossOrigin = 'anonymous';
          i.onload = () => res(i); i.onerror = () => res(null); i.src = src;
        });

        const clipRect = (x, y, w, h, r, fn) => {
          ctx.save(); ctx.beginPath();
          ctx.roundRect(x, y, w, h, r); ctx.clip(); fn(); ctx.restore();
        };

        const drawImg = (img, x, y, w, h) => {
          if (!img) { ctx.fillStyle = T.divider; ctx.fillRect(x, y, w, h); return; }
          const sc = Math.max(w / img.width, h / img.height);
          ctx.drawImage(img, x + (w - img.width * sc) / 2, y + (h - img.height * sc) / 2, img.width * sc, img.height * sc);
        };

        const shadow = (x, y, w, h, r) => {
          if (!cfg.shadow) return;
          ctx.save();
          ctx.shadowColor = cfg.style === 'dark' ? 'rgba(0,0,0,0.55)' : 'rgba(120,80,30,0.16)';
          ctx.shadowBlur = 18; ctx.shadowOffsetY = 5;
          ctx.beginPath(); ctx.roundRect(x, y, w, h, r);
          ctx.fillStyle = T.cardBg; ctx.fill(); ctx.restore();
        };

        const wrapText = (text, x, y, maxW, lineH, maxLines, color, font) => {
          if (!text) return y;
          ctx.fillStyle = color; ctx.font = font; ctx.textAlign = 'left';
          const words = text.split(' '); let line = '', cy = y, lc = 0;
          for (let i = 0; i < words.length; i++) {
            const test = line ? line + ' ' + words[i] : words[i];
            if (ctx.measureText(test).width > maxW && line) {
              if (lc >= maxLines - 1) { ctx.fillText(line + (i < words.length - 1 ? 'â€¦' : ''), x, cy); return cy + lineH; }
              ctx.fillText(line, x, cy); line = words[i]; cy += lineH; lc++;
            } else line = test;
          }
          ctx.fillText(line, x, cy); return cy + lineH;
        };

        // â”€â”€ EXTRACT UNIQUE CONTENT per card â”€â”€
        const getCardContent = (listing, cardRole) => {
          const cleanBullet = b => (b || '').replace(/[\u{1F000}-\u{1FFFF}]/gu, '').replace(/^[\sâ€¢:ï¼š\-]+/, '').trim();
          const titleFull   = (listing.title || '').split('â€“')[0].trim();
          const bullets     = (listing.bullets || []).map(cleanBullet);

          // Each card role shows a DIFFERENT bullet â€” no repetition
          const roles = {
            hero:     { label: 'COLLECTION',  headline: titleFull,          body: bullets[0] || '' },
            comfort:  { label: 'âœ¦ COMFORT',   headline: 'Soft & Comfortable', body: bullets[0] || '' },
            style:    { label: 'âœ¦ STYLE',     headline: 'Designed to Stand Out', body: bullets[1] || bullets[0] || '' },
            occasion: { label: 'âœ¦ OCCASION',  headline: 'Perfect for Every Moment', body: bullets[2] || bullets[1] || '' },
            care:     { label: 'âœ¦ EASY CARE', headline: 'Built to Last',    body: bullets[3] || bullets[2] || '' },
            size:     { label: 'âœ¦ FIT',       headline: 'True-to-Size Fit', body: bullets[4] || bullets[3] || '' },
          };
          return roles[cardRole] || roles.hero;
        };

        const imgs = await Promise.all(validListings.slice(0, 4).map(l => loadImg(l.imageUrl)));

        const R = cfg.radius;

        // â”€â”€ LAYOUT ENGINE â”€â”€
        const layout = cfg.layout === 'auto'
          ? (count === 1 ? 'hero' : count === 2 ? 'grid2' : count === 3 ? 'editorial' : 'magazine')
          : cfg.layout;

        // â”€â”€ DRAW CARD (mini) â”€â”€
        const drawCard = (img, listing, role, x, y, w, h, imgRatioOverride) => {
          const imgR = imgRatioOverride !== undefined ? imgRatioOverride : cfg.imgRatio;
          const imgH = Math.round(h * imgR);
          const txtH = h - imgH;
          const content = getCardContent(listing, role);

          shadow(x, y, w, h, R);
          // image
          clipRect(x, y, w, imgH, [R, R, 0, 0], () => drawImg(img, x, y, w, imgH));
          // text zone
          ctx.beginPath(); ctx.roundRect(x, y + imgH, w, txtH, [0, 0, R, R]);
          ctx.fillStyle = T.cardBg; ctx.fill();

          // accent top stripe
          ctx.fillStyle = T.accent;
          ctx.fillRect(x, y + imgH, w, 3);

          // label pill
          const lbSz = Math.max(7, Math.round(w * 0.026));
          ctx.fillStyle = T.accent + '22';
          ctx.beginPath(); ctx.roundRect(x + 10, y + imgH + 8, ctx.measureText(content.label).width + 14, lbSz + 8, 4); ctx.fill();
          ctx.fillStyle = T.accent; ctx.font = `bold ${lbSz}px 'Arial', sans-serif`; ctx.textAlign = 'left';
          ctx.fillText(content.label, x + 17, y + imgH + 8 + lbSz + 1);

          // body text only â€” no repeating headline
          const bSz = Math.max(8, Math.round(w * 0.027));
          wrapText(content.body, x + 10, y + imgH + lbSz + 22, w - 20, bSz * 1.45, 2, T.textMid, `${bSz}px Georgia,serif`);
        };

        // â”€â”€ HERO CARD (large, left panel) â”€â”€
        const drawHeroCard = (img, listing, x, y, w, h) => {
          const content = getCardContent(listing, 'hero');
          shadow(x, y, w, h, R + 2);
          clipRect(x, y, w, h, R + 2, () => {
            drawImg(img, x, y, w, h);
            // dark gradient from bottom
            const grd = ctx.createLinearGradient(x, y + h * 0.45, x, y + h);
            grd.addColorStop(0, 'rgba(0,0,0,0)');
            grd.addColorStop(1, 'rgba(0,0,0,0.72)');
            ctx.fillStyle = grd; ctx.fillRect(x, y, w, h);
          });

          // SERIES label top-left
          const pill = 'NEW COLLECTION';
          ctx.fillStyle = T.accent;
          ctx.beginPath(); ctx.roundRect(x + 14, y + 14, ctx.measureText(pill).width + 20, 24, 6); ctx.fill();
          ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Arial,sans-serif'; ctx.textAlign = 'left';
          ctx.fillText(pill, x + 24, y + 30);

          // Big headline
          const hSz = Math.max(14, Math.round(w * 0.044));
          wrapText(content.headline, x + 14, y + h - 62, w - 28, hSz * 1.2, 2, '#FFFFFF', `bold ${hSz}px Georgia,serif`);

          // Subline
          const sSz = Math.max(9, Math.round(w * 0.028));
          wrapText(content.body, x + 14, y + h - 28, w - 28, sSz * 1.4, 1, 'rgba(255,255,255,0.78)', `${sSz}px Georgia,serif`);

          // accent bar left edge
          ctx.fillStyle = T.accent;
          ctx.beginPath(); ctx.roundRect(x, y + h * 0.45, 4, h * 0.55, [0, 0, 0, R + 2]); ctx.fill();
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: MAGAZINE (1 hero left + 3 right col)
        // Best for 3â€“4 images â€” avoids repetition
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (layout === 'magazine' || layout === 'hero') {
          const heroW = Math.round(W * 0.46);
          const rightW = W - heroW - PAD * 3;
          const subH = count >= 3 ? Math.floor((USABLE_H - PAD * 2) / 3) : Math.floor(USABLE_H / 2);
          const roles = ['comfort', 'style', 'occasion', 'care'];

          // Hero left
          drawHeroCard(imgs[0], validListings[0], PAD, TOP, heroW, USABLE_H);

          // Right column â€” each card gets a DIFFERENT role/bullet
          for (let i = 1; i < Math.min(count, 4); i++) {
            const ry = TOP + (i - 1) * (subH + PAD);
            const rh = i === count - 1 ? (USABLE_H - (i - 1) * (subH + PAD)) : subH;
            drawCard(imgs[i], validListings[i], roles[i - 1], PAD * 2 + heroW, ry, rightW, rh, 0.52);
          }

          // If only 1 img: hero full width
          if (count === 1) drawHeroCard(imgs[0], validListings[0], PAD, TOP, W - PAD * 2, USABLE_H);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: EDITORIAL (1 top wide + 2 bottom)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (layout === 'editorial') {
          const topH = Math.round(USABLE_H * 0.52);
          const botH = USABLE_H - topH - PAD;
          const halfW = Math.floor((W - PAD * 3) / 2);

          drawHeroCard(imgs[0], validListings[0], PAD, TOP, W - PAD * 2, topH);
          drawCard(imgs[1] || imgs[0], validListings[1] || validListings[0], 'comfort', PAD, TOP + topH + PAD, halfW, botH, 0.55);
          drawCard(imgs[2] || imgs[0], validListings[2] || validListings[0], 'style',   PAD * 2 + halfW, TOP + topH + PAD, halfW, botH, 0.55);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: GRID2
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (layout === 'grid2') {
          const hw = Math.floor((W - PAD * 3) / 2);
          drawCard(imgs[0], validListings[0], 'comfort', PAD,          TOP, hw, USABLE_H, 0.62);
          drawCard(imgs[1] || imgs[0], validListings[1] || validListings[0], 'style', PAD * 2 + hw, TOP, hw, USABLE_H, 0.62);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: GRID3
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (layout === 'grid3') {
          const tw = Math.floor((W - PAD * 4) / 3);
          const roles3 = ['comfort', 'style', 'occasion'];
          for (let i = 0; i < 3; i++)
            drawCard(imgs[i] || imgs[0], validListings[i] || validListings[0], roles3[i], PAD + i * (tw + PAD), TOP, tw, USABLE_H, 0.60);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: GRID4
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (layout === 'grid4') {
          const hw = Math.floor((W - PAD * 3) / 2);
          const hh = Math.floor((USABLE_H - PAD) / 2);
          const roles4 = ['comfort', 'style', 'occasion', 'care'];
          [[0,0],[1,0],[0,1],[1,1]].forEach(([ci, ri], idx) => {
            drawCard(imgs[idx] || imgs[0], validListings[idx] || validListings[0], roles4[idx],
              PAD + ci * (hw + PAD), TOP + ri * (hh + PAD), hw, hh, 0.56);
          });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LAYOUT: BANNER (horizontal strip)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        else if (layout === 'banner') {
          const n = Math.min(count, 4);
          const bw = Math.floor((W - PAD * (n + 1)) / n);
          const roles_b = ['comfort', 'style', 'occasion', 'care'];
          for (let i = 0; i < n; i++)
            drawCard(imgs[i] || imgs[0], validListings[i] || validListings[0], roles_b[i], PAD + i * (bw + PAD), TOP, bw, USABLE_H, 0.60);
        }

        // â”€â”€ BRAND BAR â”€â”€
        if (cfg.showBrand) {
          const barG = ctx.createLinearGradient(0, H - BAR_H, W, H);
          barG.addColorStop(0, T.barStart); barG.addColorStop(1, T.barEnd);
          ctx.fillStyle = barG; ctx.fillRect(0, H - BAR_H, W, BAR_H);
          // accent line top of bar
          ctx.fillStyle = 'rgba(255,255,255,0.25)'; ctx.fillRect(0, H - BAR_H, W, 1);
          ctx.fillStyle = 'rgba(255,255,255,0.92)';
          ctx.font = 'bold 13px Georgia,serif'; ctx.textAlign = 'center';
          ctx.fillText('âœ¦  ' + cfg.brandText + '  âœ¦', W / 2, H - 14);
        }

        setAplusUrl(canvas.toDataURL('image/png'));
        setAplusLoading(false);
      };

      // â”€â”€ ç³»åˆ—å°é¢å›¾ç”Ÿæˆï¼ˆæ‰€æœ‰æ¬¾å¼é›†ä¸­ + äº§å“å + å–ç‚¹ï¼‰â”€â”€
      const generateCover = async () => {
        const valid = generatedListings.filter(l => !l.error && l.imageUrl);
        if (!valid.length) return;
        setCoverLoading(true); setCoverUrl(null);

        const W = 1200, H = 800;
        const canvas = document.createElement('canvas');
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        const cfg = aplusCfg;

        const THEMES = {
          warm:    { bg0:'#FDF6EE', bg1:'#F0DFC0', accent:cfg.accentColor, dark:'#2D1A0A', mid:'#7A4A28', light:'#C8976A', card:'#FFFFFF', badge:'rgba(212,114,74,0.12)' },
          clean:   { bg0:'#F0F4FF', bg1:'#D8E4FF', accent:cfg.accentColor, dark:'#0D1F4A', mid:'#3B5BDB', light:'#7B9EE8', card:'#FFFFFF', badge:'rgba(59,91,219,0.10)' },
          dark:    { bg0:'#0A1020', bg1:'#162030', accent:cfg.accentColor, dark:'#E8F0FF', mid:'#90B4D8', light:'#557090', card:'#1A2740', badge:'rgba(74,158,255,0.15)' },
          playful: { bg0:'#FFF0F8', bg1:'#EDE0FF', accent:cfg.accentColor, dark:'#3A0E50', mid:'#8B3AB0', light:'#C07FD8', card:'#FFFFFF', badge:'rgba(192,107,216,0.12)' },
        };
        const T = THEMES[cfg.style] || THEMES.warm;

        // Background
        const bgG = ctx.createLinearGradient(0, 0, W, H);
        bgG.addColorStop(0, T.bg0); bgG.addColorStop(1, T.bg1);
        ctx.fillStyle = bgG; ctx.fillRect(0, 0, W, H);

        // Subtle grid texture
        ctx.strokeStyle = cfg.style === 'dark' ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.03)';
        ctx.lineWidth = 1;
        for (let gx = 0; gx < W; gx += 60) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, H); ctx.stroke(); }
        for (let gy = 0; gy < H; gy += 60) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(W, gy); ctx.stroke(); }

        // Decorative corner blobs
        const blob = (x, y, r, a) => {
          const g = ctx.createRadialGradient(x, y, 0, x, y, r);
          g.addColorStop(0, T.accent + Math.round(a * 255).toString(16).padStart(2,'0'));
          g.addColorStop(1, 'transparent');
          ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        };
        blob(0, 0, 280, 0.12); blob(W, H, 300, 0.10); blob(W*0.5, 0, 200, 0.06);

        const loadImg = src => new Promise(res => {
          const i = new Image(); i.crossOrigin = 'anonymous';
          i.onload = () => res(i); i.onerror = () => res(null); i.src = src;
        });
        const imgs = await Promise.all(valid.map(l => loadImg(l.imageUrl)));

        const cleanBullet = b => (b || '').replace(/[\u{1F000}-\u{1FFFF}]/gu, '').replace(/^[\sâ€¢âœ¦:ï¼š\-]+/, '').trim();

        // â”€â”€ LAYOUT â”€â”€
        // Top: header strip (logo/title area)  ~120px
        // Middle: product grid                 ~550px
        // Bottom: key selling points bar       ~130px

        const HEADER_H = 118;
        const FOOTER_H = 128;
        const GRID_Y = HEADER_H + 12;
        const GRID_H = H - HEADER_H - FOOTER_H - 24;
        const PAD = 16;

        // â”€â”€ HEADER â”€â”€
        // Accent left bar
        ctx.fillStyle = T.accent;
        ctx.beginPath(); ctx.roundRect(PAD, 18, 6, HEADER_H - 36, 3); ctx.fill();

        // Series / collection label
        const catName = selectedCategory ? selectedCategory.split('(').pop().replace(')', '').trim() : 'Kids Collection';
        ctx.fillStyle = T.accent; ctx.font = 'bold 13px Arial,sans-serif'; ctx.textAlign = 'left';
        ctx.fillText('âœ¦  PRODUCT SERIES', PAD + 20, 42);

        // Main title
        ctx.fillStyle = T.dark; ctx.font = `bold 36px Georgia,serif`;
        ctx.fillText(catName, PAD + 20, 84);

        // Subtitle
        ctx.fillStyle = T.mid; ctx.font = `15px Georgia,serif`;
        ctx.fillText(`${valid.length} Color Variants  Â·  ${ageGroup}  Â·  ${gender}`, PAD + 20, 108);

        // Right: item count badge
        const badgeX = W - 110, badgeY = 30;
        ctx.fillStyle = T.badge;
        ctx.beginPath(); ctx.roundRect(badgeX, badgeY, 90, 70, 12); ctx.fill();
        ctx.strokeStyle = T.accent + '44'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.roundRect(badgeX, badgeY, 90, 70, 12); ctx.stroke();
        ctx.fillStyle = T.accent; ctx.font = `bold 32px Georgia,serif`; ctx.textAlign = 'center';
        ctx.fillText(valid.length, badgeX + 45, badgeY + 44);
        ctx.fillStyle = T.mid; ctx.font = `11px Arial,sans-serif`;
        ctx.fillText('STYLES', badgeX + 45, badgeY + 62);

        // Divider line
        ctx.strokeStyle = T.accent + '30'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(PAD, HEADER_H); ctx.lineTo(W - PAD, HEADER_H); ctx.stroke();

        // â”€â”€ PRODUCT GRID â”€â”€
        const n = Math.min(valid.length, 6);
        const cols = n <= 2 ? n : n <= 4 ? 4 : Math.min(n, 6);
        const cardW = Math.floor((W - PAD * (cols + 1)) / cols);
        const cardH = GRID_H;
        const imgH  = Math.round(cardH * 0.72);
        const txtH  = cardH - imgH;

        for (let i = 0; i < n; i++) {
          const cx = PAD + i * (cardW + PAD);
          const cy = GRID_Y;
          const img = imgs[i];
          const listing = valid[i];

          // Card shadow
          if (cfg.shadow) {
            ctx.save();
            ctx.shadowColor = cfg.style === 'dark' ? 'rgba(0,0,0,0.6)' : 'rgba(100,60,20,0.18)';
            ctx.shadowBlur = 16; ctx.shadowOffsetY = 6;
            ctx.beginPath(); ctx.roundRect(cx, cy, cardW, cardH, cfg.radius);
            ctx.fillStyle = T.card; ctx.fill(); ctx.restore();
          } else {
            ctx.beginPath(); ctx.roundRect(cx, cy, cardW, cardH, cfg.radius);
            ctx.fillStyle = T.card; ctx.fill();
          }

          // Product image
          ctx.save(); ctx.beginPath();
          ctx.roundRect(cx, cy, cardW, imgH, [cfg.radius, cfg.radius, 0, 0]); ctx.clip();
          if (img) {
            const sc = Math.max(cardW / img.width, imgH / img.height);
            ctx.drawImage(img, cx + (cardW - img.width*sc)/2, cy + (imgH - img.height*sc)/2, img.width*sc, img.height*sc);
          } else { ctx.fillStyle = '#e5e7eb'; ctx.fillRect(cx, cy, cardW, imgH); }
          // Subtle bottom fade
          const fadeG = ctx.createLinearGradient(cx, cy + imgH*0.6, cx, cy + imgH);
          fadeG.addColorStop(0, 'rgba(0,0,0,0)'); fadeG.addColorStop(1, 'rgba(0,0,0,0.18)');
          ctx.fillStyle = fadeG; ctx.fillRect(cx, cy, cardW, imgH);
          ctx.restore();

          // Accent top stripe on text area
          ctx.fillStyle = T.accent;
          ctx.fillRect(cx, cy + imgH, cardW, 3);

          // Text zone bg
          ctx.beginPath(); ctx.roundRect(cx, cy + imgH + 3, cardW, txtH - 3, [0, 0, cfg.radius, cfg.radius]);
          ctx.fillStyle = T.card; ctx.fill();

          // Variant number badge (top-right of image)
          const numBadgeSize = 26;
          ctx.fillStyle = T.accent;
          ctx.beginPath(); ctx.roundRect(cx + cardW - numBadgeSize - 6, cy + 6, numBadgeSize, numBadgeSize, 6); ctx.fill();
          ctx.fillStyle = '#fff'; ctx.font = `bold 12px Arial,sans-serif`; ctx.textAlign = 'center';
          ctx.fillText(`#${i+1}`, cx + cardW - numBadgeSize/2 - 6, cy + 23);

          // Product title â€” shortened
          const titleWords = ((listing.title || '').split('â€“')[0].trim()).split(' ').slice(0, 5).join(' ');
          const tSz = Math.max(8, Math.round(cardW * 0.056));
          ctx.fillStyle = T.dark; ctx.font = `bold ${tSz}px Georgia,serif`; ctx.textAlign = 'left';
          // wrap 2 lines
          const titleY = cy + imgH + tSz + 10;
          const tw = cardW - 16;
          const titleWords2 = (listing.title || '').split('â€“')[0].trim();
          let line = '', lineY = titleY, lc = 0;
          titleWords2.split(' ').forEach(w => {
            const test = line ? line + ' ' + w : w;
            if (ctx.measureText(test).width > tw && line && lc < 1) {
              ctx.fillText(line, cx + 8, lineY); line = w; lineY += tSz * 1.3; lc++;
            } else line = test;
          });
          ctx.fillText(lc < 1 ? (line.length > 22 ? line.slice(0,20)+'â€¦' : line) : (line.length > 22 ? line.slice(0,20)+'â€¦' : line), cx + 8, lineY);
        }

        // â”€â”€ FOOTER: Key Selling Points â”€â”€
        const FOOT_Y = H - FOOTER_H;
        // Footer bg
        const footG = ctx.createLinearGradient(0, FOOT_Y, W, H);
        footG.addColorStop(0, T.accent + 'EE'); footG.addColorStop(1, T.accent + 'CC');
        ctx.fillStyle = footG; ctx.fillRect(0, FOOT_Y, W, FOOTER_H);
        // top edge line
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(0, FOOT_Y, W, 1);

        // Pull top 3 bullets from first listing
        const firstListing = valid[0];
        const keyPoints = [
          cleanBullet(firstListing.bullets?.[0]),
          cleanBullet(firstListing.bullets?.[1]),
          cleanBullet(firstListing.bullets?.[2]),
        ].filter(Boolean);

        const pointW = Math.floor(W / keyPoints.length);
        keyPoints.forEach((pt, pi) => {
          const px = pi * pointW;
          // divider
          if (pi > 0) { ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(px, FOOT_Y + 20, 1, FOOTER_H - 40); }
          // icon circle
          const icons = ['âœ¦', 'â—ˆ', 'â‹'];
          ctx.fillStyle = 'rgba(255,255,255,0.25)';
          ctx.beginPath(); ctx.arc(px + 36, FOOT_Y + 38, 18, 0, Math.PI*2); ctx.fill();
          ctx.fillStyle = '#fff'; ctx.font = `bold 16px Georgia,serif`; ctx.textAlign = 'center';
          ctx.fillText(icons[pi] || 'âœ¦', px + 36, FOOT_Y + 44);
          // text
          const ptSz = Math.max(10, Math.round(pointW * 0.032));
          ctx.font = `${ptSz}px Georgia,serif`; ctx.textAlign = 'left';
          ctx.fillStyle = '#fff';
          const ptX = px + 62, ptMaxW = pointW - 72;
          let ptLine = '', ptY = FOOT_Y + 32, ptLc = 0;
          pt.split(' ').forEach(w => {
            const test = ptLine ? ptLine + ' ' + w : w;
            if (ctx.measureText(test).width > ptMaxW && ptLine && ptLc < 2) {
              ctx.fillText(ptLine, ptX, ptY); ptLine = w; ptY += ptSz * 1.4; ptLc++;
            } else ptLine = test;
          });
          ctx.fillText(ptLine, ptX, ptY);
        });

        setCoverUrl(canvas.toDataURL('image/png'));
        setCoverLoading(false);
      };

      const generateVideo = async () => {
        const valid = generatedListings.filter(l => !l.error && l.imageUrl);
        if (!valid.length) return;
        setVideoLoading(true);
        setVideoUrl(null);

        const W = 1280, H = 720;
        const cfg = videoCfg;
        const FPS = cfg.fps;
        const SLIDE_FRAMES = cfg.duration * FPS;
        const TRANS_FRAMES = Math.round(FPS * 0.6);

        const THEMES = {
          warm:    { bg: ['#FFF8F0','#FFE4C0'], text: '#7A3A10', accent: cfg.accentColor, card: '#FFFFFF', overlay: 'rgba(255,220,170,0.55)' },
          clean:   { bg: ['#F0F4FF','#E4ECFF'], text: '#1e3a6e', accent: cfg.accentColor, card: '#FFFFFF', overlay: 'rgba(200,220,255,0.5)' },
          dark:    { bg: ['#0f1c35','#1a2f55'], text: '#c8dff5', accent: cfg.accentColor, card: '#162035', overlay: 'rgba(10,20,50,0.65)' },
          playful: { bg: ['#FFF0F8','#F0F0FF'], text: '#5a1e6e', accent: cfg.accentColor, card: '#FFFFFF', overlay: 'rgba(255,200,230,0.5)' },
        };
        const T = THEMES[cfg.style] || THEMES.warm;

        const canvas = document.createElement('canvas');
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');

        // load images
        const loadImg = src => new Promise(res => {
          const i = new Image(); i.crossOrigin = 'anonymous';
          i.onload = () => res(i); i.onerror = () => res(null); i.src = src;
        });
        const imgs = await Promise.all(valid.map(l => loadImg(l.imageUrl)));

        // text wrap helper
        const wrap = (text, x, y, maxW, lh, maxL) => {
          if (!text) return 0;
          const words = text.split(' '); let line = '', lc = 0, cy = y;
          for (let i = 0; i < words.length; i++) {
            const test = line ? line + ' ' + words[i] : words[i];
            if (ctx.measureText(test).width > maxW && line) {
              if (lc >= maxL - 1) { ctx.fillText(line + (i < words.length-1 ? 'â€¦' : ''), x, cy); lc++; return lc; }
              ctx.fillText(line, x, cy); line = words[i]; cy += lh; lc++;
            } else line = test;
          }
          ctx.fillText(line, x, cy); lc++;
          return lc;
        };

        // draw background
        const drawBg = () => {
          const g = ctx.createLinearGradient(0, 0, W, H);
          g.addColorStop(0, T.bg[0]); g.addColorStop(1, T.bg[1]);
          ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);
          // subtle dots pattern
          ctx.fillStyle = cfg.style === 'dark' ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.025)';
          for (let dx = 0; dx < W; dx += 40) for (let dy = 0; dy < H; dy += 40) {
            ctx.beginPath(); ctx.arc(dx, dy, 1.5, 0, Math.PI*2); ctx.fill();
          }
        };

        // draw one slide frame: t=0..1 = within slide, trans=-1..0 = exit, 0..1 = enter
        const drawFrame = (imgIdx, t, transT, transDir) => {
          const img = imgs[imgIdx];
          const listing = valid[imgIdx];
          const bullet = ((listing.bullets && listing.bullets[0]) || '')
            .replace(/[\u{1F000}-\u{1FFFF}]/gu, '').replace(/^[\sâ€¢:ï¼š]+/, '').trim();
          const titleText = (listing.title || '').split('â€“')[0].trim();

          drawBg();

          ctx.save();

          // â”€â”€ transition â”€â”€
          if (cfg.transition === 'fade' && transT !== null) {
            ctx.globalAlpha = transDir === 'in' ? transT : 1 - transT;
          } else if (cfg.transition === 'slide' && transT !== null) {
            const offset = transDir === 'in' ? (1 - transT) * W : -transT * W;
            ctx.translate(offset, 0);
          } else if (cfg.transition === 'zoom' && transT !== null) {
            const sc = transDir === 'in' ? 0.88 + transT * 0.12 : 1 + transT * 0.08;
            ctx.translate(W/2, H/2); ctx.scale(sc, sc); ctx.translate(-W/2, -H/2);
            ctx.globalAlpha = transDir === 'in' ? transT : 1 - transT;
          }

          // â”€â”€ IMAGE PANEL (left 52%) â”€â”€
          const imgW = Math.round(W * 0.52), imgH = H;
          if (img) {
            ctx.save();
            ctx.beginPath(); ctx.rect(0, 0, imgW, imgH); ctx.clip();

            // ken burns effect
            let sc2 = 1, ox = 0, oy = 0;
            if (cfg.transition === 'ken') {
              sc2 = 1 + t * 0.06;
              ox = t * 20; oy = t * 10;
            }
            const sc3 = Math.max(imgW / img.width, imgH / img.height) * sc2;
            ctx.drawImage(img, (imgW - img.width*sc3)/2 - ox, (imgH - img.height*sc3)/2 - oy, img.width*sc3, img.height*sc3);

            // gradient overlay onto text side
            const ol = ctx.createLinearGradient(imgW*0.55, 0, imgW, 0);
            ol.addColorStop(0, 'rgba(0,0,0,0)'); ol.addColorStop(1, T.overlay);
            ctx.fillStyle = ol; ctx.fillRect(0, 0, imgW, imgH);
            ctx.restore();
          }

          // â”€â”€ TEXT PANEL (right 48%) â”€â”€
          const txX = imgW + 40, txW = W - imgW - 60;
          const midY = H * 0.5;

          // accent vertical bar
          ctx.fillStyle = T.accent;
          ctx.beginPath(); ctx.roundRect(txX - 20, midY - 140, 5, 280, 3); ctx.fill();

          // typewriter / fadeup effect
          const textProgress = cfg.textAnim === 'none' ? 1 : Math.min(1, t * 2.2);

          if (cfg.showTitle) {
            ctx.globalAlpha = (ctx.globalAlpha || 1);
            const titleAlpha = cfg.textAnim === 'fadeup' ? Math.min(1, t * 3) : 1;
            ctx.save(); ctx.globalAlpha *= titleAlpha;
            if (cfg.textAnim === 'fadeup') ctx.translate(0, (1 - titleAlpha) * 18);
            ctx.fillStyle = T.accent;
            ctx.font = 'bold 16px Georgia, serif';
            ctx.fillText('PRODUCT HIGHLIGHT', txX, midY - 115);

            ctx.fillStyle = cfg.style === 'dark' ? '#ffffff' : '#1a1a1a';
            ctx.font = 'bold 30px Georgia, serif';
            // typewriter: show chars
            const dispTitle = cfg.textAnim === 'typewriter'
              ? titleText.slice(0, Math.floor(textProgress * titleText.length))
              : titleText;
            wrap(dispTitle, txX, midY - 80, txW, 38, 3);
            ctx.restore();
          }

          if (cfg.showBullet) {
            const bulletAlpha = cfg.textAnim === 'fadeup' ? Math.min(1, Math.max(0, t * 3 - 0.4)) : 1;
            ctx.save(); ctx.globalAlpha *= bulletAlpha;
            if (cfg.textAnim === 'fadeup') ctx.translate(0, (1 - bulletAlpha) * 14);
            ctx.fillStyle = T.text;
            ctx.font = '18px Georgia, serif';
            const dispBullet = cfg.textAnim === 'typewriter'
              ? bullet.slice(0, Math.floor(Math.max(0, textProgress * 2 - 1) * bullet.length))
              : bullet;
            wrap(dispBullet, txX, midY + 10, txW, 26, 3);
            ctx.restore();
          }

          // slide counter dots
          ctx.globalAlpha = 1;
          valid.forEach((_, di) => {
            ctx.beginPath(); ctx.arc(txX + di * 18, H - 50, di === imgIdx ? 6 : 4, 0, Math.PI * 2);
            ctx.fillStyle = di === imgIdx ? T.accent : (cfg.style === 'dark' ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.2)');
            ctx.fill();
          });

          ctx.restore(); // end transition save

          // â”€â”€ BRAND BAR (bottom strip) â”€â”€
          if (cfg.showBrand) {
            const barH = 44;
            const bg2 = ctx.createLinearGradient(0, H - barH, W, H);
            bg2.addColorStop(0, T.accent); bg2.addColorStop(1, T.bg[1]);
            ctx.fillStyle = bg2; ctx.fillRect(0, H - barH, W, barH);
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.font = 'bold 14px Georgia, serif'; ctx.textAlign = 'center';
            ctx.fillText('âœ¦  ' + cfg.brandText + '  âœ¦', W / 2, H - 14);
            ctx.textAlign = 'left';
          }
        };

        // â”€â”€ RECORD â”€â”€
        const stream = canvas.captureStream(FPS);
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8', videoBitsPerSecond: 4000000 });
        const chunks = [];
        recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

        recorder.start();

        const slides = valid.length;
        const totalFrames = slides * SLIDE_FRAMES + (slides - 1) * TRANS_FRAMES;

        await new Promise(resolve => {
          let frame = 0;
          const tick = () => {
            if (frame >= totalFrames) { recorder.stop(); resolve(); return; }

            // figure out which slide + phase
            const frameInCycle = SLIDE_FRAMES + TRANS_FRAMES;
            let remaining = frame;
            let slideIdx = 0;
            while (slideIdx < slides - 1 && remaining >= SLIDE_FRAMES) {
              remaining -= SLIDE_FRAMES;
              if (remaining < TRANS_FRAMES) break;
              remaining -= TRANS_FRAMES;
              slideIdx++;
            }
            const localF = frame - slideIdx * (SLIDE_FRAMES + TRANS_FRAMES);

            if (localF < SLIDE_FRAMES) {
              const t = localF / SLIDE_FRAMES;
              const isFirst = localF < TRANS_FRAMES && slideIdx > 0;
              if (isFirst) drawFrame(slideIdx, t, localF / TRANS_FRAMES, 'in');
              else drawFrame(slideIdx, t, null, null);
            } else {
              const tf = localF - SLIDE_FRAMES;
              drawFrame(slideIdx, 1, tf / TRANS_FRAMES, 'out');
            }

            frame++;
            requestAnimationFrame(tick);
          };
          recorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/webm' });
            setVideoUrl(URL.createObjectURL(blob));
            setVideoLoading(false);
            resolve();
          };
          tick();
        });
      };

      const generateAllListings = async () => {
        if (!uploadedImages.length) { setError('è¯·å…ˆä¸Šä¼ è‡³å°‘ä¸€å¼ æ•ˆæœå›¾'); return; }
        if (!selectedCategory) { setError('è¯·é€‰æ‹©å“ç±»'); return; }
        setError('');
        setLoading(true);
        setGeneratedListings([]);
        const results = [];
        for (let i = 0; i < uploadedImages.length; i++) {
          setLoadingIdx(i);
          try {
            const listing = await generateOneListing(uploadedImages[i], selectedCategory, i);
            results.push(listing);
            setGeneratedListings([...results]);
          } catch(e) {
            results.push({ error: e.message, imageName: uploadedImages[i].name, imageUrl: uploadedImages[i].url });
            setGeneratedListings([...results]);
          }
        }
        setLoadingIdx(-1);
        setLoading(false);
        // Update listing stats
        try {
          const stats = S.g('weeklyStats') || {};
          stats.listings = (stats.listings || 0) + results.filter(r => !r.error).length;
          S.s('weeklyStats', stats);
        } catch(e) {}
      };

      const downloadCSV = () => {
        if (!generatedListings.length) return;
        const headers = ['Image Name', 'Detected Pattern', 'Title', 'Bullet 1', 'Bullet 2', 'Bullet 3', 'Bullet 4', 'Bullet 5', 'Description', 'Search Terms'];
        const rows = generatedListings.map(l => {
          if (l.error) return [l.imageName, 'ERROR: ' + l.error, '', '', '', '', '', '', '', ''];
          const esc = (s) => '"' + (s || '').replace(/"/g, '""') + '"';
          return [
            esc(l.imageName),
            esc(l.detectedPattern || ''),
            esc(l.title),
            esc(l.bullets?.[0] || ''),
            esc(l.bullets?.[1] || ''),
            esc(l.bullets?.[2] || ''),
            esc(l.bullets?.[3] || ''),
            esc(l.bullets?.[4] || ''),
            esc(l.description),
            esc(l.searchTerms)
          ];
        });
        const csv = [headers.map(h => '"' + h + '"').join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Listings_${selectedCategory.split('(')[0].trim()}_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const copyText = (text, label) => {
        navigator.clipboard.writeText(text).then(() => alert('âœ… å·²å¤åˆ¶' + label));
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="card">
            <h2 className="text-2xl font-bold mb-1">ğŸ“ Listing ç”Ÿæˆå™¨</h2>
            <p className="text-gray-500 text-sm">æ‰¹é‡ä¸Šä¼ æ•ˆæœå›¾ â†’ é€‰æ‹©å“ç±»å’Œäº§å“ä¿¡æ¯ â†’ AIè‡ªåŠ¨ç”Ÿæˆå®Œæ•´Listingæ–‡æ¡ˆ</p>
          </div>

          {/* Step 1: Upload */}
          <div className="card">
            <h3 className="font-bold text-lg mb-3">1ï¸âƒ£ ä¸Šä¼ æ•ˆæœå›¾ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰</h3>
            <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-purple-300 rounded-xl cursor-pointer bg-purple-50 hover:bg-purple-100 transition-colors">
              <div className="text-center">
                <div className="text-3xl mb-1">ğŸ“</div>
                <div className="text-sm text-purple-600 font-medium">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡</div>
                <div className="text-xs text-gray-400 mt-1">æ”¯æŒ JPG / PNG / WEBPï¼Œå¯å¤šé€‰</div>
              </div>
              <input type="file" accept="image/*" multiple onChange={handleImagesUpload} className="hidden" />
            </label>

            {uploadedImages.length > 0 && (
              <div className="mt-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-gray-600">å·²ä¸Šä¼  {uploadedImages.length} å¼ å›¾ç‰‡</span>
                  <button onClick={() => { setUploadedImages([]); setGeneratedListings([]); }} className="text-xs text-red-500 hover:text-red-700">æ¸…ç©ºå…¨éƒ¨</button>
                </div>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                  {uploadedImages.map((img, idx) => (
                    <div key={idx} className="relative group">
                      <img src={img.url} alt={img.name} className="w-full aspect-square object-cover rounded-lg border-2 border-gray-200" />
                      {generatedListings[idx] && !generatedListings[idx].error && (
                        <div className="absolute top-1 left-1 bg-green-500 text-white text-xs px-1 rounded">âœ“</div>
                      )}
                      {loadingIdx === idx && (
                        <div className="absolute inset-0 bg-black bg-opacity-40 rounded-lg flex items-center justify-center">
                          <div className="loading-spinner" style={{width:24,height:24,borderWidth:2}}></div>
                        </div>
                      )}
                      <button
                        onClick={() => removeImage(idx)}
                        className="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                      >Ã—</button>
                      <div className="text-xs text-gray-500 mt-1 truncate" title={img.name}>{img.name}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Step 2: Product Info */}
          <div className="card">
            <h3 className="font-bold text-lg mb-3">2ï¸âƒ£ äº§å“ä¿¡æ¯è®¾ç½®</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å“ç±» *</label>
                <select value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                  <option value="">-- è¯·é€‰æ‹©å“ç±» --</option>
                  {CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„æ®µ</label>
                <select value={ageGroup} onChange={e => setAgeGroup(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                  {AGE_GROUPS.map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ«</label>
                <select value={gender} onChange={e => setGender(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                  {GENDERS.map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">æè´¨</label>
                <select value={material} onChange={e => setMaterial(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                  {MATERIALS.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
              </div>
            </div>

            {selectedCategory && (
              <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                <div className="text-xs font-medium text-blue-700 mb-1">ğŸ“š å½“å‰å“ç±»å…³é”®è¯é¢„è§ˆ</div>
                <div className="text-xs text-blue-600">
                  <span className="font-medium">Layer 1ï¼ˆæ ¸å¿ƒï¼‰ï¼š</span>{LISTING_KEYWORD_DB[selectedCategory]?.layer1.slice(0,4).join(' / ')}...
                </div>
              </div>
            )}
          </div>

          {/* Step 3: Generate */}
          <div className="card">
            <h3 className="font-bold text-lg mb-3">3ï¸âƒ£ AIæ‰¹é‡ç”ŸæˆListing</h3>
            {error && <div className="mb-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">âš ï¸ {error}</div>}
            <button
              onClick={generateAllListings}
              disabled={loading || !uploadedImages.length || !selectedCategory}
              className="btn-primary w-full disabled:opacity-50 disabled:cursor-not-allowed text-lg py-3"
            >
              {loading ? `ğŸ”„ ç”Ÿæˆä¸­... (${loadingIdx + 1}/${uploadedImages.length})` : `ğŸ¤– AIç”Ÿæˆå…¨éƒ¨Listingï¼ˆ${uploadedImages.length}å¼ ï¼‰`}
            </button>
            {loading && (
              <div className="mt-3">
                <div className="bg-gray-200 rounded-full h-2">
                  <div className="bg-purple-500 h-2 rounded-full transition-all" style={{width: `${uploadedImages.length ? ((loadingIdx) / uploadedImages.length * 100) : 0}%`}}></div>
                </div>
                <div className="text-xs text-gray-500 mt-1 text-center">æ­£åœ¨å¤„ç†ç¬¬ {loadingIdx + 1} / {uploadedImages.length} å¼ å›¾ç‰‡...</div>
              </div>
            )}
          </div>

          {/* Results */}
          {generatedListings.length > 0 && (
            <div className="card">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-bold text-lg">ğŸ“‹ ç”Ÿæˆç»“æœï¼ˆ{generatedListings.filter(l => !l.error).length} ä¸ªæˆåŠŸï¼‰</h3>
                <button
                  onClick={downloadCSV}
                  className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 flex items-center gap-2"
                >
                  ğŸ“¥ ä¸‹è½½CSV
                </button>
              </div>

              <div className="space-y-6">
                {generatedListings.map((listing, idx) => (
                  <div key={idx} className={`border-2 rounded-xl overflow-hidden ${listing.error ? 'border-red-200' : 'border-purple-200'}`}>
                    {/* Image header */}
                    <div className="flex items-center gap-3 p-4 bg-gray-50 border-b">
                      <img src={listing.imageUrl} alt="" className="w-16 h-16 object-cover rounded-lg border" />
                      <div>
                        <div className="font-medium text-sm">{listing.imageName}</div>
                        {listing.detectedPattern && <div className="text-xs text-purple-600 mt-0.5">ğŸ¨ è¯†åˆ«å›¾æ¡ˆï¼š{listing.detectedPattern}</div>}
                        {listing.error && <div className="text-xs text-red-600 mt-0.5">âŒ {listing.error}</div>}
                      </div>
                    </div>

                    {!listing.error && (
                      <div className="p-4 space-y-4">
                        {/* Title */}
                        <div className="bg-white border rounded-lg p-3">
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-xs font-bold text-gray-500 uppercase">æ ‡é¢˜ Title</span>
                            <div className="flex items-center gap-2">
                              <span className={`text-xs ${listing.title?.length > 150 ? 'text-red-500' : 'text-gray-400'}`}>{listing.title?.length || 0}/150</span>
                              <button onClick={() => copyText(listing.title, 'æ ‡é¢˜')} className="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">å¤åˆ¶</button>
                            </div>
                          </div>
                          <p className="text-sm text-gray-800">{listing.title}</p>
                        </div>

                        {/* Bullets */}
                        <div className="bg-white border rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-bold text-gray-500 uppercase">äº”ç‚¹æè¿° Bullet Points</span>
                            <button onClick={() => copyText(listing.bullets?.join('\n'), 'äº”ç‚¹æè¿°')} className="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">å¤åˆ¶å…¨éƒ¨</button>
                          </div>
                          <ul className="space-y-2">
                            {listing.bullets?.map((b, bi) => (
                              <li key={bi} className="text-sm text-gray-800 flex items-start gap-2">
                                <span className="text-gray-400 text-xs mt-0.5 flex-shrink-0">â€¢</span>
                                <span>{b}</span>
                              </li>
                            ))}
                          </ul>
                        </div>

                        {/* Description */}
                        <div className="bg-white border rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-bold text-gray-500 uppercase">äº§å“æè¿° Description (HTML)</span>
                            <button onClick={() => copyText(listing.description, 'äº§å“æè¿°')} className="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">å¤åˆ¶HTML</button>
                          </div>
                          <div className="text-sm text-gray-800 bg-gray-50 rounded p-2" dangerouslySetInnerHTML={{__html: listing.description}}></div>
                          <details className="mt-2">
                            <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-600">æŸ¥çœ‹åŸå§‹HTMLä»£ç </summary>
                            <pre className="text-xs bg-gray-900 text-green-300 rounded p-2 mt-1 overflow-x-auto whitespace-pre-wrap">{listing.description}</pre>
                          </details>
                        </div>

                        {/* Search Terms */}
                        <div className="bg-white border rounded-lg p-3">
                          <div className="flex items-center justify-between mb-1">
                            <span className="text-xs font-bold text-gray-500 uppercase">Search Terms</span>
                            <div className="flex items-center gap-2">
                              <span className={`text-xs ${listing.searchTerms?.length > 250 ? 'text-red-500' : 'text-gray-400'}`}>{listing.searchTerms?.length || 0}/250</span>
                              <button onClick={() => copyText(listing.searchTerms, 'Search Terms')} className="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200">å¤åˆ¶</button>
                            </div>
                          </div>
                          <p className="text-xs text-gray-700 leading-relaxed">{listing.searchTerms}</p>
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* Download CSV */}
              <div className="mt-4 pt-4 border-t flex justify-end">
                <button onClick={downloadCSV} className="px-6 py-3 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 flex items-center gap-2">
                  ğŸ“¥ ä¸‹è½½CSVï¼ˆ{generatedListings.filter(l=>!l.error).length}ä¸ªListingï¼‰
                </button>
              </div>
            </div>
          )}

          {/* Step 4: A+ Image Designer */}
          <div className="card" style={{border: '2px solid #fed7aa'}}>
            <div className="flex items-center justify-between mb-3">
              <div>
                <h3 className="font-bold text-lg">4ï¸âƒ£ A+ åœºæ™¯å›¾è®¾è®¡</h3>
                <p className="text-xs text-gray-400 mt-0.5">è‡ªå®šä¹‰é£æ ¼ã€å¸ƒå±€ã€æ–‡æ¡ˆï¼Œç”Ÿæˆå¯ç›´æ¥ä¸Šä¼  Seller Central çš„ 970Ã—600px å›¾ç‰‡</p>
              </div>
              <span className="text-xs px-2 py-1 bg-orange-100 text-orange-600 rounded-full font-medium">970 Ã— 600 px</span>
            </div>

            {!generatedListings.filter(l=>!l.error).length && (
              <div className="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg text-orange-700 text-sm flex items-center gap-2">
                <span>â³</span><span>è¯·å…ˆå®Œæˆç¬¬3æ­¥ç”ŸæˆListingï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–äº§å“å›¾å’Œæ–‡æ¡ˆ</span>
              </div>
            )}

            {/* â”€â”€ CONFIG PANEL â”€â”€ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">

              {/* é£æ ¼ */}
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ¨ æ•´ä½“é£æ ¼</label>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {k:'warm',    label:'â˜€ï¸ æš–è‰²ç”Ÿæ´»æ„Ÿ', sub:'ç±³ç™½+æš–æ©™ï¼Œå®¶å±…æ¸©é¦¨'},
                    {k:'clean',   label:'ğŸ¤ ç®€æ´ç™½åº•',   sub:'è“ç™½æ¸…çˆ½ï¼Œäºšé©¬é€Šå®˜æ–¹é£'},
                    {k:'dark',    label:'ğŸŒ™ æ·±è‰²é«˜çº§æ„Ÿ',  sub:'æ·±è“èƒŒæ™¯ï¼Œæ—¶å°šæ‚å¿—é£'},
                    {k:'playful', label:'ğŸ€ å¯çˆ±å„¿ç«¥é£',  sub:'ç²‰ç´«æ´»æ³¼ï¼Œç«¥è¶£åè¶³'},
                  ].map(s => (
                    <button key={s.k} onClick={()=>setAplusCfg(c=>({...c, style:s.k, accentColor: s.k==='clean'?'#3b5bdb':s.k==='dark'?'#4a9eff':s.k==='playful'?'#c026d3':'#D4724A'}))}
                      className={`p-2.5 rounded-xl border-2 text-left transition-all ${aplusCfg.style===s.k ? 'border-orange-400 bg-orange-50' : 'border-gray-200 hover:border-orange-200'}`}>
                      <div className="text-sm font-medium">{s.label}</div>
                      <div className="text-xs text-gray-400 mt-0.5">{s.sub}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* å¸ƒå±€ */}
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ“ å›¾ç‰‡å¸ƒå±€</label>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    {k:'auto',      label:'âœ¨ æ™ºèƒ½è‡ªåŠ¨',   sub:'æ ¹æ®å›¾æ•°é‡è‡ªåŠ¨é€‰æœ€ä¼˜å¸ƒå±€'},
                    {k:'magazine',  label:'ğŸ—ï¸ æ‚å¿—ç‰ˆå¼',   sub:'å·¦å¤§å›¾+å³ä¸‰æ ¼ï¼Œä¸»æ¬¡åˆ†æ˜'},
                    {k:'editorial', label:'ğŸ“° ç¼–è¾‘ç‰ˆå¼',   sub:'ä¸Šå®½å›¾+ä¸‹ä¸¤æ ¼ï¼Œå™äº‹æ„Ÿå¼º'},
                    {k:'grid2',     label:'â¬œâ¬œ ä¸¤æ ¼å¹¶æ’',  sub:'å·¦å³å„åŠï¼Œ2å¼ å›¾æœ€ä½³'},
                    {k:'grid3',     label:'â¬œâ¬œâ¬œ ä¸‰æ ¼å‡åˆ†', sub:'ä¸‰ç­‰åˆ†ï¼Œ3å¼ å›¾æœ€ä½³'},
                    {k:'grid4',     label:'ç”° å››æ ¼ç½‘æ ¼',   sub:'2Ã—2å®«æ ¼ï¼Œ4å¼ å›¾æœ€ä½³'},
                    {k:'banner',    label:'â–¬â–¬â–¬ æ¨ªå¹…æ¡åˆ—',  sub:'å…¨éƒ¨æ¨ªå‘å¹³é“º'},
                  ].map(s => (
                    <button key={s.k} onClick={()=>setAplusCfg(c=>({...c, layout:s.k}))}
                      className={`p-2.5 rounded-xl border-2 text-left transition-all ${aplusCfg.layout===s.k ? 'border-orange-400 bg-orange-50' : 'border-gray-200 hover:border-orange-200'}`}>
                      <div className="text-sm font-medium">{s.label}</div>
                      <div className="text-xs text-gray-400 mt-0.5">{s.sub}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* æ–‡æ¡ˆå†…å®¹ */}
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">âœï¸ å¡ç‰‡æ–‡æ¡ˆå†…å®¹</label>
                <div className="space-y-2">
                  {[
                    {k:'bullet1', label:'ç¬¬1æ¡å–ç‚¹ï¼ˆæ¨èï¼‰'},
                    {k:'bullet2', label:'ç¬¬2æ¡å–ç‚¹'},
                    {k:'title',   label:'ä»…æ˜¾ç¤ºæ ‡é¢˜'},
                    {k:'custom',  label:'è‡ªå®šä¹‰æ–‡æ¡ˆ'},
                  ].map(s => (
                    <label key={s.k} className={`flex items-center gap-3 p-2.5 rounded-xl border-2 cursor-pointer transition-all ${aplusCfg.textSlot===s.k ? 'border-orange-400 bg-orange-50' : 'border-gray-200 hover:border-orange-200'}`}>
                      <input type="radio" name="textSlot" value={s.k} checked={aplusCfg.textSlot===s.k} onChange={()=>setAplusCfg(c=>({...c,textSlot:s.k}))} className="accent-orange-500"/>
                      <span className="text-sm">{s.label}</span>
                    </label>
                  ))}
                  {aplusCfg.textSlot==='custom' && (
                    <textarea value={aplusCfg.customText} onChange={e=>setAplusCfg(c=>({...c,customText:e.target.value}))}
                      placeholder="è¾“å…¥è‡ªå®šä¹‰å–ç‚¹æ–‡æ¡ˆï¼ˆè‹±æ–‡ï¼Œä¼šæ˜¾ç¤ºåœ¨æ¯å¼ äº§å“å›¾ä¸‹æ–¹ï¼‰"
                      rows={2} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"/>
                  )}
                </div>
              </div>

              {/* ç»†èŠ‚è®¾ç½® */}
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">âš™ï¸ ç»†èŠ‚è®¾ç½®</label>
                <div className="space-y-3">
                  {/* ä¸»é¢˜è‰² */}
                  <div className="flex items-center justify-between p-2.5 border-2 border-gray-200 rounded-xl">
                    <div>
                      <div className="text-sm font-medium">ä¸»é¢˜è‰²</div>
                      <div className="text-xs text-gray-400">æ ‡é¢˜æ¡ & å“ç‰Œæ é¢œè‰²</div>
                    </div>
                    <div className="flex items-center gap-2">
                      {['#D4724A','#3b5bdb','#16a34a','#c026d3','#dc2626','#0891b2','#ea580c','#1a1a2e'].map(c=>(
                        <button key={c} onClick={()=>setAplusCfg(cfg=>({...cfg,accentColor:c}))}
                          style={{background:c, width:22, height:22, borderRadius:'50%', border: aplusCfg.accentColor===c ? '3px solid #374151' : '2px solid transparent'}}/>
                      ))}
                      <input type="color" value={aplusCfg.accentColor} onChange={e=>setAplusCfg(c=>({...c,accentColor:e.target.value}))} className="w-7 h-7 rounded cursor-pointer border-0" title="è‡ªå®šä¹‰é¢œè‰²"/>
                    </div>
                  </div>
                  {/* å›¾ç‰‡å æ¯” */}
                  <div className="p-2.5 border-2 border-gray-200 rounded-xl">
                    <div className="flex justify-between mb-1">
                      <span className="text-sm font-medium">å›¾ç‰‡å å¡ç‰‡é«˜åº¦</span>
                      <span className="text-sm text-orange-500 font-bold">{Math.round(aplusCfg.imgRatio*100)}%</span>
                    </div>
                    <input type="range" min="40" max="85" value={Math.round(aplusCfg.imgRatio*100)} onChange={e=>setAplusCfg(c=>({...c,imgRatio:parseInt(e.target.value)/100}))}
                      className="w-full accent-orange-500"/>
                    <div className="flex justify-between text-xs text-gray-400 mt-0.5"><span>40% å¤šæ–‡æ¡ˆ</span><span>85% å…¨å›¾</span></div>
                  </div>
                  {/* åœ†è§’ */}
                  <div className="p-2.5 border-2 border-gray-200 rounded-xl">
                    <div className="flex justify-between mb-1">
                      <span className="text-sm font-medium">å¡ç‰‡åœ†è§’</span>
                      <span className="text-sm text-orange-500 font-bold">{aplusCfg.radius}px</span>
                    </div>
                    <input type="range" min="0" max="32" value={aplusCfg.radius} onChange={e=>setAplusCfg(c=>({...c,radius:parseInt(e.target.value)}))}
                      className="w-full accent-orange-500"/>
                    <div className="flex justify-between text-xs text-gray-400 mt-0.5"><span>ç›´è§’</span><span>å¤§åœ†è§’</span></div>
                  </div>
                  {/* å“ç‰Œæ¡ + é˜´å½± */}
                  <div className="flex gap-2">
                    <label className={`flex-1 flex items-center gap-2 p-2.5 border-2 rounded-xl cursor-pointer transition-all ${aplusCfg.showBrand?'border-orange-400 bg-orange-50':'border-gray-200'}`}>
                      <input type="checkbox" checked={aplusCfg.showBrand} onChange={e=>setAplusCfg(c=>({...c,showBrand:e.target.checked}))} className="accent-orange-500"/>
                      <div><div className="text-sm font-medium">åº•éƒ¨å“ç‰Œæ¡</div><div className="text-xs text-gray-400">æ˜¾ç¤ºå–ç‚¹æ ‡è¯­</div></div>
                    </label>
                    <label className={`flex-1 flex items-center gap-2 p-2.5 border-2 rounded-xl cursor-pointer transition-all ${aplusCfg.shadow?'border-orange-400 bg-orange-50':'border-gray-200'}`}>
                      <input type="checkbox" checked={aplusCfg.shadow} onChange={e=>setAplusCfg(c=>({...c,shadow:e.target.checked}))} className="accent-orange-500"/>
                      <div><div className="text-sm font-medium">å¡ç‰‡é˜´å½±</div><div className="text-xs text-gray-400">ç«‹ä½“æ„Ÿæ›´å¼º</div></div>
                    </label>
                  </div>
                  {/* å“ç‰Œæ¡æ–‡å­— */}
                  {aplusCfg.showBrand && (
                    <input value={aplusCfg.brandText} onChange={e=>setAplusCfg(c=>({...c,brandText:e.target.value}))}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-300"
                      placeholder="åº•éƒ¨å“ç‰Œæ¡æ–‡å­—"/>
                  )}
                </div>
              </div>
            </div>

            {/* â”€â”€ GENERATE BUTTON â”€â”€ */}
            <button
              onClick={generateAplus}
              disabled={aplusLoading || !generatedListings.filter(l=>!l.error).length}
              style={{background: (!aplusLoading && generatedListings.filter(l=>!l.error).length) ? 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)' : undefined}}
              className="w-full py-3.5 text-white rounded-xl font-bold text-lg disabled:opacity-40 disabled:cursor-not-allowed disabled:bg-gray-300 transition-all hover:shadow-lg flex items-center justify-center gap-2"
            >
              {aplusLoading
                ? <><div className="loading-spinner" style={{width:20,height:20,borderWidth:2,display:'inline-block'}}></div> ç”Ÿæˆä¸­...</>
                : <>ğŸ–¼ï¸ ç”ŸæˆA+åœºæ™¯å›¾ï¼ˆ{generatedListings.filter(l=>!l.error).length}å¼ äº§å“ï¼‰</>
              }
            </button>

            {/* â”€â”€ PREVIEW â”€â”€ */}
            {aplusUrl && (
              <div className="mt-5">
                <div className="flex items-center justify-between mb-3">
                  <span className="font-semibold text-orange-700">ğŸ‰ é¢„è§ˆæ•ˆæœ</span>
                  <div className="flex gap-2">
                    <button onClick={generateAplus} disabled={aplusLoading} className="px-4 py-2 border-2 border-orange-400 text-orange-600 rounded-lg text-sm font-medium hover:bg-orange-50 disabled:opacity-50">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                    <a href={aplusUrl} download={"APlus_"+selectedCategory.split('(')[0].trim()+"_"+new Date().toISOString().slice(0,10)+".png"}
                      className="px-5 py-2 bg-orange-500 text-white rounded-lg text-sm font-bold hover:bg-orange-600">â¬‡ï¸ ä¸‹è½½ PNG</a>
                  </div>
                </div>
                <div className="rounded-xl overflow-hidden border-2 border-orange-200 shadow-xl">
                  <img src={aplusUrl} alt="A+" className="w-full"/>
                </div>
                <p className="text-xs text-gray-400 mt-2 text-center">970Ã—600px Â· å¯ç›´æ¥ä¸Šä¼  Amazon Seller Central â†’ A+å†…å®¹æ¨¡å—</p>
              </div>
            )}
          </div>

          {/* Step 4b: ç³»åˆ—å°é¢å›¾ */}
          <div className="card" style={{border: '2px solid #fde68a'}}>
            <div className="flex items-center justify-between mb-3">
              <div>
                <h3 className="font-bold text-lg">ğŸ“¸ ç³»åˆ—å°é¢å›¾</h3>
                <p className="text-xs text-gray-400 mt-0.5">å°†æ‰€æœ‰æ¬¾å¼é›†ä¸­å±•ç¤ºï¼Œæ ‡æ³¨äº§å“åç§°å’Œæ ¸å¿ƒå–ç‚¹ï¼Œé€‚åˆç”¨ä½œä¸»å›¾æˆ–A+é¦–å›¾</p>
              </div>
              <span className="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">1200 Ã— 800 px</span>
            </div>

            {!generatedListings.filter(l=>!l.error).length && (
              <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm flex items-center gap-2 mb-3">
                <span>â³</span><span>è¯·å…ˆå®Œæˆç¬¬3æ­¥ç”ŸæˆListing</span>
              </div>
            )}

            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-sm">
              {[
                {k:'warm',    label:'â˜€ï¸ æš–è‰²'},
                {k:'clean',   label:'ğŸ¤ ç®€æ´'},
                {k:'dark',    label:'ğŸŒ™ æ·±è‰²'},
                {k:'playful', label:'ğŸ€ æ´»æ³¼'},
              ].map(s => (
                <button key={s.k} onClick={()=>setAplusCfg(c=>({...c, style:s.k, accentColor: s.k==='clean'?'#3b5bdb':s.k==='dark'?'#4a9eff':s.k==='playful'?'#c026d3':'#D4724A'}))}
                  className={`py-2 rounded-xl border-2 font-medium transition-all ${aplusCfg.style===s.k ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 hover:border-yellow-300'}`}>
                  {s.label}
                </button>
              ))}
            </div>

            <button
              onClick={generateCover}
              disabled={coverLoading || !generatedListings.filter(l=>!l.error).length}
              style={{background: (!coverLoading && generatedListings.filter(l=>!l.error).length) ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : undefined}}
              className="w-full py-3 text-white rounded-xl font-bold text-lg disabled:opacity-40 disabled:cursor-not-allowed disabled:bg-gray-300 transition-all hover:shadow-lg flex items-center justify-center gap-2 mb-4"
            >
              {coverLoading
                ? <><div className="loading-spinner" style={{width:20,height:20,borderWidth:2,display:'inline-block'}}></div> ç”Ÿæˆä¸­...</>
                : <>ğŸ“¸ ç”Ÿæˆç³»åˆ—å°é¢å›¾ï¼ˆ{generatedListings.filter(l=>!l.error).length}ä¸ªæ¬¾å¼ï¼‰</>
              }
            </button>

            {coverUrl && (
              <div>
                <div className="flex items-center justify-between mb-3">
                  <span className="font-semibold text-yellow-700">ğŸ‰ å°é¢å›¾ç”ŸæˆæˆåŠŸ</span>
                  <div className="flex gap-2">
                    <button onClick={generateCover} disabled={coverLoading} className="px-4 py-2 border-2 border-yellow-400 text-yellow-700 rounded-lg text-sm font-medium hover:bg-yellow-50 disabled:opacity-50">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                    <a href={coverUrl} download={"Cover_"+selectedCategory.split('(')[0].trim()+"_"+new Date().toISOString().slice(0,10)+".png"}
                      className="px-5 py-2 bg-yellow-500 text-white rounded-lg text-sm font-bold hover:bg-yellow-600">â¬‡ï¸ ä¸‹è½½ PNG</a>
                  </div>
                </div>
                <div className="rounded-xl overflow-hidden border-2 border-yellow-200 shadow-xl">
                  <img src={coverUrl} alt="Cover" className="w-full"/>
                </div>
                <p className="text-xs text-gray-400 mt-2 text-center">1200Ã—800px Â· é€‚åˆç”¨ä½œä¸»å›¾ã€A+é¦–å›¾ã€ç¤¾åª’å°é¢</p>
              </div>
            )}
          </div>

          {/* Step 5: Google Flow è§†é¢‘ Prompt ç”Ÿæˆå™¨ */}
          <div className="card" style={{border: '2px solid #c7d2fe'}}>
            <div className="flex items-center justify-between mb-3">
              <div>
                <h3 className="font-bold text-lg">5ï¸âƒ£ Google Flow è§†é¢‘ Prompt</h3>
                <p className="text-xs text-gray-400 mt-0.5">è‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçš„ Veo 3.1 Promptï¼Œå¤åˆ¶ååœ¨ Google Flow ä¸­ä¸Šä¼ äº§å“å›¾ä¸€é”®ç”ŸæˆçœŸå®åœºæ™¯è§†é¢‘</p>
              </div>
              <span className="text-xs px-2 py-1 bg-indigo-100 text-indigo-600 rounded-full font-medium">Google Flow Â· Veo 3.1</span>
            </div>

            {/* How to use */}
            <div className="mb-4 p-4 bg-indigo-50 border border-indigo-200 rounded-xl">
              <div className="font-semibold text-indigo-800 mb-2 text-sm">ğŸ“‹ ä½¿ç”¨æ–¹å¼ï¼ˆ3æ­¥å®Œæˆï¼‰</div>
              <div className="space-y-1.5 text-xs text-indigo-700">
                <div className="flex items-start gap-2"><span className="bg-indigo-200 text-indigo-800 font-bold rounded px-1.5 py-0.5 flex-shrink-0">1</span><span>åœ¨ä¸‹æ–¹é€‰æ‹©è§†é¢‘é£æ ¼å’Œåœºæ™¯ï¼Œç‚¹å‡»ã€Œç”Ÿæˆ Promptã€</span></div>
                <div className="flex items-start gap-2"><span className="bg-indigo-200 text-indigo-800 font-bold rounded px-1.5 py-0.5 flex-shrink-0">2</span><span>æ‰“å¼€ <a href="https://flow.google.com" target="_blank" className="underline font-medium">flow.google.com</a> â†’ é€‰ã€Œç´ æç”Ÿæˆè§†é¢‘ã€â†’ ä¸Šä¼ äº§å“å›¾</span></div>
                <div className="flex items-start gap-2"><span className="bg-indigo-200 text-indigo-800 font-bold rounded px-1.5 py-0.5 flex-shrink-0">3</span><span>å°† Prompt ç²˜è´´è¿›æ–‡æœ¬æ¡† â†’ é€‰ Veo 3.1 Fast â†’ ç”Ÿæˆ</span></div>
              </div>
            </div>

            {!generatedListings.filter(l=>!l.error).length && (
              <div className="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-700 text-sm flex items-center gap-2">
                <span>â³</span><span>è¯·å…ˆå®Œæˆç¬¬3æ­¥ç”ŸæˆListingï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–äº§å“ä¿¡æ¯å¡«å…¥ Prompt</span>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

              {/* åœºæ™¯é£æ ¼ */}
              <div>
                <label className="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ¬ è§†é¢‘åœºæ™¯é£æ ¼</label>
                <div className="space-y-2">
                  {[
                    {k:'lifestyle',  label:'ğŸŒ¿ ç”Ÿæ´»åœºæ™¯', desc:'å°å¥³å­©åœ¨èŠ±å›­/è‰åœ°å¥”è·‘ï¼Œé˜³å…‰æ˜åªš'},
                    {k:'indoor',     label:'ğŸ  å®¤å†…æ¸©é¦¨', desc:'å­©å­åœ¨å®¶ä¸­ç©è€ï¼Œæš–è‰²è°ƒè‡ªç„¶å…‰'},
                    {k:'party',      label:'ğŸ‰ æ´¾å¯¹åœºæ™¯', desc:'ç”Ÿæ—¥æ´¾å¯¹ï¼Œæ°”çƒå½©å¸¦èƒŒæ™¯'},
                    {k:'school',     label:'ğŸ’ æ ¡å›­åœºæ™¯', desc:'ä¸Šå­¦è·¯ä¸Š/è¯¾é—´å¬‰æˆï¼Œæ´»æ³¼è‡ªç„¶'},
                  ].map(s => (
                    <label key={s.k} className={`flex items-center gap-3 p-2.5 rounded-xl border-2 cursor-pointer transition-all ${videoCfg.transition===s.k ? 'border-indigo-400 bg-indigo-50' : 'border-gray-200 hover:border-indigo-200'}`}>
                      <input type="radio" name="flowScene" checked={videoCfg.transition===s.k} onChange={()=>setVideoCfg(c=>({...c,transition:s.k}))} className="accent-indigo-500"/>
                      <div><div className="text-sm font-medium">{s.label}</div><div className="text-xs text-gray-400">{s.desc}</div></div>
                    </label>
                  ))}
                </div>
              </div>

              {/* é•œå¤´ + æ—¶é•¿ + é£æ ¼ */}
              <div className="space-y-3">
                <div>
                  <label className="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ“· é•œå¤´è¿åŠ¨</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      {k:'slow_pan',  label:'ğŸ¥ æ…¢é€Ÿå¹³ç§»'},
                      {k:'zoom_in',   label:'ğŸ” ç¼“æ…¢æ¨è¿›'},
                      {k:'orbit',     label:'ğŸ”„ ç¯ç»•è·Ÿæ‹'},
                      {k:'handheld',  label:'ğŸ“± æ‰‹æŒè·Ÿéš'},
                    ].map(m => (
                      <button key={m.k} onClick={()=>setVideoCfg(c=>({...c,textAnim:m.k}))}
                        className={`p-2 rounded-xl border-2 text-sm font-medium transition-all ${videoCfg.textAnim===m.k ? 'border-indigo-400 bg-indigo-50' : 'border-gray-200 hover:border-indigo-200'}`}>
                        {m.label}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 uppercase mb-2">â± è§†é¢‘æ—¶é•¿</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[{k:5,label:'5ç§’'},{k:8,label:'8ç§’ï¼ˆæ¨èï¼‰'}].map(d=>(
                      <button key={d.k} onClick={()=>setVideoCfg(c=>({...c,duration:d.k}))}
                        className={`p-2 rounded-xl border-2 text-sm font-medium transition-all ${videoCfg.duration===d.k ? 'border-indigo-400 bg-indigo-50' : 'border-gray-200 hover:border-indigo-200'}`}>
                        {d.label}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ¨ ç”»é¢é£æ ¼</label>
                  <div className="grid grid-cols-2 gap-2">
                    {[
                      {k:'warm',      label:'â˜€ï¸ æš–è‰²è‡ªç„¶'},
                      {k:'bright',    label:'âœ¨ æ˜äº®æ¸…æ–°'},
                      {k:'cinematic', label:'ğŸ¬ ç”µå½±è´¨æ„Ÿ'},
                      {k:'vibrant',   label:'ğŸŒˆ é²œè‰³æ´»åŠ›'},
                    ].map(vs => (
                      <button key={vs.k} onClick={()=>setVideoCfg(c=>({...c,style:vs.k}))}
                        className={`p-2 rounded-xl border-2 text-sm font-medium transition-all ${videoCfg.style===vs.k ? 'border-indigo-400 bg-indigo-50' : 'border-gray-200 hover:border-indigo-200'}`}>
                        {vs.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            {/* Flow Prompt Generator */}
            {(() => {
              const valid = generatedListings.filter(l=>!l.error);
              const sceneMap = {
                lifestyle: 'a cheerful girl playing in a sunny garden with blooming flowers',
                indoor:    'a happy child playing indoors in a cozy living room with warm natural light',
                party:     'an excited child at a colorful birthday party with balloons and streamers',
                school:    'a smiling girl walking to school or playing during recess on a bright morning',
              };
              const cameraMap = {
                slow_pan:  'slow horizontal pan, steady tripod shot',
                zoom_in:   'slow gentle zoom in, rack focus',
                orbit:     'smooth orbit around subject, 180 degree arc',
                handheld:  'natural handheld follow shot, slight motion',
              };
              const styleMap = {
                warm:      'warm golden hour lighting, soft bokeh background',
                bright:    'bright natural daylight, clean crisp colors, high key lighting',
                cinematic: 'cinematic shallow depth of field, color graded, anamorphic',
                vibrant:   'vibrant saturated colors, dynamic lighting, energetic feel',
              };
              const listing = valid[0];
              const productName = listing ? (listing.title||'').split('â€“')[0].trim().slice(0,50) : 'kids clothing';
              const bullet1 = listing ? ((listing.bullets&&listing.bullets[0]||'').replace(/[\s\S]{0,0}/,'').replace(/^[\sâ€¢:]+/,'').trim().slice(0,80)) : '';
              const scene = sceneMap[videoCfg.transition] || sceneMap.lifestyle;
              const camera = cameraMap[videoCfg.textAnim] || cameraMap.slow_pan;
              const style2 = styleMap[videoCfg.style] || styleMap.warm;
              const dur = videoCfg.duration || 8;
              const prompt = 'A ' + scene + ', wearing a ' + productName + '. The clothing print pattern is shown beautifully in motion. ' + camera + '. ' + style2 + '. Professional product lifestyle video, ' + dur + ' seconds, ultra HD 4K, authentic natural movement, suitable for Amazon listing.';
              const negPrompt = 'ugly, distorted clothing, wrong proportions, blurry, overexposed, watermark, text overlay, cartoon, unrealistic, adult content';
              return (
                <div className="space-y-3">
                  <div className="p-4 bg-gray-900 rounded-xl border border-indigo-400">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs font-bold text-indigo-300 uppercase">ğŸ“ è§†é¢‘ Promptï¼ˆç²˜è´´åˆ° Flowï¼‰</span>
                      <button onClick={()=>{navigator.clipboard.writeText(prompt);alert('Prompt å·²å¤åˆ¶ï¼');}}
                        className="px-3 py-1 bg-indigo-500 text-white rounded-lg text-xs font-bold hover:bg-indigo-400">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                    <p className="text-green-300 text-sm font-mono leading-relaxed whitespace-pre-wrap">{prompt}</p>
                  </div>
                  <div className="p-3 bg-gray-800 rounded-xl border border-gray-600">
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-xs font-bold text-gray-400 uppercase">ğŸš« Negative Prompt</span>
                      <button onClick={()=>{navigator.clipboard.writeText(negPrompt);alert('å·²å¤åˆ¶ï¼');}}
                        className="px-2 py-0.5 bg-gray-600 text-gray-200 rounded text-xs hover:bg-gray-500">å¤åˆ¶</button>
                    </div>
                    <p className="text-gray-400 text-xs font-mono">{negPrompt}</p>
                  </div>
                  <div className="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                    <div className="text-xs font-bold text-blue-700 mb-3">ğŸš€ Flow æ“ä½œæ­¥éª¤</div>
                    <div className="grid grid-cols-3 gap-2 text-xs text-blue-600 mb-3">
                      <div className="text-center p-2 bg-white rounded-lg border border-blue-100">
                        <div className="text-lg mb-1">ğŸ“</div>
                        <div className="font-medium">ä¸Šä¼ äº§å“å›¾</div>
                        <div className="text-gray-400 mt-0.5">ç‚¹å‡» + æ·»åŠ ç´ æ</div>
                      </div>
                      <div className="text-center p-2 bg-white rounded-lg border border-blue-100">
                        <div className="text-lg mb-1">ğŸ“‹</div>
                        <div className="font-medium">ç²˜è´´ Prompt</div>
                        <div className="text-gray-400 mt-0.5">é€‰ Veo 3.1 Fast</div>
                      </div>
                      <div className="text-center p-2 bg-white rounded-lg border border-blue-100">
                        <div className="text-lg mb-1">ğŸ¬</div>
                        <div className="font-medium">ç”Ÿæˆä¸‹è½½</div>
                        <div className="text-gray-400 mt-0.5">çº¦ 30-60 ç§’</div>
                      </div>
                    </div>
                    <a href="https://flow.google.com" target="_blank"
                      className="flex items-center justify-center gap-2 w-full py-2.5 bg-indigo-500 text-white rounded-lg text-sm font-bold hover:bg-indigo-600">
                      ğŸ”— æ‰“å¼€ Google Flow
                    </a>
                  </div>
                </div>
              );
            })()}
          </div>

        </div>
      );
    }

    // ========== Page 4: é”€å”®åé¦ˆ ==========
    function FeedbackPage() {
      const [salesData, setSalesData] = useState([]);
      const [newSale, setNewSale] = useState({
        product: '',
        theme: '',
        elements: '',
        sales: 0,
        revenue: 0,
        date: ''
      });

      const addSalesData = () => {
        if (!newSale.product || !newSale.theme) {
          alert('è¯·å¡«å†™äº§å“å’Œä¸»é¢˜');
          return;
        }

        const updated = [...salesData, { ...newSale, id: Date.now() }];
        setSalesData(updated);
        S.s('sales_data', updated);

        // æ›´æ–°å¸¸é’æƒé‡
        updateEvergreenWeights(newSale);

        setNewSale({ product: '', theme: '', elements: '', sales: 0, revenue: 0, date: '' });
        alert('é”€å”®æ•°æ®å·²ä¿å­˜ï¼');
      };

      const updateEvergreenWeights = (sale) => {
        const evergreen = S.g('evergreen') || SYSTEM_DATA.evergreen;
        const themeIndex = evergreen.findIndex(e => e.en.toLowerCase() === sale.theme.toLowerCase());
        
        if (themeIndex !== -1) {
          evergreen[themeIndex].weight += sale.sales * 0.01; // ç®€åŒ–çš„æƒé‡æ›´æ–°é€»è¾‘
          S.s('evergreen', evergreen);
        }
      };

      useEffect(() => {
        setSalesData(S.g('sales_data') || []);
      }, []);

      return (
        <div className="space-y-6">
          <div className="card">
            <h2 className="text-2xl font-bold mb-4">ğŸ“ˆ é”€å”®åé¦ˆ</h2>

            <div className="bg-blue-50 p-4 rounded-lg mb-6">
              <h3 className="font-semibold mb-3">â• å½•å…¥æ–°é”€å”®æ•°æ®</h3>
              <div className="grid md:grid-cols-2 gap-4">
                <input
                  type="text"
                  placeholder="äº§å“åç§°"
                  value={newSale.product}
                  onChange={(e) => setNewSale({ ...newSale, product: e.target.value })}
                  className="px-4 py-2 border rounded-lg"
                />
                <input
                  type="text"
                  placeholder="ä¸»é¢˜ï¼ˆå¦‚ï¼šEaster, Dinosaurï¼‰"
                  value={newSale.theme}
                  onChange={(e) => setNewSale({ ...newSale, theme: e.target.value })}
                  className="px-4 py-2 border rounded-lg"
                />
                <input
                  type="text"
                  placeholder="å…ƒç´ ï¼ˆé€—å·åˆ†éš”ï¼‰"
                  value={newSale.elements}
                  onChange={(e) => setNewSale({ ...newSale, elements: e.target.value })}
                  className="px-4 py-2 border rounded-lg"
                />
                <input
                  type="number"
                  placeholder="é”€é‡"
                  value={newSale.sales}
                  onChange={(e) => setNewSale({ ...newSale, sales: parseInt(e.target.value) || 0 })}
                  className="px-4 py-2 border rounded-lg"
                />
                <input
                  type="number"
                  placeholder="æ”¶å…¥ ($)"
                  value={newSale.revenue}
                  onChange={(e) => setNewSale({ ...newSale, revenue: parseFloat(e.target.value) || 0 })}
                  className="px-4 py-2 border rounded-lg"
                />
                <input
                  type="date"
                  value={newSale.date}
                  onChange={(e) => setNewSale({ ...newSale, date: e.target.value })}
                  className="px-4 py-2 border rounded-lg"
                />
              </div>
              <button onClick={addSalesData} className="btn-primary w-full mt-4">
                ä¿å­˜é”€å”®æ•°æ®
              </button>
            </div>

            {/* é”€å”®æ•°æ®åˆ—è¡¨ */}
            {salesData.length > 0 && (
              <div>
                <h3 className="font-semibold mb-3 text-lg">ğŸ“Š å†å²é”€å”®æ•°æ®</h3>
                <div className="space-y-3">
                  {salesData.map(sale => (
                    <div key={sale.id} className="border rounded-lg p-4 bg-gray-50">
                      <div className="grid md:grid-cols-4 gap-4">
                        <div>
                          <div className="text-xs text-gray-500">äº§å“</div>
                          <div className="font-medium">{sale.product}</div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500">ä¸»é¢˜</div>
                          <div className="font-medium">{sale.theme}</div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500">é”€é‡</div>
                          <div className="font-medium text-green-600">{sale.sales}</div>
                        </div>
                        <div>
                          <div className="text-xs text-gray-500">æ”¶å…¥</div>
                          <div className="font-medium text-purple-600">${sale.revenue}</div>
                        </div>
                      </div>
                      {sale.elements && (
                        <div className="mt-2 text-sm text-gray-600">
                          å…ƒç´ ï¼š{sale.elements}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                {/* ç®€å•çš„ç»Ÿè®¡ */}
                <div className="mt-6 grid md:grid-cols-3 gap-4">
                  <div className="bg-green-50 p-4 rounded-lg text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {salesData.reduce((sum, s) => sum + s.sales, 0)}
                    </div>
                    <div className="text-sm text-gray-600">æ€»é”€é‡</div>
                  </div>
                  <div className="bg-purple-50 p-4 rounded-lg text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      ${salesData.reduce((sum, s) => sum + s.revenue, 0).toFixed(2)}
                    </div>
                    <div className="text-sm text-gray-600">æ€»æ”¶å…¥</div>
                  </div>
                  <div className="bg-blue-50 p-4 rounded-lg text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {salesData.length}
                    </div>
                    <div className="text-sm text-gray-600">äº§å“æ•°</div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ========== æ¸²æŸ“åº”ç”¨ ==========
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
